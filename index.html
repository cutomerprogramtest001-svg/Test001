<!DOCTYPE html>
<html lang="th" x-data="{ mainTab: 'hr', open: 'employee' }">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BizApp ‚Äî Unified Modules</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>[x-cloak]{display:none!important}</style>
</head>
<body class="bg-gray-50 text-gray-800">
<div class="min-h-screen grid md:grid-cols-[18rem_1fr]">
  <aside class="bg-white border-r p-4 space-y-2">
    <div class="text-xl font-bold">üìã Main Menu</div>
    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'hr' }"
            @click="mainTab = 'hr'">üë∑ HR</button>
    <template x-if="mainTab==='hr'"><div class="pl-2 space-y-1 text-sm">
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='employee' }" @click="open='employee'">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='attendance' }" @click="open='attendance'">‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏°‡∏≤‡∏™‡∏≤‡∏¢</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='timeclock' }" @click="open='timeclock'">Clock In/Out</button>
    </div></template>

    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'sales' }"
            @click="mainTab = 'sales'">ü¶∑ Sales</button>
    <template x-if="mainTab==='sales'"><div class="pl-2 space-y-1 text-sm">
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='customer' }" @click="open='customer'">Customer</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='quotation' }" @click="open='quotation'">Quotation</button>
    </div></template>

    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'purchase' }"
            @click="mainTab = 'purchase'">üì¶ Purchasing</button>
    <template x-if="mainTab==='purchase'"><div class="pl-2 space-y-1 text-sm">
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='pr' }" @click="open='pr'">PR</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='rfq' }" @click="open='rfq'">RFQ</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='po' }" @click="open='po'">PO</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='grn' }" @click="open='grn'">GRN</button>
    </div></template>

    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'inventory' }"
            @click="mainTab = 'inventory'">üè∑ Inventory</button>
    <template x-if="mainTab==='inventory'"><div class="pl-2 space-y-1 text-sm">
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='picking' }" @click="open='picking'">Picking</button>
      <button class="w-full text-left px-3 py-1 rounded hover:bg-gray-100"
              :class="{ 'bg-gray-200': open==='dispatch' }" @click="open='dispatch'">Dispatch</button>
    </div></template>
  </aside>

  <main class="p-4 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-xl font-bold">BizApp</h1>
      <div class="text-sm">Signed-in as: <input id="xuser" class="border px-2 py-1 rounded" placeholder="yourname"/></div>
    </header>

    <!-- HR ‚Ä∫ Employee -->
    <section x-show="mainTab==='hr' && open==='employee'" x-data="employeeApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">Employee ID</label><input class="w-full border rounded px-3 py-2 bg-gray-100" x-model="form.employeeId" readonly></div>
          <div><label class="text-sm">First Name</label><input class="w-full border rounded px-3 py-2" x-model="form.firstName"></div>
          <div><label class="text-sm">Last Name</label><input class="w-full border rounded px-3 py-2" x-model="form.lastName"></div>
          <div><label class="text-sm">National ID</label><input class="w-full border rounded px-3 py-2" maxlength="13" x-model="form.nationalId" @input="form.nationalId=form.nationalId.replace(/\D/g,'').slice(0,13)"></div>
          <div><label class="text-sm">Gender</label><select class="w-full border rounded px-3 py-2" x-model="form.gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
          <div><label class="text-sm">Phone</label><input class="w-full border rounded px-3 py-2" x-model="form.phone"></div>
          <div><label class="text-sm">Email</label><input class="w-full border rounded px-3 py-2" x-model="form.email" type="email"></div>
          <div><label class="text-sm">Department</label><input class="w-full border rounded px-3 py-2" x-model="form.department"></div>
          <div><label class="text-sm">Position</label><select class="w-full border rounded px-3 py-2" x-model="form.position"><option>Doctor</option><option>Doctor Assistant</option></select></div>
          <div><label class="text-sm">Start Date</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.startDate"></div>
          <div><label class="text-sm">Last Date</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.lastDate"></div>
          <div><label class="text-sm">Salary Type</label><select class="w-full border rounded px-3 py-2" x-model="form.salaryType"><option>Part-Time</option><option>Full Time</option><option>Percentage</option></select></div>
          <div class="md:col-span-2">
            <label class="text-sm">Rate</label>
            <input class="w-full border rounded px-3 py-2" x-model="salaryDisplay" @input="onRateInput($event)" @blur="onRateBlur()" placeholder="THB or % (0‚Äì100)">
            <div class="text-xs text-gray-500 mt-1">‚Ä¢ Part-Time: THB/Hr ‚Ä¢ Full Time: THB/Month ‚Ä¢ Percentage: 0‚Äì100 (stored as 0‚Äì1)</div>
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <button class="px-4 py-2 rounded text-white bg-blue-600" @click="save()" x-text="editingId? 'Update':'Save'"></button>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4">
        <div class="flex items-end gap-3">
          <div><label class="text-sm">Search</label><input class="border rounded px-3 py-2" x-model="search"></div>
          <div><label class="text-sm">Position</label>
            <select class="border rounded px-3 py-2" x-model="filterPosition"><option value="">‡∏ó‡∏∏‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</option><option>Doctor</option><option>Doctor Assistant</option></select>
          </div>
        </div>
        <div class="overflow-auto mt-3">
          <table class="min-w-full text-sm border">
            <thead><tr class="bg-gray-100">
              <th class="px-2 py-1 border">EmpID</th><th class="px-2 py-1 border">Name</th><th class="px-2 py-1 border">National ID</th><th class="px-2 py-1 border">SalaryType</th><th class="px-2 py-1 border">Salary</th><th class="px-2 py-1 border">Start</th><th class="px-2 py-1 border">Last</th><th class="px-2 py-1 border">Status</th><th class="px-2 py-1 border">Actions</th>
            </tr></thead>
            <tbody>
              <template x-for="r in filteredEmployees()" :key="r.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-2 py-1 border" x-text="r.employeeId"></td>
                  <td class="px-2 py-1 border" x-text="r.firstName+' '+r.lastName"></td>
                  <td class="px-2 py-1 border" x-text="r.nationalId"></td>
                  <td class="px-2 py-1 border" x-text="r.salaryType"></td>
                  <td class="px-2 py-1 border" x-text="displaySalary(r)"></td>
                  <td class="px-2 py-1 border" x-text="r.startDate"></td>
                  <td class="px-2 py-1 border" x-text="r.lastDate||'-'"></td>
                  <td class="px-2 py-1 border" x-text="statusFromLastDate(r.lastDate)"></td>
                  <td class="px-2 py-1 border">
                    <button class="text-blue-600" @click="loadToEdit(r)">Edit</button>
                    <button class="text-rose-600 ml-2" @click="remove(r)">Delete</button>
                  </td>
                </tr>
              </template>
              <tr x-show="rows.length===0"><td colspan="9" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- HR ‚Ä∫ Attendance -->
    <section x-show="mainTab==='hr' && open==='attendance'" x-data="attendanceApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <select class="w-full border rounded px-3 py-2" x-model="form.empId">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              <template x-for="e in employees" :key="e.employeeId">
                <option :value="e.employeeId" x-text="e.employeeId+' ‚Äî '+e.firstName+' '+e.lastName"></option>
              </template>
            </select>
          </div>
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.date"></div>
          <div><label class="text-sm">Check-in</label><input class="w-full border rounded px-3 py-2" type="time" x-model="form.checkIn"></div>
          <div><label class="text-sm">Check-out</label><input class="w-full border rounded px-3 py-2" type="time" x-model="form.checkOut"></div>
          <div><label class="text-sm">Leave Type</label>
            <select class="w-full border rounded px-3 py-2" x-model="form.leaveType">
              <option value="">‚Äî None ‚Äî</option><option>Sick</option><option>Annual</option><option>Business</option><option>Unpaid</option><option>WFH</option>
            </select>
          </div>
          <div><label class="text-sm">Status</label><select class="w-full border rounded px-3 py-2" x-model="form.status"><option>Pending</option><option>Approved</option><option>Rejected</option></select></div>
          <div class="md:col-span-3"><label class="text-sm">Note</label><input class="w-full border rounded px-3 py-2" x-model="form.note"></div>
        </div>
        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <button class="px-4 py-2 rounded text-white bg-blue-600" @click="save()" x-text="editingId? 'Update':'Save'"></button>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4">
        <div class="flex items-end gap-3">
          <div><label class="text-sm">Emp</label>
            <select class="border rounded px-3 py-2" x-model="filter.empId"><option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <template x-for="e in employees" :key="'f-'+e.employeeId"><option :value="e.employeeId" x-text="e.employeeId+' ‚Äî '+e.firstName+' '+e.lastName"></option></template>
            </select></div>
          <div><label class="text-sm">‡∏à‡∏≤‡∏Å</label><input class="border rounded px-3 py-2" type="date" x-model="filter.from"></div>
          <div><label class="text-sm">‡∏ñ‡∏∂‡∏á</label><input class="border rounded px-3 py-2" type="date" x-model="filter.to"></div>
        </div>
        <div class="overflow-auto mt-3">
          <table class="min-w-full text-sm border">
            <thead><tr class="bg-gray-100"><th class="px-2 py-1 border">Date</th><th class="px-2 py-1 border">Emp</th><th class="px-2 py-1 border">In</th><th class="px-2 py-1 border">Out</th><th class="px-2 py-1 border">Leave</th><th class="px-2 py-1 border">Status</th><th class="px-2 py-1 border">Note</th><th class="px-2 py-1 border">Actions</th></tr></thead>
            <tbody>
              <template x-for="r in rows" :key="r.id">
                <tr class="hover:bg-gray-50">
                  <td class="px-2 py-1 border" x-text="r.date"></td>
                  <td class="px-2 py-1 border" x-text="r.empId"></td>
                  <td class="px-2 py-1 border" x-text="r.checkIn||'-'"></td>
                  <td class="px-2 py-1 border" x-text="r.checkOut||'-'"></td>
                  <td class="px-2 py-1 border" x-text="r.leaveType||'-'"></td>
                  <td class="px-2 py-1 border" x-text="r.status"></td>
                  <td class="px-2 py-1 border" x-text="r.note||''"></td>
                  <td class="px-2 py-1 border"><button class="text-blue-600" @click="loadToEdit(r)">Edit</button> <button class="text-rose-600" @click="remove(r)">Delete</button></td>
                </tr>
              </template>
              <tr x-show="rows.length===0"><td colspan="8" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- HR ‚Ä∫ Timeclock -->
    <section x-show="mainTab==='hr' && open==='timeclock'" x-data="timeclockApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
            <select class="w-full border rounded px-3 py-2" x-model="form.empId" @change="refresh()">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
              <template x-for="e in employees" :key="e.employeeId">
                <option :value="e.employeeId" x-text="e.employeeId+' ‚Äî '+e.firstName+' '+e.lastName"></option>
              </template>
            </select>
          </div>
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.date" @change="refresh()"></div>
          <div class="flex items-end gap-2">
            <button class="px-3 py-2 rounded border" @click="geo()">üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</button>
            <span class="text-sm text-gray-500" x-text="form.geo||'‚Äî'"></span>
          </div>
        </div>

        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded text-white bg-green-600 disabled:opacity-50" :disabled="!canIn" @click="clockIn()">Clock In</button>
          <button class="px-4 py-2 rounded text-white bg-rose-600 disabled:opacity-50" :disabled="!canOut" @click="clockOut()">Clock Out</button>
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
        </div>

        <div class="grid md:grid-cols-3 gap-3">
          <div class="p-3 rounded bg-green-50">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤: <b x-text="statusToday.in||'‚Äî'"></b></div>
          <div class="p-3 rounded bg-rose-50">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å: <b x-text="statusToday.out||'‚Äî'"></b></div>
          <div class="p-3 rounded bg-blue-50">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°: <b x-text="statusToday.totalHrs||'0'"></b></div>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4">
        <h3 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
        <table class="min-w-full text-sm border">
          <thead><tr class="bg-gray-100"><th class="px-2 py-1 border">Date</th><th class="px-2 py-1 border">Emp</th><th class="px-2 py-1 border">In</th><th class="px-2 py-1 border">Out</th><th class="px-2 py-1 border">Hrs</th><th class="px-2 py-1 border">Note</th><th class="px-2 py-1 border">Geo</th></tr></thead>
          <tbody>
            <template x-for="r in rows" :key="r.id">
              <tr class="hover:bg-gray-50">
                <td class="px-2 py-1 border" x-text="r.date"></td>
                <td class="px-2 py-1 border" x-text="r.empId"></td>
                <td class="px-2 py-1 border" x-text="display(r.inAt)"></td>
                <td class="px-2 py-1 border" x-text="display(r.outAt)"></td>
                <td class="px-2 py-1 border" x-text="hours(r.inAt,r.outAt)"></td>
                <td class="px-2 py-1 border" x-text="r.note||''"></td>
                <td class="px-2 py-1 border" x-text="r.geo||''"></td>
              </tr>
            </template>
            <tr x-show="rows.length===0"><td colspan="7" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Sales ‚Ä∫ Customer -->
    <section x-show="mainTab==='sales' && open==='customer'" x-data="customerApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input class="w-full border rounded px-3 py-2" x-model="form.code" placeholder="(‡∏ñ‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡∏≠‡∏Å‡πÉ‡∏´‡πâ)"></div>
          <div><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠</label><input class="w-full border rounded px-3 py-2" x-model="form.firstName"></div>
          <div><label class="text-sm">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="w-full border rounded px-3 py-2" x-model="form.lastName"></div>
          <div><label class="text-sm">‡πÄ‡∏û‡∏®</label><select class="w-full border rounded px-3 py-2" x-model="form.gender"><option>Male</option><option>Female</option><option>Other</option></select></div>
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.birthday"></div>
          <div><label class="text-sm">‡∏≠‡∏≤‡∏¢‡∏∏</label><input class="w-full border rounded px-3 py-2" x-model="form.age"></div>
          <div><label class="text-sm">‡πÇ‡∏ó‡∏£</label><input class="w-full border rounded px-3 py-2" x-model="form.phone"></div>
          <div><label class="text-sm">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label><input class="w-full border rounded px-3 py-2" type="email" x-model="form.email"></div>
          <div><label class="text-sm">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label><input class="w-full border rounded px-3 py-2" maxlength="13" x-model="form.nationalId" @input="form.nationalId=form.nationalId.replace(/\D/g,'').slice(0,13)"></div>
          <div class="md:col-span-3 grid md:grid-cols-6 gap-3">
            <div><label class="text-sm">‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</label><input class="w-full border rounded px-3 py-2" x-model="form.address.no"></div>
            <div><label class="text-sm">‡∏ñ‡∏ô‡∏ô</label><input class="w-full border rounded px-3 py-2" x-model="form.address.road"></div>
            <div><label class="text-sm">‡∏ã‡∏≠‡∏¢</label><input class="w-full border rounded px-3 py-2" x-model="form.address.soi"></div>
            <div><label class="text-sm">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label><input class="w-full border rounded px-3 py-2" x-model="form.address.provinceName"></div>
            <div><label class="text-sm">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label><input class="w-full border rounded px-3 py-2" x-model="form.address.amphureName"></div>
            <div><label class="text-sm">‡∏ï‡∏≥‡∏ö‡∏•</label><input class="w-full border rounded px-3 py-2" x-model="form.address.tambonName"></div>
            <div><label class="text-sm">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label><input class="w-full border rounded px-3 py-2" x-model="form.address.postcode"></div>
          </div>
          <div class="md:col-span-3 grid md:grid-cols-2 gap-3">
            <div><label class="text-sm">‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label><input class="w-full border rounded px-3 py-2" x-model="form.diseases"></div>
            <div><label class="text-sm">‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label><input class="w-full border rounded px-3 py-2" x-model="form.allergies"></div>
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <button class="px-4 py-2 rounded text-white bg-blue-600" @click="save()" x-text="editingId? 'Update':'Save'"></button>
        </div>
      </div>

      <div class="bg-white rounded shadow p-4">
        <h3 class="font-semibold mb-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>
        <table class="min-w-full text-sm border">
          <thead><tr class="bg-gray-100"><th class="px-2 py-1 border">Code</th><th class="px-2 py-1 border">Name</th><th class="px-2 py-1 border">Phone</th><th class="px-2 py-1 border">Actions</th></tr></thead>
          <tbody>
            <template x-for="r in rows" :key="r.id">
              <tr class="hover:bg-gray-50">
                <td class="px-2 py-1 border" x-text="r.code"></td>
                <td class="px-2 py-1 border" x-text="r.firstName+' '+r.lastName"></td>
                <td class="px-2 py-1 border" x-text="r.phone"></td>
                <td class="px-2 py-1 border"><button class="text-blue-600" @click="loadToEdit(r)">Edit</button> <button class="text-rose-600" @click="remove(r)">Delete</button></td>
              </tr>
            </template>
            <tr x-show="rows.length===0"><td colspan="4" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Sales ‚Ä∫ Quotation (header + items) -->
    <section x-show="mainTab==='sales' && open==='quotation'" x-data="quotationApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤</label><input class="w-full border rounded px-3 py-2" x-model="form.qNo" placeholder="(auto)"></div>
          <div><label class="text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.qDate"></div>
          <div><label class="text-sm">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><select class="w-full border rounded px-3 py-2" x-model="form.status"><option>Open</option><option>Confirmed</option></select></div>
          <div class="md:col-span-3 grid md:grid-cols-4 gap-3">
            <div><label class="text-sm">Customer Code</label><input class="w-full border rounded px-3 py-2" x-model="form.customerCode"></div>
            <div><label class="text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label><input class="w-full border rounded px-3 py-2" x-model="form.customerFirstName"></div>
            <div><label class="text-sm">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input class="w-full border rounded px-3 py-2" x-model="form.customerLastName"></div>
            <div><label class="text-sm">‡∏ö‡∏±‡∏ï‡∏£ ‡∏õ‡∏ä‡∏ä.</label><input class="w-full border rounded px-3 py-2" x-model="form.customerNationalId"></div>
          </div>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">Items</div>
          <div class="grid md:grid-cols-6 gap-2" x-data="{ it:{ itemCode:'', itemName:'', qty:1, unitPrice:0, lineTotal:0 } }">
            <input class="border rounded px-2 py-1" placeholder="Code" x-model="it.itemCode">
            <input class="border rounded px-2 py-1 md:col-span-2" placeholder="Name/Service" x-model="it.itemName">
            <input class="border rounded px-2 py-1" type="number" step="0.01" x-model.number="it.qty">
            <input class="border rounded px-2 py-1" type="number" step="0.01" x-model.number="it.unitPrice">
            <button class="px-3 py-1 rounded bg-green-600 text-white" @click="$store.qitems.add(it)">Add</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm border">
              <thead><tr class="bg-gray-100"><th class="px-2 py-1 border">Code</th><th class="px-2 py-1 border">Name</th><th class="px-2 py-1 border">Qty</th><th class="px-2 py-1 border">Unit Price</th><th class="px-2 py-1 border">Line Total</th><th class="px-2 py-1 border">Actions</th></tr></thead>
              <tbody>
                <template x-for="(it,i) in $store.qitems.items" :key="i">
                  <tr class="hover:bg-gray-50">
                    <td class="px-2 py-1 border" x-text="it.itemCode"></td>
                    <td class="px-2 py-1 border" x-text="it.itemName"></td>
                    <td class="px-2 py-1 border" x-text="it.qty"></td>
                    <td class="px-2 py-1 border" x-text="it.unitPrice"></td>
                    <td class="px-2 py-1 border" x-text="(it.qty*it.unitPrice).toFixed(2)"></td>
                    <td class="px-2 py-1 border"><button class="text-rose-600" @click="$store.qitems.remove(i)">Delete</button></td>
                  </tr>
                </template>
                <tr x-show="$store.qitems.items.length===0"><td colspan="6" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
              </tbody>
            </table>
          </div>
          <div class="text-right">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <b x-text="$store.qitems.total().toFixed(2)"></b></div>
        </div>

        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <button class="px-4 py-2 rounded text-white bg-blue-600" @click="save()">Save (Header+Items)</button>
        </div>
      </div>
    </section>

    <!-- Purchasing (PR, RFQ, PO, GRN) ‚Äì simplified headers + items -->
    <section x-show="mainTab==='purchase' && ['pr','rfq','po','grn'].includes(open)" x-data="purchApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">Doc Type</label>
            <select class="w-full border rounded px-3 py-2" x-model="docType">
              <option value="pr">PR</option><option value="rfq">RFQ</option><option value="po">PO</option><option value="grn">GRN</option>
            </select>
          </div>
          <div><label class="text-sm">Doc No</label><input class="w-full border rounded px-3 py-2" x-model="form.docNo" placeholder="(auto)"></div>
          <div><label class="text-sm">Date</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.docDate"></div>
        </div>

        <div class="grid md:grid-cols-4 gap-3" x-show="docType==='po' || docType==='rfq'">
          <div class="md:col-span-2"><label class="text-sm">Supplier Code</label><input class="w-full border rounded px-3 py-2" x-model="form.supplierCode"></div>
          <div><label class="text-sm">Payment Term</label><input class="w-full border rounded px-3 py-2" x-model="form.paymentTerm"></div>
          <div><label class="text-sm">Status</label><input class="w-full border rounded px-3 py-2" x-model="form.status"></div>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">Items</div>
          <div class="grid md:grid-cols-6 gap-2" x-data="{ it:{ itemCode:'', itemDesc:'', qty:1, uom:'EA', unitPrice:0 } }">
            <input class="border rounded px-2 py-1" placeholder="Code" x-model="it.itemCode">
            <input class="border rounded px-2 py-1 md:col-span-2" placeholder="Desc" x-model="it.itemDesc">
            <input class="border rounded px-2 py-1" type="number" step="0.01" x-model.number="it.qty">
            <input class="border rounded px-2 py-1" x-model="it.uom">
            <input class="border rounded px-2 py-1" type="number" step="0.01" x-model.number="it.unitPrice">
            <button class="px-3 py-1 rounded bg-green-600 text-white" @click="$store.pitems.add(it)">Add</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm border">
              <thead><tr class="bg-gray-100"><th class="px-2 py-1 border">Code</th><th class="px-2 py-1 border">Desc</th><th class="px-2 py-1 border">Qty</th><th class="px-2 py-1 border">UOM</th><th class="px-2 py-1 border">Unit Price</th><th class="px-2 py-1 border">Amount</th><th class="px-2 py-1 border">Actions</th></tr></thead>
              <tbody>
                <template x-for="(it,i) in $store.pitems.items" :key="i">
                  <tr class="hover:bg-gray-50">
                    <td class="px-2 py-1 border" x-text="it.itemCode"></td>
                    <td class="px-2 py-1 border" x-text="it.itemDesc"></td>
                    <td class="px-2 py-1 border" x-text="it.qty"></td>
                    <td class="px-2 py-1 border" x-text="it.uom"></td>
                    <td class="px-2 py-1 border" x-text="it.unitPrice"></td>
                    <td class="px-2 py-1 border" x-text="(it.qty*it.unitPrice).toFixed(2)"></td>
                    <td class="px-2 py-1 border"><button class="text-rose-600" @click="$store.pitems.remove(i)">Delete</button></td>
                  </tr>
                </template>
                <tr x-show="$store.pitems.items.length===0"><td colspan="7" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <button class="px-4 py-2 rounded text-white bg-blue-600" @click="save()">Save</button>
        </div>
      </div>
    </section>

    <!-- Inventory (Picking / Dispatch) -->
    <section x-show="mainTab==='inventory' && open==='picking' || open==='dispatch'" x-data="invApp()" x-init="init()" x-cloak>
      <div class="bg-white rounded shadow p-4 space-y-4">
        <div class="grid md:grid-cols-3 gap-3">
          <div><label class="text-sm">Doc Type</label>
            <select class="w-full border rounded px-3 py-2" x-model="docType">
              <option value="picking">Picking</option>
              <option value="dispatch">Dispatch</option>
            </select>
          </div>
          <div><label class="text-sm">Doc No</label><input class="w-full border rounded px-3 py-2" x-model="form.docNo" placeholder="(auto)"></div>
          <div><label class="text-sm">Date</label><input class="w-full border rounded px-3 py-2" type="date" x-model="form.docDate"></div>
        </div>

        <div class="space-y-2">
          <div class="text-sm font-medium">Items</div>
          <div class="grid md:grid-cols-6 gap-2" x-data="{ it:{ productCode:'', batchNo:'', qtyPick:1, location:'' } }">
            <input class="border rounded px-2 py-1" placeholder="Product" x-model="it.productCode">
            <input class="border rounded px-2 py-1" placeholder="Batch" x-model="it.batchNo">
            <input class="border rounded px-2 py-1" type="number" step="0.01" x-model.number="it.qtyPick">
            <input class="border rounded px-2 py-1" placeholder="Location" x-model="it.location">
            <button class="px-3 py-1 rounded bg-green-600 text-white" @click="$store.iitems.add(it)">Add</button>
          </div>
          <div class="overflow-auto">
            <table class="min-w-full text-sm border">
              <thead><tr class="bg-gray-100"><th class="px-2 py-1 border">Product</th><th class="px-2 py-1 border">Batch</th><th class="px-2 py-1 border">Qty</th><th class="px-2 py-1 border">Location</th><th class="px-2 py-1 border">Actions</th></tr></thead>
              <tbody>
                <template x-for="(it,i) in $store.iitems.items" :key="i">
                  <tr class="hover:bg-gray-50">
                    <td class="px-2 py-1 border" x-text="it.productCode"></td>
                    <td class="px-2 py-1 border" x-text="it.batchNo"></td>
                    <td class="px-2 py-1 border" x-text="it.qtyPick"></td>
                    <td class="px-2 py-1 border" x-text="it.location"></td>
                    <td class="px-2 py-1 border"><button class="text-rose-600" @click="$store.iitems.remove(i)">Delete</button></td>
                  </tr>
                </template>
                <tr x-show="$store.iitems.items.length===0"><td colspan="5" class="text-center text-gray-500 p-3">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="flex gap-2 justify-end">
          <button class="px-4 py-2 rounded border" @click="resetForm()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
          <button class="px-4 py-2 rounded text-white bg-blue-600" @click="save()">Save</button>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
const api = {
  async call(path, method="GET", body=null) {
    const headers = { "content-type": "application/json", "x-user": document.getElementById("xuser")?.value || "anonymous" };
    const res = await fetch(`/api/${path}`, { method, headers, body: body? JSON.stringify(body): undefined });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  },
  list: (table) => api.call(table, "GET"),
  insert: (table, data) => api.call(table, "POST", data),
  updateById: (table, id, data) => api.call(`${table}/${id}`, "PUT", data),
  deleteById: (table, id) => api.call(`${table}/${id}`, "DELETE"),
};

// HR ¬ª Employee
function employeeApp(){
  return {
    form: { employeeId:"", firstName:"", lastName:"", nationalId:"", gender:"Male", phone:"", email:"", department:"", position:"Doctor", startDate:"", lastDate:"", salaryType:"Full Time" },
    salaryDisplay: "",
    rows: [], search:"", filterPosition:"", editingId: null,

    async init(){ await this.reload(); },
    async reload(){ const r = await api.list("hr/employees"); this.rows = r.rows; },
    statusFromLastDate(d){ return d? "Resigned":"Active"; },
    displaySalary(emp){
      if (emp.salaryType==="Percentage") return ((Number(emp.salary||0))*100).toFixed(0)+"%";
      return (Number(emp.salary||0)).toLocaleString()+" THB";
    },
    onRateInput(e){
      let v = e.target.value.replace(/[^\d.]/g,"");
      if (this.form.salaryType==="Percentage"){ v = v.slice(0,5); }
      this.salaryDisplay = v;
    },
    onRateBlur(){ if (this.form.salaryType!=="Percentage"){ this.salaryDisplay = Number(this.salaryDisplay||0).toLocaleString(); } },
    resetForm(){ this.form = { employeeId:"", firstName:"", lastName:"", nationalId:"", gender:"Male", phone:"", email:"", department:"", position:"Doctor", startDate:"", lastDate:"", salaryType:"Full Time" }; this.salaryDisplay=""; this.editingId=null; },
    loadToEdit(r){ this.form = { ...r }; this.salaryDisplay = r.salaryType==="Percentage" ? String((Number(r.salary||0))*100) : String(r.salary||""); this.editingId = r.id; },
    async save(){
      const payload = { ...this.form, salaryValue: this.salaryDisplay };
      if (this.editingId){ await api.updateById("hr/employees", this.editingId, payload); }
      else { await api.insert("hr/employees", payload); }
      this.resetForm(); await this.reload();
    },
    async remove(r){ if (!confirm("Delete?")) return; await api.deleteById("hr/employees", r.id); await this.reload(); },
    filteredEmployees(){
      const q = this.search?.toLowerCase()||"";
      return this.rows.filter(r => (!this.filterPosition || r.position===this.filterPosition) &&
        (!q || [r.employeeId, r.firstName, r.lastName, r.department].some(x => String(x||'').toLowerCase().includes(q))));
    }
  }
}

// HR ¬ª Attendance
function attendanceApp(){
  return {
    form: { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },
    employees: [], rows: [], filter: { empId:"", from:"", to:"" }, editingId: null,
    async init(){ this.employees = (await api.list("hr/employees")).rows; await this.reload(); },
    async reload(){ this.rows = (await api.list("hr/attendance")).rows; },
    resetForm(){ this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; this.editingId=null; },
    loadToEdit(r){ this.form = { ...r }; this.editingId = r.id; },
    async save(){
      const emp = this.employees.find(e=>e.employeeId===this.form.empId);
      this.form.fullName = emp ? `${emp.firstName} ${emp.lastName}` : "";
      this.form.position = emp?.position || "";
      if (this.editingId){ await api.updateById("hr/attendance", this.editingId, this.form); }
      else { await api.insert("hr/attendance", this.form); }
      this.resetForm(); await this.reload();
    },
    async remove(r){ if (!confirm("Delete?")) return; await api.deleteById("hr/attendance", r.id); await this.reload(); }
  }
}

// HR ¬ª Timeclock
function timeclockApp(){
  return {
    form: { empId:"", date: new Date().toISOString().slice(0,10), note:"", geo:"" },
    employees: [], rows: [], statusToday:{ in:null, out:null, totalHrs:"0" }, canIn:false, canOut:false,
    async init(){ this.employees = (await api.list("hr/employees")).rows; await this.refresh(); },
    async refresh(){
      this.rows = (await api.list("hr/timeclock")).rows.filter(r=>!this.form.empId || r.empId===this.form.empId);
      const today = this.form.date;
      const t = this.rows.filter(r=>r.date===today).sort((a,b)=>a.id-b.id);
      const firstIn = t.find(r=>r.inAt); const lastOut = [...t].reverse().find(r=>r.outAt);
      this.statusToday.in = firstIn?.inAt || null;
      this.statusToday.out = lastOut?.outAt || null;
      const inTs = firstIn ? Date.parse(firstIn.inAt) : null;
      const outTs = lastOut && lastOut.outAt ? Date.parse(lastOut.outAt) : null;
      this.statusToday.totalHrs = (inTs && outTs) ? (((outTs-inTs)/3600000).toFixed(2)) : "0";
      this.canIn = !!this.form.empId && !firstIn;
      this.canOut = !!this.form.empId && !!firstIn && !lastOut?.outAt;
    },
    async clockIn(){
      const now = new Date().toISOString();
      await api.insert("hr/timeclock", { empId:this.form.empId, date:this.form.date, inAt:now, note:this.form.note, geo:this.form.geo });
      await this.refresh();
    },
    async clockOut(){
      const open = this.rows.filter(r=>r.empId===this.form.empId && r.date===this.form.date && r.inAt && !r.outAt).sort((a,b)=>b.id-a.id)[0];
      if (!open) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ");
      const now = new Date().toISOString();
      await api.updateById("hr/timeclock", open.id, { outAt: now });
      await this.refresh();
    },
    resetForm(){ this.form = { empId:"", date:new Date().toISOString().slice(0,10), note:"", geo:"" }; },
    geo(){ if (!navigator.geolocation) return; navigator.geolocation.getCurrentPosition(pos=>{ this.form.geo = `${pos.coords.latitude},${pos.coords.longitude}`; }); },
    display(s){ return s ? new Date(s).toLocaleTimeString() : ""; },
    hours(a,b){ if (!a||!b) return "0"; return (((Date.parse(b)-Date.parse(a))/3600000).toFixed(2)); }
  }
}

// Sales ¬ª Customers
function customerApp(){
  return {
    form: { code:"", firstName:"", lastName:"", gender:"Male", birthday:"", age:"", phone:"", email:"", nationalId:"", address:{ no:"", road:"", soi:"", provinceName:"", amphureName:"", tambonName:"", postcode:"" }, diseases:"", allergies:"" },
    rows: [], editingId:null,
    async init(){ await this.reload(); },
    async reload(){ this.rows = (await api.list("sales/customers")).rows; },
    resetForm(){ this.form = { code:"", firstName:"", lastName:"", gender:"Male", birthday:"", age:"", phone:"", email:"", nationalId:"", address:{}, diseases:"", allergies:"" }; this.editingId=null; },
    loadToEdit(r){ this.form = { ...r, address:{ no:r.addr_no, road:r.addr_road, soi:r.addr_soi, provinceName:r.provinceName, amphureName:r.amphureName, tambonName:r.tambonName, postcode:r.postcode } }; this.editingId=r.id; },
    async save(){
      const payload = { ...this.form };
      if (this.editingId){ await api.updateById("sales/customers", this.editingId, payload); }
      else { await api.insert("sales/customers", payload); }
      this.resetForm(); await this.reload();
    },
    async remove(r){ if (!confirm("Delete?")) return; await api.deleteById("sales/customers", r.id); await this.reload(); }
  }
}

// Quotation items store
document.addEventListener('alpine:init', () => {
  Alpine.store('qitems', {
    items: [],
    add(it){ this.items.push({ ...it, qty:Number(it.qty||0), unitPrice:Number(it.unitPrice||0) }); },
    remove(i){ this.items.splice(i,1); },
    total(){ return this.items.reduce((s, it)=> s + (Number(it.qty||0)*Number(it.unitPrice||0)), 0); }
  });
  Alpine.store('pitems', { items: [], add(it){ this.items.push({ ...it, qty:Number(it.qty||0), unitPrice:Number(it.unitPrice||0) }); }, remove(i){ this.items.splice(i,1); } });
  Alpine.store('iitems', { items: [], add(it){ this.items.push({ ...it }); }, remove(i){ this.items.splice(i,1); } });
});

// Sales ¬ª Quotation (header + items)
function quotationApp(){
  return {
    form: { qNo:"", qDate:new Date().toISOString().slice(0,10), status:"Open", customerCode:"", customerFirstName:"", customerLastName:"", customerNationalId:"" },
    async init(){ /* noop */ },
    resetForm(){ this.form = { qNo:"", qDate:new Date().toISOString().slice(0,10), status:"Open", customerCode:"", customerFirstName:"", customerLastName:"", customerNationalId:"" }; Alpine.store('qitems').items=[]; },
    async save(){
      const items = Alpine.store('qitems').items.map(it=>({ ...it, lineTotal: Number(it.qty||0)*Number(it.unitPrice||0) }));
      const totals = items.reduce((a,it)=> a + it.lineTotal, 0);
      const payload = { ...this.form, totalBeforeDiscount: totals, discount: 0, grandTotal: totals, items };
      const r = await api.insert("sales/quotations", payload);
      alert("Saved: "+(r.docNo||this.form.qNo));
      this.resetForm();
    }
  }
}

// Purchasing (PR/RFQ/PO/GRN) generic
function purchApp(){
  return {
    docType: "pr",
    form: { docNo:"", docDate: new Date().toISOString().slice(0,10), supplierCode:"", paymentTerm:"", status:"Open" },
    async init(){ /* noop */ },
    resetForm(){ this.form = { docNo:"", docDate: new Date().toISOString().slice(0,10), supplierCode:"", paymentTerm:"", status:"Open" }; Alpine.store('pitems').items=[]; },
    async save(){
      const items = Alpine.store('pitems').items.map(it=>({ ...it, amount: Number(it.qty||0)*Number(it.unitPrice||0) }));
      let path = ""; let linkField="";
      if (this.docType==='pr'){ path="purch/pr"; linkField="prNo"; }
      if (this.docType==='rfq'){ path="purch/rfq"; linkField="rfqNo"; }
      if (this.docType==='po'){ path="purch/po"; linkField="poNo"; }
      if (this.docType==='grn'){ path="purch/grn"; linkField="grnNo"; }
      const header = { note:"", status:this.form.status };
      if (this.docType==='pr'){ Object.assign(header, { prDate:this.form.docDate, department:"", requester:"" }); }
      if (this.docType==='rfq'){ Object.assign(header, { rfqDate:this.form.docDate, prNo:"" }); }
      if (this.docType==='po'){ Object.assign(header, { poDate:this.form.docDate, supplierCode:this.form.supplierCode, paymentTerm:this.form.paymentTerm }); }
      if (this.docType==='grn'){ Object.assign(header, { grnDate:this.form.docDate, poNo:"", receiver:"" }); }
      if (this.form.docNo){ header[linkField]=this.form.docNo; }
      const r = await api.insert(path, { ...header, items });
      alert("Saved: "+(r.docNo||this.form.docNo||"(auto)"));
      this.resetForm();
    }
  }
}

// Inventory (Picking / Dispatch) generic
function invApp(){
  return {
    docType:"picking",
    form:{ docNo:"", docDate:new Date().toISOString().slice(0,10) },
    async init(){ /* noop */ },
    resetForm(){ this.form = { docNo:"", docDate:new Date().toISOString().slice(0,10) }; Alpine.store('iitems').items=[]; },
    async save(){
      const items = Alpine.store('iitems').items;
      let path=""; let linkField="";
      if (this.docType==='picking'){ path="inv/pickingorders"; linkField="pickNo"; }
      if (this.docType==='dispatch'){ path="inv/dispatches"; linkField="dispatchNo"; }
      const header = { status:"Open", note:"" };
      if (this.form.docNo) header[linkField]=this.form.docNo;
      const r = await api.insert(path, { ...header, items });
      alert("Saved: "+(r.docNo||this.form.docNo||"(auto)"));
      this.resetForm();
    }
  }
}
</script>
</body>
</html>
