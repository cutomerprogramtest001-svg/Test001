<!DOCTYPE html>
<html lang="th" x-data="{ mainTab: 'hr', open: 'product' }">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unified Business Modules</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 text-gray-800">
<div class="flex min-h-screen">
  <!-- Sidebar -->
  <aside class="w-72 bg-white shadow-md p-4 space-y-2 overflow-y-auto">
    <h1 class="text-xl font-bold border-b pb-2 mb-2">üìã Main Menu</h1>
    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'hr' }"
            @click="mainTab = 'hr'">üë∑ HR Module</button>
            <template x-if="mainTab === 'hr'">
            <div class="mt-2 border-t pt-2 space-y-1 text-sm">
              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'employee' }"
                      @click="open = 'employee'">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'payroll' }"
                      @click="open = 'payroll'">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'attendance' }"
                      @click="open = 'attendance'">‡∏Ç‡∏≤‡∏î/‡∏•‡∏≤/‡∏°‡∏≤‡∏™‡∏≤‡∏¢</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'timeclock' }"
                      @click="open = 'timeclock'">Clock In / Out</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'performance' }"
                      @click="open = 'performance'">‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'recruitment' }"
                      @click="open = 'recruitment'">‡∏™‡∏£‡∏£‡∏´‡∏≤</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'dashboard' }"
                      @click="open = 'dashboard'">Dashboard</button>
            </div>
          </template>

    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'sales' }"
            @click="mainTab = 'sales'">ü¶∑ Sales Module</button>
            <template x-if="mainTab === 'sales'">
            <div class="mt-2 border-t pt-2 space-y-1 text-sm">
              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'customer' }"
                      @click="open = 'customer'">Customer Profile</button>
                      
              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'quotation' }"
                      @click="open = 'quotation'">Quotation & Package Selection</button>
                      
              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'saleorder' }"
                      @click="open = 'saleorder'">Sale Order</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'contact' }"
                      @click="open = 'contact'">Contact & Follow-up Log</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'appointment' }"
                      @click="open = 'appointment'">Appointment & Scheduling</button>

              <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                      :class="{ 'bg-gray-200': open === 'performance' }"
                      @click="open = 'performance'">Sales Performance & Conversion</button>
            </div>
          </template>
<button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
        :class="{ 'bg-blue-200': mainTab === 'purchase' }"
        @click="mainTab = 'purchase'">üõí Purchasing Module</button>

<template x-if="mainTab === 'purchase'">
  <div class="mt-2 border-t pt-2 space-y-1 text-sm">
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'pr' }"
            @click="open = 'pr'">Purchase Requisition</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'rfq' }"
            @click="open = 'rfq'">Request for Quotation</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'po' }"
            @click="open = 'po'">Purchase Order</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'grn' }"
            @click="open = 'grn'">Goods Received Note</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'supplier' }"
            @click="open = 'supplier'">Supplier Management</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'invoice' }"
            @click="open = 'invoice'">Invoice Verification</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'reporting' }"
            @click="open = 'reporting'">Reporting</button>
    <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
            :class="{ 'bg-gray-200': open === 'audit' }"
            @click="open = 'audit'">Audit Trail</button>
  </div>
</template>

    <button class="w-full text-left px-3 py-2 rounded hover:bg-blue-100"
            :class="{ 'bg-blue-200': mainTab === 'inventory' }"
            @click="mainTab = 'inventory'">üì¶ Inventory Module</button>

    <!-- Inventory Submenu -->
    <template x-if="mainTab === 'inventory'">
      <div class="mt-4 border-t pt-2 space-y-1 text-sm">
        <template x-for="tab in [
          'product','movement','receiving','issue','adjustment','count',
          'expiry','picking','dispatch','damage','onhand','kpi','overview'
        ]" :key="tab">
          <button class="w-full text-left px-3 py-1 hover:bg-gray-100 rounded"
                  :class="{ 'bg-gray-200': open === tab }"
                  @click="open = tab"
                  x-text="tab.charAt(0).toUpperCase() + tab.slice(1) + ' Module'"></button>
        </template>
      </div>
    </template>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-4 overflow-y-auto space-y-4">
    <div x-show="mainTab === 'hr'" x-cloak>
<div class="flex min-h-screen">
<!-- Main Content -->
<main class="flex-1 p-6 overflow-y-auto">
<h1 class="text-2xl font-bold mb-4" id="moduleTitle"></h1>
<!-- HR ¬ª Employee Master -->
<div x-show="mainTab === 'hr' && open === 'employee'" x-data="employeeApp()" x-init="init()" x-cloak>
  <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
  <div class="bg-white p-6 rounded-lg shadow space-y-4">
    <h2 class="text-xl font-bold">üìÑ Employee Master</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Employee ID: YY + running 3 digits -->
      <div>
        <label class="block text-sm font-medium">Employee ID</label>
        <input class="mt-1 w-full border px-3 py-2 rounded bg-gray-100" x-model="form.employeeId" readonly>
      </div>

      <!-- First / Last name -->
      <div>
        <label class="block text-sm font-medium">First Name</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.firstName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Somchai">
      </div>
      <div>
        <label class="block text-sm font-medium">Last Name</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.lastName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Jaidee">
      </div>

      <!-- National ID -->
      <div>
        <label class="block text-sm font-medium">National ID</label>
        <input
          class="mt-1 w-full border px-3 py-2 rounded"
          :class="{'border-red-500': form.nationalId && !isNationalIdValid(form.nationalId), 'border-green-500': isNationalIdValid(form.nationalId)}"
          x-model="form.nationalId"
          maxlength="13"
          placeholder="‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å"
          @input="form.nationalId = form.nationalId.replace(/\D/g,'').slice(0,13)"
        >
        <p class="text-xs mt-1" :class="isNationalIdValid(form.nationalId) ? 'text-green-600' : 'text-red-600'">
          <span x-show="form.nationalId && isNationalIdValid(form.nationalId)">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
          <span x-show="form.nationalId && !isNationalIdValid(form.nationalId)">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
        </p>
      </div>

      <div>
        <label class="block text-sm font-medium">Gender</label>
        <select class="mt-1 w-full border px-3 py-2 rounded" x-model="form.gender">
          <option>Male</option>
          <option>Female</option>
          <option>Other</option>
        </select>
      </div>

      <!-- Phone / Email -->
      <div>
        <label class="block text-sm font-medium">Phone</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="tel" x-model="form.phone">
      </div>
      <div>
        <label class="block text-sm font-medium">Email</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="email" x-model="form.email">
      </div>

      <!-- Department -->
      <div>
        <label class="block text-sm font-medium">Department</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" x-model="form.department" placeholder="‡πÄ‡∏ä‡πà‡∏ô Sales / Warehouse / HR">
      </div>

      <!-- Position -->
      <div>
        <label class="block text-sm font-medium">Position</label>
        <select class="mt-1 w-full border px-3 py-2 rounded" x-model="form.position">
          <option>Doctor</option>
          <option>Doctor Assistant</option>
        </select>
      </div>

      <!-- Start / Last Date -->
      <div>
        <label class="block text-sm font-medium">Start Date</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="date" x-model="form.startDate">
      </div>
      <div>
        <label class="block text-sm font-medium">Last Date</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="date" x-model="form.lastDate" title="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ Resigned ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß">
      </div>

      <!-- Salary Type -->
      <div>
        <label class="block text-sm font-medium">Salary Type</label>
        <select class="mt-1 w-full border px-3 py-2 rounded" x-model="form.salaryType">
          <option>Part-Time</option>
          <option>Full Time</option>
          <option>Percentage</option>
        </select>
      </div>

      <!-- Salary Value (unit changes by type) -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</label>
        <div class="relative">
          <!-- as-you-type with commas (THB) / plain for % -->
          <input
            class="mt-1 w-full border px-3 py-2 rounded pr-28"
            type="text"
            inputmode="decimal"
            autocomplete="off"
            spellcheck="false"
            :placeholder="salaryPlaceholder"
            x-model="salaryDisplay"
            @input="onRateInput($event)"
            @blur="onRateBlur()"
          >
          <span class="absolute right-3 top-2.5 text-gray-500 text-sm" x-text="salarySuffix"></span>
        </div>
        <p class="text-xs text-gray-500 mt-1">
          ‚Ä¢ Part-Time: ‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏≤‡∏ó/‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡πÄ‡∏ä‡πà‡∏ô <b>60</b> ‚áí ‡πÅ‡∏™‡∏î‡∏á 60 THB/Hr<br>
          ‚Ä¢ Full Time: ‡πÉ‡∏™‡πà‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô <b>20000</b> ‚áí ‡πÅ‡∏™‡∏î‡∏á 20,000 THB/Month<br>
          ‚Ä¢ Percentage: ‡πÉ‡∏™‡πà 0‚Äì100 ‡πÄ‡∏ä‡πà‡∏ô <b>50</b> ‚áí ‡πÅ‡∏™‡∏î‡∏á 50% ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô <b>0.5</b>
        </p>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏° -->
      <div class="md:col-span-3 flex flex-col sm:flex-row justify-end gap-3 pt-2">
        <button
          type="button"
          @click="resetForm()"
          class="inline-flex items-center justify-center gap-2 rounded-xl border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-1"
          title="‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°"
        >
          ‚Ü∫ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        </button>

        <button
          type="button"
          @click="save()"
          class="inline-flex items-center justify-center gap-2 rounded-xl bg-blue-600 px-5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-offset-1"
          :class="editingIndex !== null ? 'bg-indigo-600 hover:bg-indigo-700 focus:ring-indigo-600' : ''"
          :title="editingIndex === null ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà' : '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'"
        >
          <span x-text="editingIndex === null ? 'üíæ Save' : 'üîÑ Update'"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- üîé Employee Records -->
  <div class="bg-white p-6 rounded-lg shadow mt-6">
    <div class="flex flex-col md:flex-row gap-3 md:items-end md:justify-between">
      <h2 class="text-lg font-semibold">üîé Employee Records</h2>
      <div class="flex flex-col md:flex-row gap-3 md:items-end">
        <div>
          <label class="block text-sm">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (ID/‡∏ä‡∏∑‡πà‡∏≠/‡πÅ‡∏ú‡∏ô‡∏Å)</label>
          <input class="border px-3 py-2 rounded w-64" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô..." x-model.trim="search">
        </div>
        <div>
          <label class="block text-sm">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå Position</label>
          <select class="border px-3 py-2 rounded w-56" x-model="filterPosition">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <option>Doctor</option>
            <option>Doctor Assistant</option>
          </select>
        </div>
      </div>
    </div>

    <div class="overflow-auto mt-4">
      <table class="min-w-full text-sm border border-gray-300">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 border">Employee ID</th>
            <th class="px-3 py-2 border">First Name</th>
            <th class="px-3 py-2 border">Last Name</th>
            <th class="px-3 py-2 border">National ID</th>
            <th class="px-3 py-2 border">Salary Type</th>
            <th class="px-3 py-2 border">Salary</th>
            <th class="px-3 py-2 border">Date of Birth</th>
            <th class="px-3 py-2 border">Gender</th>
            <th class="px-3 py-2 border">Phone</th>
            <th class="px-3 py-2 border">Email</th>
            <th class="px-3 py-2 border">Department</th>
            <th class="px-3 py-2 border">Position</th>
            <th class="px-3 py-2 border">Start Date</th>
            <th class="px-3 py-2 border">Last Date</th>
            <th class="px-3 py-2 border">Status</th>
            <th class="px-3 py-2 border text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(emp, i) in filteredEmployees()" :key="emp.employeeId + i">
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-2 border" x-text="emp.employeeId"></td>
              <td class="px-3 py-2 border" x-text="emp.firstName"></td>
              <td class="px-3 py-2 border" x-text="emp.lastName"></td>
              <td class="px-3 py-2 border" x-text="emp.nationalId"></td>
              <td class="px-3 py-2 border" x-text="emp.salaryType"></td>
              <td class="px-3 py-2 border" x-text="displaySalary(emp)"></td>
              <td class="px-3 py-2 border" x-text="emp.dob"></td>
              <td class="px-3 py-2 border" x-text="emp.gender"></td>
              <td class="px-3 py-2 border" x-text="emp.phone"></td>
              <td class="px-3 py-2 border" x-text="emp.email"></td>
              <td class="px-3 py-2 border" x-text="emp.department"></td>
              <td class="px-3 py-2 border" x-text="emp.position"></td>
              <td class="px-3 py-2 border" x-text="emp.startDate"></td>
              <td class="px-3 py-2 border" x-text="emp.lastDate || '-' "></td>
              <td class="px-3 py-2 border" x-text="statusFromLastDate(emp.lastDate)"></td>
              <td class="px-3 py-2 border text-center">
                <button class="text-blue-600 hover:underline mr-3" @click="edit(i)">Edit</button>
                <button class="text-red-600 hover:underline" @click="del(i)">Delete</button>
              </td>
            </tr>
          </template>
          <tr x-show="filteredEmployees().length === 0">
            <td colspan="16" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Other modules (payroll, attendance, performance, recruitment, dashboard) omitted for brevity -->
<!-- Payroll -->
<div x-show="mainTab === 'hr' && open === 'payroll'" x-cloak>
<!-- Viewer Table Example for payroll -->
<div class="bg-white p-6 rounded-lg shadow mt-6">
<h2 class="text-lg font-semibold mb-4">üîé Employee Records - Payroll &amp; Compensation</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<input class="border px-3 py-2 rounded w-full" placeholder="Search by Name..." type="text"/>
<select class="border px-3 py-2 rounded w-full">
<option value="">Department</option>
<option>Sales</option>
<option>Warehouse</option>
<option>HR</option>
</select>
<select class="border px-3 py-2 rounded w-full">
<option value="">Status</option>
<option>Active</option>
<option>Resigned</option>
<option>Suspended</option>
</select>
</div>
<div class="overflow-auto">
<table class="min-w-full text-sm border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="px-4 py-2 border">Emp ID</th>
<th class="px-4 py-2 border">Full Name</th>
<th class="px-4 py-2 border">Department</th>
<th class="px-4 py-2 border">Status</th>
<th class="px-4 py-2 border">Start Date</th>
<th class="px-4 py-2 border text-center">Actions</th>
</tr>
</thead>
<tbody>
<tr class="hover:bg-gray-50">
<td class="px-4 py-2 border">EMP001</td>
<td class="px-4 py-2 border">John Smith</td>
<td class="px-4 py-2 border">Sales</td>
<td class="px-4 py-2 border text-green-600 font-semibold">Active</td>
<td class="px-4 py-2 border">2022-01-15</td>
<td class="px-4 py-2 border text-center">
<button class="text-blue-600 hover:underline mr-2">Edit</button>
<button class="text-red-600 hover:underline">Delete</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<form class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-6 rounded-lg shadow">
<div><label class="block">Month/Year</label><input class="mt-1 w-full border px-3 py-2 rounded" type="month"/></div>
<div><label class="block">Base Salary</label><input class="mt-1 w-full border px-3 py-2 rounded" type="number"/></div>
<div><label class="block">OT</label><input class="mt-1 w-full border px-3 py-2 rounded" type="number"/></div>
<div><label class="block">Allowance</label><input class="mt-1 w-full border px-3 py-2 rounded" type="number"/></div>
<div><label class="block">Deductions</label><input class="mt-1 w-full border px-3 py-2 rounded" type="number"/></div>
<div><label class="block">Net Pay</label><input class="mt-1 w-full border px-3 py-2 rounded" disabled="" type="number"/></div>
<div class="md:col-span-2 text-right mt-4"><button class="bg-green-600 text-white px-6 py-2 rounded" type="submit">Save</button></div>
</form>
</div>
<!-- Attendance -->
<div x-show="mainTab === 'hr' && open === 'attendance'"
     x-data="attendanceApp()"
     x-init="init()"
     x-cloak
     class="space-y-6">

  <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤/‡∏•‡∏≤ -->
  <div class="bg-white p-6 rounded-lg shadow space-y-4">
    <h2 class="text-xl font-bold">üïí Time Attendance & Leave</h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <div class="relative">
          <input class="mt-1 w-full border px-3 py-2 rounded"
                 type="text"
                 placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠/‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/Emp ID ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤"
                 x-model.trim="empQuery"
                 @focus="showEmpList = true"
                 @keydown.escape="showEmpList = false"
                 @input.debounce.250ms="showEmpList = true">
          <ul class="absolute z-20 w-full bg-white border rounded mt-1 max-h-56 overflow-auto shadow"
              x-show="showEmpList"
              @click.outside="showEmpList = false">
            <template x-for="e in empSuggestionList()" :key="'opt-'+e.employeeId">
              <li class="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm"
                  @click="selectEmp(e)"
                  x-text="`${e.employeeId} ‚Äî ${e.firstName} ${e.lastName} (${e.position||'-'})`"></li>
            </template>
            <li class="px-3 py-2 text-gray-500 text-sm" x-show="empSuggestionList().length===0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</li>
          </ul>
        </div>
        <div class="mt-2 text-sm text-gray-600" x-show="form.empId">
          ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span class="font-medium" x-text="`${form.empId} ‚Äî ${form.fullName}`"></span>
          <span class="ml-2 px-2 py-0.5 rounded bg-gray-100" x-text="form.position || '-'"></span>
          <button type="button" class="ml-2 text-blue-600 underline" @click="clearEmp()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô</button>
        </div>
      </div>

      <!-- ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà -->
      <div>
        <label class="block text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (Date)</label>
        <input class="mt-1 w-full border px-3 py-2 rounded"
               type="date"
               x-model="form.date"
               @change="reloadDebounced && reloadDebounced()">
      </div>

      <!-- ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤/‡∏≠‡∏≠‡∏Å -->
      <div>
        <label class="block text-sm font-medium">Check-in Time</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="time" x-model="form.checkIn">
      </div>
      <div>
        <label class="block text-sm font-medium">Check-out Time</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="time" x-model="form.checkOut">
      </div>

      <!-- Leave Type / Status -->
      <div>
        <label class="block text-sm font-medium">Leave Type</label>
        <select class="mt-1 w-full border px-3 py-2 rounded" x-model="form.leaveType">
          <option value="">‚Äî None ‚Äî</option>
          <option>Sick</option>
          <option>Annual</option>
          <option>Business</option>
          <option>Unpaid</option>
          <option>WFH</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium">Approval Status</label>
        <select class="mt-1 w-full border px-3 py-2 rounded" x-model="form.status">
          <option>Pending</option>
          <option>Approved</option>
          <option>Rejected</option>
        </select>
      </div>

      <!-- Note -->
      <div class="md:col-span-3">
        <label class="block text-sm font-medium">Note</label>
        <input class="mt-1 w-full border px-3 py-2 rounded"
               x-model.trim="form.note"
               placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
               @keydown.enter.prevent="save()">
      </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° -->
    <div class="flex justify-end gap-2">
      <button type="button"
              @click.debounce.300ms="resetForm()"
              class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border text-gray-700 hover:bg-gray-50 transition"
              :disabled="busy?.save">‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
      <button type="button"
              @click.debounce.300ms="save()"
              class="inline-flex items-center gap-2 px-5 py-2 rounded-lg text-white font-medium transition
                     bg-blue-600 hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed"
              :disabled="busy?.save || !form.empId || !form.fullName || !form.date">
        <template x-if="!busy?.save">
          <span x-text="editingIndex===null ? 'üíæ Save' : '‚úÖ Update'"></span>
        </template>
        <template x-if="busy?.save"><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‚Ä¶</span></template>
      </button>
    </div>
  </div>

  <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î: ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
  <div class="bg-white p-6 rounded-lg shadow space-y-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 w-full md:w-auto">
        <div>
          <label class="block text-xs font-medium text-gray-600">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
          <input class="border px-3 py-2 rounded w-full"
                 placeholder="Emp ID / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏"
                 x-model.trim="filters.search"
                 @input.debounce.350ms="offset=0; reloadDebounced()">
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
          <select class="border px-3 py-2 rounded w-full"
                  x-model="filters.status"
                  @change="offset=0; reloadDebounced()">
            <option value="">‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî</option>
            <option>Pending</option>
            <option>Approved</option>
            <option>Rejected</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600">‡∏ä‡∏ô‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
          <select class="border px-3 py-2 rounded w-full"
                  x-model="filters.leaveType"
                  @change="offset=0; reloadDebounced()">
            <option value="">‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî</option>
            <option>Sick</option>
            <option>Annual</option>
            <option>Business</option>
            <option>Unpaid</option>
            <option>WFH</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" class="border px-3 py-2 rounded w-full"
                 x-model="filters.from"
                 @input.debounce.350ms="offset=0; reloadDebounced()">
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-600">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" class="border px-3 py-2 rounded w-full"
                 x-model="filters.to"
                 @input.debounce.350ms="offset=0; reloadDebounced()">
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button type="button"
                class="px-3 py-2 rounded-lg border hover:bg-gray-50"
                @click.debounce.200ms="offset=0; reload()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button type="button"
                class="px-3 py-2 rounded-lg border hover:bg-gray-50"
                @click.debounce.200ms="exportCsv()">‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
      </div>
    </div>

    <div class="text-sm text-gray-600">
      ‡∏£‡∏ß‡∏° <span class="font-medium" x-text="total"></span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      <span class="ml-2">‡∏´‡∏ô‡πâ‡∏≤: <span x-text="Math.floor(offset/limit)+1"></span></span>
    </div>

    <div class="overflow-auto border rounded-lg">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-50 text-gray-600">
          <tr>
            <th class="px-3 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
            <th class="px-3 py-2 text-left">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
            <th class="px-3 py-2 text-left">‡πÄ‡∏Ç‡πâ‡∏≤</th>
            <th class="px-3 py-2 text-left">‡∏≠‡∏≠‡∏Å</th>
            <th class="px-3 py-2 text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
            <th class="px-3 py-2 text-left">‡∏•‡∏≤</th>
            <th class="px-3 py-2 text-left">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th class="px-3 py-2 text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="row in records" :key="row.id">
            <tr class="border-t">
              <td class="px-3 py-2" x-text="row.date"></td>
              <td class="px-3 py-2">
                <div class="font-medium" x-text="row.fullName || '-'"></div>
                <div class="text-xs text-gray-500">
                  <span x-text="row.empId"></span>
                  <span class="ml-1" x-text="row.position ? '¬∑ '+row.position : ''"></span>
                </div>
              </td>
              <td class="px-3 py-2" x-text="row.checkIn || '‚Äî'"></td>
              <td class="px-3 py-2" x-text="row.checkOut || '‚Äî'"></td>
              <td class="px-3 py-2">
                <span class="px-2 py-0.5 rounded text-xs"
                      :class="{
                        'bg-yellow-100 text-yellow-800': row.status==='Pending',
                        'bg-green-100 text-green-800': row.status==='Approved',
                        'bg-red-100 text-red-800': row.status==='Rejected'
                      }"
                      x-text="row.status || '-'"></span>
              </td>
              <td class="px-3 py-2" x-text="row.leaveType || '-'"></td>
              <td class="px-3 py-2" x-text="row.note || '-'"></td>
              <td class="px-3 py-2 text-right">
                <button class="px-2 py-1 rounded border mr-1 hover:bg-gray-50"
                        @click="edit(row)">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="px-2 py-1 rounded border hover:bg-red-50 text-red-600 disabled:opacity-60"
                        :disabled="busy.remove"
                        @click.debounce.200ms="remove(row)">‡∏•‡∏ö</button>
              </td>
            </tr>
          </template>
          <tr x-show="records.length===0">
            <td colspan="8" class="px-3 py-6 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="flex items-center justify-between">
      <div class="text-xs text-gray-500">
        ‡πÅ‡∏™‡∏î‡∏á <span x-text="records.length"></span> ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span x-text="total"></span>
      </div>
      <div class="flex items-center gap-2">
        <button class="px-3 py-2 rounded border disabled:opacity-50"
                :disabled="offset===0"
                @click="offset=Math.max(0, offset-limit); reload()">‚óÄÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <button class="px-3 py-2 rounded border disabled:opacity-50"
                :disabled="offset+limit>=total"
                @click="offset=offset+limit; reload()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ñ∂Ô∏è</button>
      </div>
    </div>
  </div>
</div>

<div x-show="mainTab === 'hr' && open === 'timeclock'" x-data="timeClockApp()" x-init="init()" x-cloak>
  <div class="bg-white p-6 rounded-lg shadow space-y-4">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <h2 class="text-xl font-bold">‚è± HR ‚Äì Clock In / Clock Out</h2>
      <div class="text-sm text-gray-600">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-gray-100">
          <span class="font-medium">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
          <span class="font-mono" x-text="liveNow"></span>
        </span>
      </div>
    </div>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ/‡∏Å‡∏£‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ä‡πâ datetime ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <select class="mt-1 w-full border px-3 py-2 rounded"
                x-model="form.empId"
                @change="refreshStatus()">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Employee --</option>
          <template x-for="emp in employees" :key="emp.employeeId">
            <option :value="emp.employeeId" x-text="`${emp.employeeId} - ${emp.firstName} ${emp.lastName}`"></option>
          </template>
        </select>
        <p class="text-xs text-amber-600 mt-1" x-show="employees.length === 0">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏≤‡∏Å HR ‚Ä∫ Employee Master ‡∏Å‡πà‡∏≠‡∏ô
        </p>
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ)</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="date" x-model="form.date" @change="refreshStatus()">
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
        <div class="flex gap-2 mt-1">
          <button type="button" @click="grabGeo()"
                  class="px-3 py-2 rounded border text-gray-700 hover:bg-gray-50">
            üìç ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
          </button>
          <span class="text-sm text-gray-500 self-center truncate" x-text="form.geo || '‚Äî'"></span>
        </div>
      </div>
    </div>

    <!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ -->
    <div>
      <label class="block text-sm font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
      <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.note" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≠‡∏Å‡∏ô‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏Å‡∏•‡∏±‡∏ö‡∏ä‡πâ‡∏≤ ‡∏Ø‡∏•‡∏Ø">
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏î Clock In / Out -->
    <div class="flex flex-wrap gap-3 justify-end">
      <button type="button"
              @click="clockIn()"
              :disabled="!canClockIn"
              class="px-5 py-2 rounded-lg font-medium text-white
                     disabled:opacity-50 disabled:cursor-not-allowed
                     bg-green-600 hover:bg-green-700 transition">
        ‚úÖ Clock In
      </button>
      <button type="button"
              @click="clockOut()"
              :disabled="!canClockOut"
              class="px-5 py-2 rounded-lg font-medium text-white
                     disabled:opacity-50 disabled:cursor-not-allowed
                     bg-rose-600 hover:bg-rose-700 transition">
        üü• Clock Out
      </button>
      <button type="button"
              @click="resetForm()"
              class="px-4 py-2 rounded-lg font-medium border text-gray-700 hover:bg-gray-50 transition">
        ‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
      </button>
    </div>

    <!-- ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å inAt/outAt ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏Ñ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="border rounded-lg p-4 bg-green-50">
        <div class="text-sm text-green-700">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
        <div class="text-2xl font-semibold" x-text="statusToday.in || '‚Äî'"></div>
      </div>
      <div class="border rounded-lg p-4 bg-rose-50">
        <div class="text-sm text-rose-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
        <div class="text-2xl font-semibold" x-text="statusToday.out || '‚Äî'"></div>
      </div>
      <div class="border rounded-lg p-4 bg-blue-50">
        <div class="text-sm text-blue-700">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</div>
        <div class="text-2xl font-semibold" x-text="statusToday.totalHrs"></div>
      </div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
  <div class="bg-white p-6 rounded-lg shadow mt-6 space-y-3">
    <div class="flex flex-col md:flex-row gap-3 md:items-end md:justify-between">
      <h3 class="text-lg font-semibold">üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</h3>
      <div class="flex flex-col md:flex-row gap-3 md:items-end">
        <div>
          <label class="block text-sm">‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
          <select class="border px-3 py-2 rounded w-64"x-model="filter.emp"@change="reloadDebounced()">
            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            <template x-for="emp in employees" :key="'flt-'+emp.employeeId">
              <option :value="emp.employeeId" x-text="`${emp.employeeId} - ${emp.firstName} ${emp.lastName}`"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-sm">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <<input type="date" class="border px-3 py-2 rounded"x-model="filter.from"@input.debounce.350ms="reloadDebounced()">
        </div>
        <div>
          <label class="block text-sm">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" class="border px-3 py-2 rounded"x-model="filter.to"@input.debounce.350ms="reloadDebounced()">
        </div>
        <div class="flex items-end">
          <button @click="exportCSV()"
                  class="px-3 py-2 rounded-lg font-medium bg-indigo-600 text-white hover:bg-indigo-700 transition">
            ‚¨áÔ∏è Export CSV
          </button>
        </div>
      </div>
    </div>

    <div class="text-sm text-gray-600">
      ‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á: <span class="font-semibold" x-text="sumHoursFiltered()"></span> ‡∏ä‡∏°.
    </div>

    <div class="overflow-auto">
      <table class="min-w-full text-sm border">
        <thead class="bg-gray-100">
          <tr>
            <th class="px-3 py-2 border text-left">Date</th>
            <th class="px-3 py-2 border text-left">Employee</th>
            <th class="px-3 py-2 border text-left">Clock In (Local)</th>
            <th class="px-3 py-2 border text-left">Clock Out (Local)</th>
            <th class="px-3 py-2 border text-right">Hours</th>
            <th class="px-3 py-2 border text-left">Note</th>
            <th class="px-3 py-2 border text-left">Geo</th>
            <th class="px-3 py-2 border text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(r, i) in filtered()" :key="r.id">
            <tr class="hover:bg-gray-50">
              <td class="px-3 py-2 border" x-text="r.date"></td>
              <td class="px-3 py-2 border" x-text="`${r.empId} - ${r.empName}`"></td>
              <td class="px-3 py-2 border" x-text="displayTime(r.inAt) || '‚Äî'"></td>
              <td class="px-3 py-2 border" x-text="displayTime(r.outAt) || '‚Äî'"></td>
              <td class="px-3 py-2 border text-right" x-text="displayHoursByAt(r.inAt, r.outAt)"></td>
              <td class="px-3 py-2 border" x-text="r.note || ''"></td>
              <td class="px-3 py-2 border" x-text="r.geo || ''"></td>
              <td class="px-3 py-2 border text-center">
                <button class="text-red-600 hover:underline" @click="remove(i)">Delete</button>
              </td>
            </tr>
          </template>
          <tr x-show="filtered().length === 0">
            <td colspan="8" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- Performance Evaluation -->
<div x-show="mainTab === 'hr' && open === 'performance'" x-cloak>
<!-- Viewer Table Example for performance -->
<div class="bg-white p-6 rounded-lg shadow mt-6">
<h2 class="text-lg font-semibold mb-4">üîé Employee Records - Performance Evaluation</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<input class="border px-3 py-2 rounded w-full" placeholder="Search by Name..." type="text"/>
<select class="border px-3 py-2 rounded w-full">
<option value="">Department</option>
<option>Sales</option>
<option>Warehouse</option>
<option>HR</option>
</select>
<select class="border px-3 py-2 rounded w-full">
<option value="">Status</option>
<option>Active</option>
<option>Resigned</option>
<option>Suspended</option>
</select>
</div>
<div class="overflow-auto">
<table class="min-w-full text-sm border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="px-4 py-2 border">Emp ID</th>
<th class="px-4 py-2 border">Full Name</th>
<th class="px-4 py-2 border">Department</th>
<th class="px-4 py-2 border">Status</th>
<th class="px-4 py-2 border">Start Date</th>
<th class="px-4 py-2 border text-center">Actions</th>
</tr>
</thead>
<tbody>
<tr class="hover:bg-gray-50">
<td class="px-4 py-2 border">EMP001</td>
<td class="px-4 py-2 border">John Smith</td>
<td class="px-4 py-2 border">Sales</td>
<td class="px-4 py-2 border text-green-600 font-semibold">Active</td>
<td class="px-4 py-2 border">2022-01-15</td>
<td class="px-4 py-2 border text-center">
<button class="text-blue-600 hover:underline mr-2">Edit</button>
<button class="text-red-600 hover:underline">Delete</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<form class="grid grid-cols-1 gap-4 bg-white p-6 rounded-lg shadow">
<div><label class="block">Evaluation Period</label><select class="mt-1 w-full border px-3 py-2 rounded"><option>Annual</option><option>Semi-Annual</option><option>Quarterly</option></select></div>
<div><label class="block">Evaluator</label><input class="mt-1 w-full border px-3 py-2 rounded" type="text"/></div>
<div><label class="block">Score</label><input class="mt-1 w-full border px-3 py-2 rounded" type="number"/></div>
<div><label class="block">Remarks</label><textarea class="mt-1 w-full border px-3 py-2 rounded" rows="3"></textarea></div>
<div class="text-right"><button class="bg-indigo-600 text-white px-6 py-2 rounded" type="submit">Save</button></div>
</form>
</div>
<!-- Recruitment Tracker -->
<div x-show="mainTab === 'hr' && open === 'recruitment'" x-cloak>
<!-- Viewer Table Example for recruitment -->
<div class="bg-white p-6 rounded-lg shadow mt-6">
<h2 class="text-lg font-semibold mb-4">üîé Employee Records - Recruitment Tracker</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<input class="border px-3 py-2 rounded w-full" placeholder="Search by Name..." type="text"/>
<select class="border px-3 py-2 rounded w-full">
<option value="">Department</option>
<option>Sales</option>
<option>Warehouse</option>
<option>HR</option>
</select>
<select class="border px-3 py-2 rounded w-full">
<option value="">Status</option>
<option>Active</option>
<option>Resigned</option>
<option>Suspended</option>
</select>
</div>
<div class="overflow-auto">
<table class="min-w-full text-sm border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="px-4 py-2 border">Emp ID</th>
<th class="px-4 py-2 border">Full Name</th>
<th class="px-4 py-2 border">Department</th>
<th class="px-4 py-2 border">Status</th>
<th class="px-4 py-2 border">Start Date</th>
<th class="px-4 py-2 border text-center">Actions</th>
</tr>
</thead>
<tbody>
<tr class="hover:bg-gray-50">
<td class="px-4 py-2 border">EMP001</td>
<td class="px-4 py-2 border">John Smith</td>
<td class="px-4 py-2 border">Sales</td>
<td class="px-4 py-2 border text-green-600 font-semibold">Active</td>
<td class="px-4 py-2 border">2022-01-15</td>
<td class="px-4 py-2 border text-center">
<button class="text-blue-600 hover:underline mr-2">Edit</button>
<button class="text-red-600 hover:underline">Delete</button>
</td>
</tr>
</tbody>
</table>
</div>
</div>
<form class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-white p-6 rounded-lg shadow">
<div><label class="block">Position</label><input class="mt-1 w-full border px-3 py-2 rounded" type="text"/></div>
<div><label class="block">Openings</label><input class="mt-1 w-full border px-3 py-2 rounded" type="number"/></div>
<div><label class="block">Source</label><input class="mt-1 w-full border px-3 py-2 rounded" type="text"/></div>
<div><label class="block">Interview Date</label><input class="mt-1 w-full border px-3 py-2 rounded" type="date"/></div>
<div><label class="block">Status</label><select class="mt-1 w-full border px-3 py-2 rounded"><option>Pending</option><option>Accepted</option><option>Rejected</option></select></div>
<div class="md:col-span-2 text-right mt-4"><button class="bg-purple-600 text-white px-6 py-2 rounded" type="submit">Save</button></div>
</form>
</div>
<!-- HR Dashboard -->
<div x-show="mainTab === 'hr' && open === 'dashboard'" x-cloak>
<div class="bg-white p-6 rounded-lg shadow">
<h2 class="text-xl font-bold mb-4">üìä HR Dashboard</h2>
<p>Graphs and analytics will be shown here.</p>
<ul class="mt-4 space-y-2 text-sm text-gray-600">
<li>‚úÖ Employee by department</li>
<li>üìà OT trends</li>
<li>üìâ Leave statistics</li>
<li>üìå Performance results</li>
<li>‚ö†Ô∏è Compliance Alerts</li>
</ul>
</div>
</div>
</main>
</div>
<script>
    function showModule(id) {
      document.querySelectorAll('.module').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.getElementById('moduleTitle').innerText = document.querySelector(`button[onclick="showModule('${id}')"]`).innerText;
    }
  </script>
</div>
    <div x-show="mainTab === 'sales'" x-cloak>    
<main class="flex-grow p-6 max-w-7xl mx-auto">
<!-- Module 1: Customer Profile -->
<!-- üßë‚Äç‚öïÔ∏è Customer Profile -->

<div x-show="mainTab === 'sales' && open === 'customer'" x-data="customerApp()" x-init="init()" x-cloak>
  <div class="bg-white p-6 rounded shadow space-y-6 max-w-7xl mx-auto">

    <!-- header + search -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <h2 class="text-2xl font-semibold">üßë‚Äç‚öïÔ∏è Customer Profile</h2>

      <div class="relative w-full md:w-96">
        <input class="w-full border rounded px-3 py-2 pr-10" placeholder="üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠ National ID"
               x-model.trim="searchQuery" @input="onSearchInput()" @keydown.escape="showSug=false">
        <button class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500" @click="searchQuery='';showSug=false">‚úï</button>

        <!-- dropdown suggestions -->
        <div class="absolute z-20 mt-1 w-full bg-white border rounded shadow max-h-64 overflow-auto" x-show="showSug">
          <template x-for="c in searchSuggestions" :key="c.code">
            <div class="px-3 py-2 hover:bg-gray-50 cursor-pointer"
                 @click="pickSuggestion(c)">
              <div class="text-sm font-medium" x-text="`${c.code} ‚Äî ${c.firstName} ${c.lastName}`"></div>
              <div class="text-xs text-gray-500" x-text="`ID: ${c.nationalId || '-'}`"></div>
            </div>
          </template>
          <div class="px-3 py-2 text-sm text-gray-500" x-show="searchSuggestions.length===0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </div>
      </div>
    </div>

    <!-- form -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">

      <!-- auto code -->
      <div>
        <label class="block text-sm font-medium">‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
        <input class="mt-1 w-full border px-3 py-2 rounded bg-gray-100" x-model="form.code" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.firstName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏à‡∏°‡∏à‡∏¥‡∏£‡∏≤">
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.lastName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏≠‡∏•">
      </div>

      <div>
        <label class="block text-sm font-medium">‡πÄ‡∏û‡∏®</label>
        <select class="mt-1 w-full border px-3 py-2 rounded" x-model="form.gender">
          <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
          <option>‡∏ä‡∏≤‡∏¢</option><option>‡∏´‡∏ç‡∏¥‡∏á</option><option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="date" x-model="form.birthday" @change="updateAge()">
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <input class="mt-1 w-full border px-3 py-2 rounded bg-gray-100" x-model="form.age" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.phone">
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input class="mt-1 w-full border px-3 py-2 rounded" type="email" x-model.trim="form.email">
      </div>

      <div>
        <label class="block text-sm font-medium">National ID</label>
        <input class="mt-1 w-full border px-3 py-2 rounded"
               :class="{'border-red-500': form.nationalId && form.nationalId.length !== 13}"
               x-model="form.nationalId"
               maxlength="13" placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ 13 ‡∏´‡∏•‡∏±‡∏Å"
               @input="form.nationalId=form.nationalId.replace(/\D/g,'').slice(0,13)">
        <p class="text-xs mt-1" :class="(form.nationalId && form.nationalId.length !== 13)?'text-red-600':'text-gray-500'">
          ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç 13 ‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô
        </p>
      </div>

      <!-- address line -->
      <div class="md:col-span-3 grid grid-cols-1 md:grid-cols-6 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô)</label>
          <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.addr.no">
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏ñ‡∏ô‡∏ô</label>
          <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.addr.road">
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏ã‡∏≠‡∏¢</label>
          <input class="mt-1 w-full border px-3 py-2 rounded" x-model.trim="form.addr.soi">
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
          <select class="mt-1 w-full border px-3 py-2 rounded" x-model="addr.provinceId" @change="onProvinceChange()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î --</option>
            <template x-for="p in provinces" :key="p.id">
              <option :value="p.id" x-text="p.name_th"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
          <select class="mt-1 w-full border px-3 py-2 rounded" x-model="addr.amphureId" @change="onAmphureChange()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>
            <template x-for="a in amphures" :key="a.id">
              <option :value="a.id" x-text="a.name_th"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏ï‡∏≥‡∏ö‡∏•</label>
          <select class="mt-1 w-full border px-3 py-2 rounded" x-model="addr.tambonId" @change="applyTambonZip()">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>
            <template x-for="t in tambons" :key="t.id">
              <option :value="t.id" x-text="t.name_th"></option>
            </template>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
          <input class="mt-1 w-full border px-3 py-2 rounded bg-gray-100" x-model="form.addr.postcode" readonly>
        </div>
      </div>

      <!-- medical history -->
      <div class="md:col-span-3">
        <h3 class="text-md font-semibold mb-2">üìã ‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
          <template x-for="opt in diseaseOptions" :key="opt">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="rounded" :value="opt" x-model="form.medical.diseases">
              <span x-text="opt"></span>
            </label>
          </template>
        </div>
        <input class="mt-2 w-full border px-3 py-2 rounded" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" x-model.trim="form.medical.diseaseOther">
      </div>

      <div class="md:col-span-3">
        <h3 class="text-md font-semibold mb-2">üíä ‡πÅ‡∏û‡πâ‡∏¢‡∏≤/‡∏™‡∏≤‡∏£ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠)</h3>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
          <template x-for="opt in allergyOptions" :key="opt">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" class="rounded" :value="opt" x-model="form.medical.allergies">
              <span x-text="opt"></span>
            </label>
          </template>
        </div>
        <input class="mt-2 w-full border px-3 py-2 rounded" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" x-model.trim="form.medical.allergyOther">
      </div>

      <!-- actions -->
      <div class="md:col-span-3 flex flex-wrap justify-end gap-2">
        <button type="button" @click="resetForm()"
                class="px-4 py-2 rounded-lg font-medium border text-gray-700 hover:bg-gray-50">
          ‚ôªÔ∏è ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        </button>
        <button type="button" @click="save()"
                :disabled="!canSave()"
                class="px-5 py-2 rounded-lg font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed"
                :class="editingIndex===null ? 'bg-blue-600 hover:bg-blue-700' : 'bg-amber-600 hover:bg-amber-700'">
          <span x-text="editingIndex===null ? 'üíæ Save' : 'üìù Update'"></span>
        </button>
      </div>
    </div>

    <!-- records table -->
    <div class="border-t pt-4">
      <h3 class="text-lg font-semibold mb-2">üìö ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</h3>

      <div class="flex flex-wrap gap-3 mb-3">
        <input class="border rounded px-3 py-2 w-full md:w-72" placeholder="‡∏Å‡∏£‡∏≠‡∏á: ‡∏ä‡∏∑‡πà‡∏≠/‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡∏´‡∏±‡∏™/ID"
               x-model.trim="filter.keyword">
        <select class="border rounded px-3 py-2" x-model="filter.provinceId">
          <option value="">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <template x-for="p in provinces" :key="'flt-'+p.id">
            <option :value="p.id" x-text="p.name_th"></option>
          </template>
        </select>
      </div>

      <div class="overflow-auto">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border text-left">‡∏£‡∏´‡∏±‡∏™</th>
              <th class="px-2 py-2 border text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
              <th class="px-2 py-2 border text-left">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
              <th class="px-2 py-2 border text-left">‡∏≠‡∏≤‡∏¢‡∏∏</th>
              <th class="px-2 py-2 border text-left">‡πÄ‡∏û‡∏®</th>
              <th class="px-2 py-2 border text-left">‡πÇ‡∏ó‡∏£</th>
              <th class="px-2 py-2 border text-left">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
              <th class="px-2 py-2 border text-left">National ID</th>
              <th class="px-2 py-2 border text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(c, i) in filteredCustomers()" :key="c.code + i">
              <tr class="hover:bg-gray-50">
                <td class="px-2 py-2 border" x-text="c.code"></td>
                <td class="px-2 py-2 border" x-text="c.firstName"></td>
                <td class="px-2 py-2 border" x-text="c.lastName"></td>
                <td class="px-2 py-2 border" x-text="c.age || '-'"></td>
                <td class="px-2 py-2 border" x-text="c.gender || '-'"></td>
                <td class="px-2 py-2 border" x-text="c.phone || '-'"></td>
                <td class="px-2 py-2 border" x-text="(c.addr?.provinceName)||'-'"></td>
                <td class="px-2 py-2 border" x-text="c.nationalId || '-'"></td>
                <td class="px-2 py-2 border text-center space-x-3">
                  <button class="text-blue-600 hover:underline" @click="edit(i)">Edit</button>
                  <button class="text-red-600 hover:underline" @click="remove(i)">Delete</button>
                </td>
              </tr>
            </template>
            <tr x-show="filteredCustomers().length===0">
              <td colspan="9" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
</div>


<!-- Module 2: Quotation & Package Selection -->
<!-- üìù Quotation & Package Selection (with Confirm) -->
<div x-show="mainTab === 'sales' && open === 'quotation'" x-data="quotationApp()" x-init="init()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <h2 class="text-2xl font-semibold">üìù Quotation & Package Selection</h2>

      <div class="grid grid-cols-1 md:grid-cols-4 gap-3 w-full md:w-auto items-end">
        <div>
          <label class="block text-sm font-medium">Quotation No.</label>
          <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 font-mono" x-model="form.qNo" readonly>
        </div>
        <div>
          <label class="block text-sm font-medium">Quotation Date</label>
          <input type="date" class="mt-1 w-full border rounded px-3 py-2" x-model="form.qDate" @change="previewQuotationNo()" :disabled="locked()">
        </div>

        <!-- Status badge -->
        <div class="md:col-span-1">
          <label class="block text-sm font-medium">Status</label>
          <div class="mt-1">
            <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-sm"
                  :class="locked() ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'">
              <span class="w-2 h-2 rounded-full" :class="locked() ? 'bg-emerald-600' : 'bg-gray-400'"></span>
              <span x-text="locked() ? 'Confirmed' : 'Draft'"></span>
            </span>
          </div>
        </div>

        <div class="flex items-end gap-2 md:justify-end">
          <button class="px-4 py-2 rounded-lg font-medium border text-gray-700 hover:bg-gray-50"
                  @click="resetForm()">‚ôªÔ∏è New</button>

          <button class="px-4 py-2 rounded-lg font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed"
                  :class="editingIndex===null ? 'bg-blue-600 hover:bg-blue-700' : 'bg-amber-600 hover:bg-amber-700'"
                  @click="save()" :disabled="locked()">
            <span x-text="editingIndex===null ? 'üíæ Save' : 'üìù Update'"></span>
          </button>

          <button class="px-4 py-2 rounded-lg font-semibold text-white bg-emerald-600 hover:bg-emerald-700
                         disabled:opacity-50 disabled:cursor-not-allowed"
                  @click="confirmQuote()" :disabled="!canConfirm()">
            ‚úÖ Confirm
          </button>
        </div>
      </div>
    </div>

    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏û‡∏¥‡∏°‡∏û‡πå ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏´‡∏£‡∏∑‡∏≠ National ID)</label>
        <div class="relative">
          <input class="mt-1 w-full border rounded px-3 py-2 pr-10"
                 placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏à‡∏°‡∏à‡∏¥‡∏£‡∏≤  ‡∏´‡∏£‡∏∑‡∏≠  1103700xxxxx"
                 x-model.trim="customerSearch" @input="onCustomerSearch()" @keydown.escape="showSug=false" :disabled="locked()">
          <button class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500"
                  @click="customerSearch=''; showSug=false" :disabled="locked()">‚úï</button>

          <!-- dropdown suggestions -->
          <div class="absolute z-30 mt-1 w-full bg-white border rounded shadow max-h-64 overflow-auto" x-show="showSug">
            <template x-for="c in customerSug" :key="c.code">
              <div class="px-3 py-2 hover:bg-gray-50 cursor-pointer"
                   @click="pickCustomer(c)">
                <div class="text-sm font-medium" x-text="`${c.code} ‚Äî ${c.firstName} ${c.lastName}`"></div>
                <div class="text-xs text-gray-500" x-text="`ID: ${c.nationalId || '-'}  ‚Ä¢  Tel: ${c.phone || '-'}`"></div>
              </div>
            </template>
            <div class="px-3 py-2 text-sm text-gray-500" x-show="customerSug.length===0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
          </div>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium">Customer Code</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.customer.code" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" :disabled="locked()">
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" :disabled="locked()">
      </div>
      <div>
        <label class="block text-sm font-medium">National ID</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.customer.nationalId" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.customer.age" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.phone" :disabled="locked()">
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.email" :disabled="locked()">
      </div>

      <div class="md:col-span-3">
        <label class="block text-sm font-medium">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.symptoms" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°‡∏ã‡∏µ‡πà 36 ‡∏°‡∏≤ 2 ‡∏ß‡∏±‡∏ô" :disabled="locked()">
      </div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ -->
    <div>
      <h3 class="text-lg font-semibold mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>

      <!-- datalist -->
      <datalist id="serviceList">
        <option value="‡∏ï‡∏£‡∏ß‡∏à/‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤"></option>
        <option value="‡πÄ‡∏≠‡πá‡∏Å‡∏ã‡πÄ‡∏£‡∏¢‡πå"></option>
        <option value="‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô/‡∏Ç‡∏±‡∏î‡∏ü‡∏±‡∏ô"></option>
        <option value="‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô (‡∏Ñ‡∏≠‡∏°‡πÇ‡∏û‡∏™‡∏¥‡∏ï)"></option>
        <option value="‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô"></option>
        <option value="‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î"></option>
        <option value="‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô ‡∏´‡∏ô‡πâ‡∏≤"></option>
        <option value="‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô ‡∏Å‡∏£‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏¢"></option>
        <option value="‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô ‡∏Å‡∏£‡∏≤‡∏°‡πÉ‡∏´‡∏ç‡πà"></option>
        <option value="‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ü‡∏±‡∏ô (PFM)"></option>
        <option value="‡∏Ñ‡∏£‡∏≠‡∏ö‡∏ü‡∏±‡∏ô (Zirconia)"></option>
        <option value="‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏ü‡∏±‡∏ô (Bridge)"></option>
        <option value="‡∏ß‡∏µ‡πÄ‡∏ô‡∏µ‡∏¢‡∏£‡πå"></option>
        <option value="‡∏ü‡∏≠‡∏Å‡∏™‡∏µ‡∏ü‡∏±‡∏ô (‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å)"></option>
        <option value="‡∏ü‡∏≠‡∏Å‡∏™‡∏µ‡∏ü‡∏±‡∏ô (‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡πâ‡∏≤‡∏ô)"></option>
        <option value="‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏° (Implant)"></option>
        <option value="‡∏à‡∏±‡∏î‡∏ü‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏∞"></option>
        <option value="‡∏à‡∏±‡∏î‡∏ü‡∏±‡∏ô‡πÉ‡∏™"></option>
        <option value="‡∏£‡∏µ‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå"></option>
      </datalist>

      <datalist id="toothZoneList">
        <option value="‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏≤‡∏Å"></option>
        <option value="UR (‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)"></option>
        <option value="UL (‡∏ã‡πâ‡∏≤‡∏¢‡∏ö‡∏ô)"></option>
        <option value="LL (‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á)"></option>
        <option value="LR (‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á)"></option>
        <template x-for="n in fdiTeeth" :key="'t'+n"><option :value="n"></option></template>
      </datalist>

      <div class="overflow-auto">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border text-center w-14">No.</th>
              <th class="px-2 py-2 border">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
              <th class="px-2 py-2 border">‡∏ã‡∏µ‡πà‡∏ü‡∏±‡∏ô/‡πÇ‡∏ã‡∏ô</th>
              <th class="px-2 py-2 border text-right w-28">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="px-2 py-2 border text-right w-36">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (THB)</th>
              <th class="px-2 py-2 border text-right w-36">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (THB)</th>
              <th class="px-2 py-2 border text-right w-36">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
              <th class="px-2 py-2 border text-center w-20">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, i) in form.items" :key="i">
              <tr class="hover:bg-gray-50">
                <td class="px-2 py-2 border text-center" x-text="i+1"></td>
                <td class="px-2 py-2 border">
                  <input list="serviceList" class="w-full border rounded px-2 py-1"
                         placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£" x-model.trim="row.service" :disabled="locked()">
                </td>
                <td class="px-2 py-2 border">
                  <input list="toothZoneList" class="w-full border rounded px-2 py-1"
                         placeholder="‡πÄ‡∏ä‡πà‡∏ô 36 / UR / ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏≤‡∏Å" x-model.trim="row.tooth" :disabled="locked()">
                </td>
                <td class="px-2 py-2 border text-right">
                  <input type="number" min="1" class="w-full border rounded px-2 py-1 text-right"
                         x-model.number="row.qty" :disabled="locked()">
                </td>
                <td class="px-2 py-2 border text-right">
                  <input type="number" min="0" step="0.01" class="w-full border rounded px-2 py-1 text-right"
                         x-model.number="row.price" :disabled="locked()">
                </td>
                <td class="px-2 py-2 border text-right">
                  <input type="number" min="0" step="0.01" class="w-full border rounded px-2 py-1 text-right"
                         x-model.number="row.discount" :disabled="locked()">
                </td>
                <td class="px-2 py-2 border text-right font-medium" x-text="formatMoney(rowTotal(row))"></td>
                <td class="px-2 py-2 border text-center">
                  <button class="text-red-600 hover:underline" @click="removeRow(i)" :disabled="locked()">‡∏•‡∏ö</button>
                </td>
              </tr>
            </template>
            <tr x-show="form.items.length===0">
              <td colspan="8" class="text-center text-gray-500 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
            </tr>
          </tbody>
        </table>
      </div>

      <button class="mt-2 bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700"
              @click="addRow()" :disabled="locked()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <!-- Totals -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium">‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 text-right" :value="formatMoney(sumBefore())" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏£‡∏ß‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 text-right" :value="formatMoney(sumDiscount())" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 text-right font-semibold" :value="formatMoney(netTotal())" readonly>
      </div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Quotation ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <div class="border-t pt-4">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h3 class="text-lg font-semibold">üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</h3>
        <div class="flex flex-wrap gap-2">
          <input class="border rounded px-3 py-2 w-60" placeholder="‡∏Å‡∏£‡∏≠‡∏á: Q No./‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/ID"
                 x-model.trim="flt.keyword">
          <input type="date" class="border rounded px-3 py-2" x-model="flt.from">
          <input type="date" class="border rounded px-3 py-2" x-model="flt.to">
          <input type="number" min="0" class="border rounded px-3 py-2 w-36" placeholder="Net ‚â•"
                 x-model.number="flt.minNet">
        </div>
      </div>

      <div class="overflow-auto mt-3">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border text-left">Quotation No.</th>
              <th class="px-2 py-2 border text-left">Date</th>
              <th class="px-2 py-2 border text-left">Customer</th>
              <th class="px-2 py-2 border text-right">Items</th>
              <th class="px-2 py-2 border text-right">Net Total (THB)</th>
              <th class="px-2 py-2 border text-left">Status</th>
              <th class="px-2 py-2 border text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- ‡πÉ‡∏ä‡πâ qNo ‡πÄ‡∏õ‡πá‡∏ô key/‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏ö‡∏™‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á -->
            <template x-for="q in filteredQuotations()" :key="q.qNo">
              <tr class="hover:bg-gray-50 align-top">
                <td class="px-2 py-2 border"><div class="font-medium" x-text="q.qNo"></div></td>
                <td class="px-2 py-2 border" x-text="q.qDate"></td>
                <td class="px-2 py-2 border">
                  <div x-text="`${q.customer.firstName||''} ${q.customer.lastName||''}`.trim() || '-'"></div>
                  <div class="text-xs text-gray-500" x-text="q.customer.nationalId || ''"></div>
                </td>
                <td class="px-2 py-2 border text-right" x-text="q.items.length"></td>
                <td class="px-2 py-2 border text-right" x-text="formatMoney(q.net)"></td>
                <td class="px-2 py-2 border">
                  <span class="inline-flex items-center gap-2 px-2 py-0.5 rounded-full text-xs"
                        :class="q.status==='Confirmed' ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'">
                    <span class="w-1.5 h-1.5 rounded-full"
                          :class="q.status==='Confirmed' ? 'bg-emerald-600' : 'bg-gray-400'"></span>
                    <span x-text="q.status || 'Draft'"></span>
                  </span>
                </td>
                <td class="px-2 py-2 border text-center space-x-3">
                  <button class="text-blue-600 hover:underline" @click="editByNo(q.qNo)">
                    <span x-text="q.status==='Confirmed' ? 'View' : 'View/Edit'"></span>
                  </button>
                  <button class="text-red-600 hover:underline" @click="deleteByNo(q.qNo)">Delete</button>
                </td>
              </tr>
            </template>
            <tr x-show="filteredQuotations().length===0">
              <td colspan="7" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- üì¶ Sale Order -->
<div x-show="mainTab === 'sales' && open === 'saleorder'" x-data="saleOrderApp()" x-init="init()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">

    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <h2 class="text-2xl font-semibold">üì¶ Sale Order</h2>

      <div class="grid grid-cols-1 md:grid-cols-5 gap-3 w-full md:w-auto items-end">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium">Sale Order No.</label>
          <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 font-mono" x-model="form.soNo" readonly>
        </div>
        <div>
          <label class="block text-sm font-medium">SO Date</label>
          <input type="date" class="mt-1 w-full border rounded px-3 py-2" x-model="form.soDate" :disabled="headerLocked">
        </div>
        <div class="md:col-span-2 flex items-end gap-2 md:justify-end">
          <button type="button" class="px-3 py-2 rounded-lg border text-gray-700 hover:bg-gray-50" @click="openPending()">üïí Pending</button>
          <button type="button" class="px-3 py-2 rounded-lg border text-gray-700 hover:bg-gray-50" @click="resetForm()">‚ôªÔ∏è New</button>
          <button type="button" class="px-4 py-2 rounded-lg font-semibold text-white disabled:opacity-50 disabled:cursor-not-allowed"
                  :class="editingIndex===null ? 'bg-blue-600 hover:bg-blue-700' : 'bg-amber-600 hover:bg-amber-700'"
                  :disabled="!canSave()" @click="save()">
            <span x-text="editingIndex===null ? 'üíæ Save' : 'üìù Update'"></span>
          </button>
        </div>
      </div>
    </div>

    <!-- Customer (headerLocked ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å Confirmed Quotation) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium">Ref. Quotation</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.refQuotationNo" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">Customer Code</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.customer.code" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">National ID</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.customer.nationalId" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">‡∏ä‡∏∑‡πà‡∏≠</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.firstName" :readonly="headerLocked">
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.lastName" :readonly="headerLocked">
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏≤‡∏¢‡∏∏</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100" x-model="form.customer.age" readonly>
      </div>

      <div>
        <label class="block text-sm font-medium">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.phone" :readonly="headerLocked">
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
        <input type="email" class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.customer.email" :readonly="headerLocked">
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
        <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.symptoms" :readonly="headerLocked">
      </div>
    </div>

    <!-- Items -->
    <div>
      <h3 class="text-lg font-semibold mb-2">üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</h3>
      <div class="overflow-auto">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border text-center w-14">No.</th>
              <th class="px-2 py-2 border">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
              <th class="px-2 py-2 border">‡∏ã‡∏µ‡πà‡∏ü‡∏±‡∏ô/‡πÇ‡∏ã‡∏ô</th>
              <th class="px-2 py-2 border text-right w-28">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
              <th class="px-2 py-2 border text-right w-36">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
              <th class="px-2 py-2 border text-right w-36">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th>
              <th class="px-2 py-2 border text-right w-36">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
              <th class="px-2 py-2 border text-center w-20">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, i) in form.items" :key="i">
              <tr class="hover:bg-gray-50">
                <td class="px-2 py-2 border text-center" x-text="i+1"></td>
                <td class="px-2 py-2 border"><input class="w-full border rounded px-2 py-1" x-model.trim="row.service" :readonly="headerLocked"></td>
                <td class="px-2 py-2 border"><input class="w-full border rounded px-2 py-1" x-model.trim="row.tooth" :readonly="headerLocked"></td>
                <td class="px-2 py-2 border text-right"><input type="number" min="1" class="w-full border rounded px-2 py-1 text-right" x-model.number="row.qty" :readonly="headerLocked"></td>
                <td class="px-2 py-2 border text-right"><input type="number" min="0" step="0.01" class="w-full border rounded px-2 py-1 text-right" x-model.number="row.price" :readonly="headerLocked"></td>
                <td class="px-2 py-2 border text-right"><input type="number" min="0" step="0.01" class="w-full border rounded px-2 py-1 text-right" x-model.number="row.discount" :readonly="headerLocked"></td>
                <td class="px-2 py-2 border text-right font-medium" x-text="fmt(rowTotal(row))"></td>
                <td class="px-2 py-2 border text-center">
                  <button class="text-red-600 hover:underline" @click="removeRow(i)" :disabled="headerLocked">‡∏•‡∏ö</button>
                </td>
              </tr>
            </template>
            <tr x-show="form.items.length===0">
              <td colspan="8" class="text-center text-gray-500 p-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
            </tr>
          </tbody>
        </table>
      </div>
      <button class="mt-2 bg-emerald-600 text-white px-3 py-2 rounded hover:bg-emerald-700" @click="addRow()" :disabled="headerLocked">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <!-- Totals -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium">‡∏£‡∏ß‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 text-right" :value="fmt(sumBefore())" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏£‡∏ß‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 text-right" :value="fmt(sumDiscount())" readonly>
      </div>
      <div>
        <label class="block text-sm font-medium">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</label>
        <input class="mt-1 w-full border rounded px-3 py-2 bg-gray-100 text-right font-semibold" :value="fmt(netTotal())" readonly>
      </div>
    </div>

    <!-- Payment -->
    <div class="space-y-3">
      <h3 class="text-lg font-semibold">üí≥ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</label>
          <select class="mt-1 w-full border rounded px-3 py-2" x-model="form.payment.method">
            <option value="FULL">‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</option>
            <option value="INST">‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏≠‡∏ö</option>
          </select>
        </div>
        <div x-show="form.payment.method==='INST'">
          <label class="block text-sm font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö</label>
          <input type="number" min="2" max="12" class="mt-1 w-full border rounded px-3 py-2" x-model.number="form.payment.rounds" @change="buildInstallments()">
        </div>
        <div>
          <label class="block text-sm font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏à‡∏≤‡∏Å‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
          <input class="mt-1 w-full border rounded px-3 py-2" x-model.trim="form.doctorNote">
        </div>
      </div>

      <!-- Full payment controls -->
      <div x-show="form.payment.method==='FULL'" class="flex flex-wrap items-center gap-3">
        <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full text-sm"
              :class="form.payment.full.paid ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'">
          <span class="w-2 h-2 rounded-full" :class="form.payment.full.paid ? 'bg-emerald-600' : 'bg-gray-400'"></span>
          <span x-text="form.payment.full.paid ? ('Paid ' + dateShort(form.payment.full.paidAt)) : 'Unpaid'"></span>
        </span>

        <button type="button" class="px-4 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700"
                @click="receivePayment('FULL')"
                x-show="!form.payment.full.paid">
          ‚úÖ ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        </button>

        <button type="button" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                @click="printReceipt('FULL')"
                :disabled="!form.payment.full.paid">
          üßæ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (PDF)
        </button>

        <div class="text-xs text-gray-500" x-show="form.payment.full.receiptNo">RC: <span x-text="form.payment.full.receiptNo"></span></div>
      </div>

      <!-- Installments table -->
      <div x-show="form.payment.method==='INST'">
        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-600">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö <b x-text="fmt(netTotal())"></b></div>
          <button class="px-3 py-1 rounded border hover:bg-gray-50 text-sm" @click="splitEven()">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤ ‡πÜ ‡∏Å‡∏±‡∏ô</button>
        </div>
        <div class="overflow-auto mt-2">
          <table class="min-w-full text-sm border">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-2 py-2 border text-center w-16">‡∏£‡∏≠‡∏ö</th>
                <th class="px-2 py-2 border text-right w-36">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                <th class="px-2 py-2 border text-left">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                <th class="px-2 py-2 border text-center">‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞/‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="(ins,i) in form.payment.installments" :key="i">
                <tr>
                  <td class="px-2 py-2 border text-center" x-text="i+1"></td>
                  <td class="px-2 py-2 border text-right">
                    <input type="number" min="0" step="0.01" class="w-full border rounded px-2 py-1 text-right"
                           x-model.number="ins.amount" @input="validateInstallments()">
                  </td>
                  <td class="px-2 py-2 border">
                    <span class="inline-flex items-center gap-2 px-2 py-0.5 rounded-full text-xs"
                          :class="ins.paid ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'">
                      <span class="w-1.5 h-1.5 rounded-full" :class="ins.paid ? 'bg-emerald-600' : 'bg-gray-400'"></span>
                      <span x-text="ins.paid ? ('Paid ' + dateShort(ins.paidAt)) : 'Unpaid'"></span>
                    </span>
                    <div class="text-xs text-gray-500" x-show="ins.receiptNo">RC: <span x-text="ins.receiptNo"></span></div>
                  </td>
                  <td class="px-2 py-2 border text-center">
                    <template x-if="!ins.paid">
                      <button class="px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700"
                              @click="receivePayment('INST', i)">‚úÖ ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞</button>
                    </template>
                    <template x-if="ins.paid">
                      <button class="text-indigo-600 hover:underline"
                              @click="printReceipt('INST', i)">üßæ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    </template>
                  </td>
                </tr>
              </template>
              <tr>
                <td class="px-2 py-2 border font-medium text-right" colspan="3">‡∏£‡∏ß‡∏°</td>
                <td class="px-2 py-2 border text-right font-semibold" x-text="fmt(sumInstallments())"></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="text-sm mt-1" :class="sumInstallments()===netTotal() ? 'text-green-600' : 'text-red-600'">
          <span x-show="sumInstallments()===netTotal()">‚úÖ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
          <span x-show="sumInstallments()!==netTotal()">‚ö†Ô∏è ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</span>
        </p>
      </div>
    </div>

    <!-- Records -->
    <div class="border-t pt-4">
      <div class="flex items-center justify-between flex-wrap gap-3">
        <h3 class="text-lg font-semibold">üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Sale Order (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß)</h3>
        <div class="flex flex-wrap gap-2">
          <input class="border rounded px-3 py-2 w-60" placeholder="‡∏Å‡∏£‡∏≠‡∏á: SO No./‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/ID" x-model.trim="flt.keyword">
          <input type="date" class="border rounded px-3 py-2" x-model="flt.from">
          <input type="date" class="border rounded px-3 py-2" x-model="flt.to">
          <input type="number" min="0" class="border rounded px-3 py-2 w-36" placeholder="Net ‚â•" x-model.number="flt.minNet">
        </div>
      </div>

      <div class="overflow-auto mt-3">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border text-left">SO No.</th>
              <th class="px-2 py-2 border text-left">Date</th>
              <th class="px-2 py-2 border text-left">Customer</th>
              <th class="px-2 py-2 border text-right">Net (THB)</th>
              <th class="px-2 py-2 border text-left">Payment</th>
              <th class="px-2 py-2 border text-left">Ref QNo.</th>
              <th class="px-2 py-2 border text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="r in filteredSO()" :key="r.soNo">
              <tr class="hover:bg-gray-50 align-top">
                <td class="px-2 py-2 border font-medium" x-text="r.soNo"></td>
                <td class="px-2 py-2 border" x-text="r.soDate"></td>
                <td class="px-2 py-2 border">
                  <div x-text="`${r.customer.firstName||''} ${r.customer.lastName||''}`.trim() || '-'"></div>
                  <div class="text-xs text-gray-500" x-text="r.customer.nationalId || ''"></div>
                </td>
                <td class="px-2 py-2 border text-right" x-text="fmt(r.net)"></td>
                <td class="px-2 py-2 border">
                  <template x-if="r.payment.method==='FULL'">
                    <span x-text="r.payment.full?.paid ? ('Full ‚Äî Paid ' + dateShort(r.payment.full.paidAt)) : 'Full ‚Äî Unpaid'"></span>
                  </template>
                  <template x-if="r.payment.method==='INST'">
                    <span x-text="`Installments (${(r.payment.installments||[]).filter(x=>x.paid).length}/${(r.payment.installments||[]).length})`"></span>
                  </template>
                </td>
                <td class="px-2 py-2 border" x-text="r.refQuotationNo || '-'"></td>
                <td class="px-2 py-2 border text-center space-x-3">
                  <button class="text-blue-600 hover:underline" @click="editByNo(r.soNo)">View/Edit</button>
                  <button class="text-red-600 hover:underline" @click="deleteByNo(r.soNo)">Delete</button>
                </td>
              </tr>
            </template>
            <tr x-show="filteredSO().length===0">
              <td colspan="7" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pending Modal -->
  <div x-show="showPending" class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50" @click.self="showPending=false">
    <div class="bg-white rounded-lg shadow max-w-3xl w-full p-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">üïí Quotation Pending (Confirmed ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á SO)</h3>
        <button class="px-2 py-1 rounded border hover:bg-gray-50" @click="showPending=false">‚úï</button>
      </div>
      <div class="overflow-auto max-h-[60vh]">
        <table class="min-w-full text-sm border">
          <thead class="bg-gray-100">
            <tr>
              <th class="px-2 py-2 border text-left">Quotation No.</th>
              <th class="px-2 py-2 border text-left">Date</th>
              <th class="px-2 py-2 border text-left">Customer</th>
              <th class="px-2 py-2 border text-right">Net</th>
              <th class="px-2 py-2 border text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="q in pendingQuotations()" :key="q.qNo">
              <tr class="hover:bg-gray-50">
                <td class="px-2 py-2 border" x-text="q.qNo"></td>
                <td class="px-2 py-2 border" x-text="q.qDate"></td>
                <td class="px-2 py-2 border" x-text="`${q.customer.firstName||''} ${q.customer.lastName||''}`.trim()"></td>
                <td class="px-2 py-2 border text-right" x-text="fmt(q.net)"></td>
                <td class="px-2 py-2 border text-center">
                  <button class="px-3 py-1 rounded bg-emerald-600 text-white hover:bg-emerald-700" @click="createFromQuotation(q.qNo)">Create SO</button>
                </td>
              </tr>
            </template>
            <tr x-show="pendingQuotations().length===0">
              <td colspan="5" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤‡∏á</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Module 4: Contact & Follow-up Log -->
<div class="module" id="module-contact" x-show="mainTab === 'sales' && open === 'contact'" x-cloak>
<div class="bg-white p-6 rounded shadow">
<h2 class="text-2xl font-semibold mb-4">üìû Contact &amp; Follow-up Log</h2>
<form class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
<input class="w-full border rounded p-2" type="date"/>
</div>
<div>
<label>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
<select class="w-full border rounded p-2">
<option>‡πÇ‡∏ó‡∏£</option>
<option>Line</option>
<option>Email</option>
<option>Walk-in</option>
<option>Facebook</option>
</select>
</div>
<div class="md:col-span-2">
<label>‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏π‡∏î‡∏Ñ‡∏∏‡∏¢</label>
<textarea class="w-full border rounded p-2"></textarea>
</div>
<div class="md:col-span-2">
<label>‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö</label>
<textarea class="w-full border rounded p-2"></textarea>
</div>
<div>
<label>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
<input class="w-full border rounded p-2" type="date"/>
</div>
<div>
<label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
<select class="w-full border rounded p-2">
<option>‡∏£‡∏≠‡∏ï‡∏≠‡∏ö</option>
<option>‡∏ô‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß</option>
<option>‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</option>
<option>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
</select>
</div>
</form>
<div class="mt-4">
<button class="bg-primary text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</button>
</div>
<div class="mt-6">
<h3 class="text-lg font-semibold mb-2">üìö ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
<table class="w-full table-auto text-sm border">
<thead class="bg-gray-200">
<tr>
<th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="p-2">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
<th class="p-2">‡∏™‡∏£‡∏∏‡∏õ</th>
<th class="p-2">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
<th class="p-2">‡∏ß‡∏±‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</th>
<th class="p-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
</tr>
</thead>
<tbody>
<tr><td class="text-center p-4 text-gray-500" colspan="6">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<!-- Module 5: Appointment & Scheduling -->
<div class="module" id="module-appointment" x-show="mainTab === 'sales' && open === 'appointment'" x-cloak>
<div class="bg-white p-6 rounded shadow">
<h2 class="text-2xl font-semibold mb-4">üìÜ Appointment &amp; Scheduling</h2>
<form class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6" id="appointmentForm">
<div>
<label class="block mb-1 font-medium" for="apptDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î</label>
<input class="w-full border rounded p-2" id="apptDate" required="" type="date">
</input></div>
<div>
<label class="block mb-1 font-medium" for="apptTime">‡πÄ‡∏ß‡∏•‡∏≤</label>
<input class="w-full border rounded p-2" id="apptTime" required="" type="time">
</input></div>
<div>
<label class="block mb-1 font-medium" for="branch">‡∏™‡∏≤‡∏Ç‡∏≤</label>
<input class="w-full border rounded p-2" id="branch" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤" required="" type="text">
</input></div>
<div>
<label class="block mb-1 font-medium" for="dentist">‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</label>
<select class="w-full border rounded p-2" id="dentist" required="">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå --</option>
<option>‡∏ó‡∏û. ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</option>
<option>‡∏ó‡∏û. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á</option>
<option>‡∏ó‡∏û. ‡∏Å‡∏¥‡∏ï‡∏ï‡∏¥</option>
<option>‡∏ó‡∏û. ‡∏≠‡∏£‡∏¥‡∏¢‡∏∞</option>
</select>
</div>
<div class="md:col-span-2">
<label class="block mb-1 font-medium" for="services">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î</label>
<input class="w-full border rounded p-2" id="services" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô, ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô" required="" type="text">
</input></div>
<div class="md:col-span-2">
<label class="block mb-1 font-medium" for="notes">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
<textarea class="w-full border rounded p-2" id="notes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" rows="3"></textarea>
</div>
<div class="md:col-span-2">
<label class="block mb-1 font-medium" for="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
<select class="w-full border rounded p-2" id="status" required="">
<option value="Confirm">Confirm</option>
<option value="Cancelled">Cancelled</option>
<option value="No-show">No-show</option>
<option value="Done">Done</option>
</select>
</div>
<div class="md:col-span-2 text-right">
<button class="bg-primary text-white px-4 py-2 rounded" type="submit">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</button>
</div>
</form>
<div class="mb-4">
<label class="block mb-1 font-medium" for="filterStatus">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</label>
<select class="w-48 border rounded p-2" id="filterStatus">
<option value="All">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
<option value="Confirm">Confirm</option>
<option value="Cancelled">Cancelled</option>
<option value="No-show">No-show</option>
<option value="Done">Done</option>
</select>
</div>
<table class="w-full text-sm table-auto border">
<thead class="bg-gray-200">
<tr>
<th class="p-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏î</th>
<th class="p-2">‡πÄ‡∏ß‡∏•‡∏≤</th>
<th class="p-2">‡∏™‡∏≤‡∏Ç‡∏≤</th>
<th class="p-2">‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå</th>
<th class="p-2">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</th>
<th class="p-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
<th class="p-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="p-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody id="appointmentTableBody"></tbody>
</table>
</div>
</div>
<!-- Module 6: Sales Performance & Conversion -->
<div class="module" id="module-salesperformance" x-show="mainTab === 'sales' && open === 'performance'" x-cloak>
<div class="bg-white p-6 rounded shadow">
<h2 class="text-2xl font-semibold mb-4">üìä Sales Performance &amp; Conversion</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
<div class="p-4 border rounded bg-green-50">
<h3 class="text-lg font-semibold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Lead ‡∏ï‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
<p class="text-3xl font-bold" id="statLeadPerEmployee">0</p>
</div>
<div class="p-4 border rounded bg-blue-50">
<h3 class="text-lg font-semibold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Quotation ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
<p class="text-3xl font-bold" id="statQuotationPerMonth">0</p>
</div>
<div class="p-4 border rounded bg-yellow-50">
<h3 class="text-lg font-semibold mb-2">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
<p class="text-3xl font-bold" id="statConversionRate">0%</p>
</div>
<div class="p-4 border rounded bg-purple-50">
<h3 class="text-lg font-semibold mb-2">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
<p class="text-3xl font-bold" id="statTotalSales">0 ‡∏ø</p>
</div>
<div class="p-4 border rounded bg-pink-50">
<h3 class="text-lg font-semibold mb-2">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</h3>
<p class="text-xl" id="statPopularService">-</p>
</div>
<div class="p-4 border rounded bg-gray-50">
<h3 class="text-lg font-semibold mb-2">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á Lead ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</h3>
<p class="text-xl" id="statBestLeadChannel">-</p>
</div>
</div>
</div>
</div>
</main>
<script>
// NAVIGATION
const modules = document.querySelectorAll('.module');
const navButtons = document.querySelectorAll('.nav-btn');
navButtons.forEach(btn => {
btn.addEventListener('click', () => {
modules.forEach(m => m.classList.add('hidden'));
document.getElementById(`module-${btn.dataset.module}`).classList.remove('hidden');
navButtons.forEach(b => b.classList.remove('bg-secondary', 'text-white'));
btn.classList.add('bg-secondary', 'text-white');
});
});
// Initialize first module visible
navButtons[0].click();

// Tailwind color helpers (replace bg-primary/bg-secondary)
const style = document.createElement('style');
style.textContent = `
.bg-primary { background-color: #2563EB; }
.bg-secondary { background-color: #4B5563; }
`;
document.head.appendChild(style);

// Module 1 - Customer Profile logic
const custId = document.getElementById('custId');
const custBirthday = document.getElementById('custBirthday');
const custAge = document.getElementById('custAge');
const treatmentHistoryBody = document.getElementById('treatmentHistoryBody');

function generateCustomerId() {
const now = new Date();
const y = now.getFullYear();
const m = String(now.getMonth()+1).padStart(2,'0');
const d = String(now.getDate()).padStart(2,'0');
const rand = String(Math.floor(Math.random()*10000)).padStart(4,'0');
return `CUST-${y}${m}${d}-${rand}`;
}
function calcAge(birthday) {
const dob = new Date(birthday);
if (isNaN(dob)) return '';
const diff = Date.now() - dob.getTime();
const ageDate = new Date(diff);
return Math.abs(ageDate.getUTCFullYear() - 1970);
}
custBirthday.addEventListener('change', () => {
custAge.value = calcAge(custBirthday.value);
});
custId.value = generateCustomerId();

// Dummy treatment data for demonstration
const dummyTreatmentHistory = [
{
date: '2025-07-01', service: '‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô', tooth: '11', qty: 1,
pricePerUnit: 1000, totalPrice: 1000, dentist: '‡∏ó‡∏û. ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', note: '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤'
},
{
date: '2025-06-20', service: '‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô', tooth: '12,13', qty: 2,
pricePerUnit: 1500, totalPrice: 3000, dentist: '‡∏ó‡∏û. ‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á', note: '‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥'
}
];

function renderTreatmentHistory() {
if (dummyTreatmentHistory.length === 0) {
treatmentHistoryBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;
return;
}
treatmentHistoryBody.innerHTML = '';
dummyTreatmentHistory.forEach(tr => {
treatmentHistoryBody.innerHTML += `
<tr>
<td class="p-2">${tr.date}</td>
<td class="p-2">${tr.service}</td>
<td class="p-2">${tr.tooth}</td>
<td class="p-2">${tr.qty}</td>
<td class="p-2">${tr.pricePerUnit}</td>
<td class="p-2">${tr.totalPrice}</td>
<td class="p-2">${tr.dentist}</td>
<td class="p-2">${tr.note}</td>
</tr>`;
});
}
renderTreatmentHistory();

function saveCustomer() {
alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
// ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠ API ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
}

// Module 2 - Quotation
const quotationTable = document.getElementById('quotationTable');
const sumBeforeDiscount = document.getElementById('sumBeforeDiscount');
const sumDiscount = document.getElementById('sumDiscount');
const netTotal = document.getElementById('netTotal');

let quotationRows = [];

function addQuotationRow(service='', tooth='', qty=1, price=0, discount=0) {
const index = quotationRows.length + 1;
quotationRows.push({service, tooth, qty, price, discount});
renderQuotationTable();
}
function removeQuotationRow(i) {
quotationRows.splice(i,1);
renderQuotationTable();
}
function renderQuotationTable() {
quotationTable.innerHTML = '';
let totalBefore = 0, totalDiscount = 0;
quotationRows.forEach((row,i) => {
const priceNum = Number(row.price)||0;
const qtyNum = Number(row.qty)||0;
const discountNum = Number(row.discount)||0;
const rowTotal = (priceNum * qtyNum) - discountNum;
totalBefore += priceNum * qtyNum;
totalDiscount += discountNum;
const tr = document.createElement('tr');
tr.innerHTML = `
<td class="p-2 text-center">${i+1}</td>
<td class="p-2">
<select class="service-select w-full border rounded p-1" data-index="${i}">
<option ${row.service==='‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô'?'selected':''}>‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô</option>
<option ${row.service==='‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô'?'selected':''}>‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô</option>
<option ${row.service==='‡∏ü‡∏≠‡∏Å‡∏ü‡∏±‡∏ô'?'selected':''}>‡∏ü‡∏≠‡∏Å‡∏ü‡∏±‡∏ô</option>
<option ${row.service==='‡∏ß‡∏µ‡πÄ‡∏ô‡∏µ‡∏¢‡∏£‡πå'?'selected':''}>‡∏ß‡∏µ‡πÄ‡∏ô‡∏µ‡∏¢‡∏£‡πå</option>
</select>
</td>
<td class="p-2"><input type="text" class="tooth-input border rounded p-1 w-full" value="${row.tooth}" data-index="${i}"></td>
<td class="p-2"><input type="number" min="1" class="qty-input border rounded p-1 w-full" value="${row.qty}" data-index="${i}"></td>
<td class="p-2"><input type="number" min="0" class="price-input border rounded p-1 w-full" value="${row.price}" data-index="${i}"></td>
<td class="p-2"><input type="number" min="0" class="discount-input border rounded p-1 w-full" value="${row.discount}" data-index="${i}"></td>
<td class="p-2 text-right">${rowTotal.toLocaleString()}</td>
<td class="p-2 text-center">
<button onclick="removeQuotationRow(${i})" class="text-red-600 hover:underline">‡∏•‡∏ö</button>
</td>
`;
quotationTable.appendChild(tr);
});
sumBeforeDiscount.value = totalBefore.toLocaleString();
sumDiscount.value = totalDiscount.toLocaleString();
netTotal.value = (totalBefore - totalDiscount).toLocaleString();
attachQuotationEvents();
}
function attachQuotationEvents() {
document.querySelectorAll('.service-select').forEach(el => {
el.onchange = e => {
quotationRows[+e.target.dataset.index].service = e.target.value;
}
});
document.querySelectorAll('.tooth-input').forEach(el => {
el.oninput = e => {
quotationRows[+e.target.dataset.index].tooth = e.target.value;
}
});
document.querySelectorAll('.qty-input').forEach(el => {
el.oninput = e => {
quotationRows[+e.target.dataset.index].qty = Number(e.target.value);
renderQuotationTable();
}
});
document.querySelectorAll('.price-input').forEach(el => {
el.oninput = e => {
quotationRows[+e.target.dataset.index].price = Number(e.target.value);
renderQuotationTable();
}
});
document.querySelectorAll('.discount-input').forEach(el => {
el.oninput = e => {
quotationRows[+e.target.dataset.index].discount = Number(e.target.value);
renderQuotationTable();
}
});
}

function confirmQuotation() {
alert('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á Sale Order');
// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Sale Order ‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
}

addQuotationRow();

// Module 5 - Appointment & Scheduling (Full code as requested)
const appointmentForm = document.getElementById('appointmentForm');
const appointmentTableBody = document.getElementById('appointmentTableBody');
const filterStatus = document.getElementById('filterStatus');

let appointments = [];

function renderAppointments(filter = 'All') {
appointmentTableBody.innerHTML = '';
const filtered = filter === 'All' ? appointments : appointments.filter(a => a.status === filter);
if (filtered.length === 0) {
appointmentTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</td></tr>`;
return;
}
filtered.forEach((appt, i) => {
const tr = document.createElement('tr');
tr.innerHTML = `
<td class="p-2">${appt.date}</td>
<td class="p-2">${appt.time}</td>
<td class="p-2">${appt.branch}</td>
<td class="p-2">${appt.dentist}</td>
<td class="p-2">${appt.services}</td>
<td class="p-2">${appt.notes || ''}</td>
<td class="p-2">${appt.status}</td>
<td class="p-2 text-center">
<button onclick="deleteAppointment(${i})" class="text-red-600 hover:underline">‡∏•‡∏ö</button>
</td>
`;
appointmentTableBody.appendChild(tr);
});
}
function deleteAppointment(index) {
if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
appointments.splice(index, 1);
renderAppointments(filterStatus.value);
}
}
appointmentForm.addEventListener('submit', e => {
e.preventDefault();
const newAppt = {
date: appointmentForm.apptDate.value,
time: appointmentForm.apptTime.value,
branch: appointmentForm.branch.value.trim(),
dentist: appointmentForm.dentist.value,
services: appointmentForm.services.value.trim(),
notes: appointmentForm.notes.value.trim(),
status: appointmentForm.status.value
};
if (!newAppt.date || !newAppt.time || !newAppt.branch || !newAppt.dentist || !newAppt.services || !newAppt.status) {
alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
return;
}
appointments.push(newAppt);
appointmentForm.reset();
renderAppointments(filterStatus.value);
});
filterStatus.addEventListener('change', () => {
renderAppointments(filterStatus.value);
});
renderAppointments();

// Placeholder for other modules' scripts and logic...

// Sales Performance (dummy data)
document.getElementById('statLeadPerEmployee').textContent = '25';
document.getElementById('statQuotationPerMonth').textContent = '120';
document.getElementById('statConversionRate').textContent = '65%';
document.getElementById('statTotalSales').textContent = '1,500,000 ‡∏ø';
document.getElementById('statPopularService').textContent = '‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô';
document.getElementById('statBestLeadChannel').textContent = 'Line';

// Payment mode toggle in Module 3 Sale Order
function togglePaymentMode(mode) {
const payRounds = document.getElementById('paymentRounds');
if (mode === '‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏≠‡∏ö') payRounds.classList.remove('hidden');
else payRounds.classList.add('hidden');
}

</script>
</div>
    <div x-show="mainTab === 'inventory'" x-cloak>
<ul class="pl-4 mt-1 space-y-1" x-show="open === 'inventory'" x-transition="">
<li><a @click.prevent='open = "product"' href="#">‚ñ∏ Product Master</a></li>
<li><a @click.prevent='open = "movement"' href="#">‚ñ∏ Stock Movement</a></li>
<li><a @click.prevent='open = "receiving"' href="#">‚ñ∏ Goods Receiving</a></li>
<li><a @click.prevent='open = "issue"' href="#">‚ñ∏ Stock Issue</a></li>
<li><a @click.prevent='open = "adjustment"' href="#">‚ñ∏ Adjustment</a></li>
<li><a @click.prevent='open = "count"' href="#">‚ñ∏ Stock Count &amp; Audit</a></li>
<li><a @click.prevent='open = "expiry"' href="#">‚ñ∏ Expiry &amp; Batch</a></li>
</ul><ul class="pl-4 mt-1 space-y-1" x-show="open === 'warehouse'" x-transition="">
<li><a @click.prevent="open = 'picking'" href="#">‚ñ∏ Pick List / Picking</a></li>
<li><a @click.prevent="open = 'dispatch'" href="#">‚ñ∏ Packing &amp; Dispatch</a></li>
<li><a @click.prevent="open = 'damage'" href="#">‚ñ∏ Damage / Return Report</a></li>
<li><a @click.prevent="open = 'onhand'" href="#">‚ñ∏ On-hand Status Monitor</a></li>
<li><a @click.prevent="open = 'kpi'" href="#">‚ñ∏ Dashboard &amp; KPI</a></li>
</ul><ul class="pl-4 mt-1 space-y-1" x-show="open === 'dashboard'" x-transition="">
<li><a @click.prevent='open = "overview"' href="#">‚ñ∏ Inventory Overview</a></li>
</ul><div x-cloak="" x-data="productMasterApp()" x-init="loadProducts()" x-show="open === 'product'" x-transition="">


<html lang="th">
<head>
<meta charset="utf-8">
<title>üì¶ Product Master</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://unpkg.com/alpinejs"></script>
</meta></head>
<body class="bg-gray-100 p-6">
<div class="p-4 bg-white rounded shadow space-y-4 max-w-7xl mx-auto" x-data="productMasterApp()" x-init="loadProducts()">
<h2 class="text-xl font-bold">üì¶ Product Master</h2>
<!-- Form -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium mb-1">SKU</label>
<input class="border p-2 rounded w-full" placeholder="SKU" x-model="form.sku"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
<input class="border p-2 rounded w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" x-model="form.name"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
<select class="border p-2 rounded w-full" x-model="form.type">
<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
<option>‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á</option>
<option>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</option>
<option>‡∏ä‡∏∏‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
<select class="border p-2 rounded w-full" x-model="form.unit">
<option>‡∏ä‡∏¥‡πâ‡∏ô</option><option>‡∏Å‡∏•‡πà‡∏≠‡∏á</option><option>‡∏ä‡∏∏‡∏î</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Ñ</label>
<input class="border p-2 rounded w-full" type="number" x-model="form.pack"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</label>
<input class="border p-2 rounded w-full" type="number" x-model="form.cost"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label>
<input class="border p-2 rounded w-full" type="number" x-model="form.price"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Minimum Stock</label>
<input class="border p-2 rounded w-full" type="number" x-model="form.min"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Location</label>
<input class="border p-2 rounded w-full" placeholder="‡πÄ‡∏ä‡πà‡∏ô R01-B03" x-model="form.location"/>
</div>
</div>
<div class="flex gap-2 mt-2">
<button @click="saveProduct()" class="bg-blue-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="resetForm()" class="bg-gray-400 text-white px-4 py-2 rounded">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<!-- Search -->
<div class="mt-4">
<input class="border rounded px-2 py-1 w-full md:w-1/3" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ SKU / ‡∏ä‡∏∑‡πà‡∏≠ / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" type="text" x-model="search"/>
</div>
<!-- Table -->
<table class="min-w-full text-sm mt-2">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1 text-left">SKU</th>
<th class="px-2 py-1 text-left">‡∏ä‡∏∑‡πà‡∏≠</th>
<th class="px-2 py-1 text-center">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
<th class="px-2 py-1 text-right">‡∏ó‡∏∏‡∏ô</th>
<th class="px-2 py-1 text-right">‡∏Ç‡∏≤‡∏¢</th>
<th class="px-2 py-1 text-center">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
<th class="px-2 py-1 text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(p, index) in filteredProducts()">
<tr class="border-b">
<td class="px-2 py-1" x-text="p.sku"></td>
<td class="px-2 py-1" x-text="p.name"></td>
<td class="px-2 py-1 text-center" x-text="p.type"></td>
<td class="px-2 py-1 text-right" x-text="p.cost"></td>
<td class="px-2 py-1 text-right" x-text="p.price"></td>
<td class="px-2 py-1 text-center" x-text="p.unit"></td>
<td class="px-2 py-1 text-center">
<button @click="editProduct(index)" class="text-blue-600">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
<button @click="deleteProduct(index)" class="text-red-600 ml-1">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
</div>
<script>
function productMasterApp() {
  return {
    form: { sku: '', name: '', type: '', unit: '‡∏ä‡∏¥‡πâ‡∏ô', pack: 1, cost: 0, price: 0, min: 0, location: '' },
    formIndex: null,
    search: '',
    products: [],

    loadProducts() {
      const data = localStorage.getItem('productData');
      this.products = data ? JSON.parse(data) : [];
    },
    saveProduct() {
      if (this.formIndex === null) {
        this.products.push({ ...this.form });
      } else {
        this.products[this.formIndex] = { ...this.form };
      }
      localStorage.setItem('productData', JSON.stringify(this.products));
      this.resetForm();
    },
    editProduct(index) {
      this.form = { ...this.products[index] };
      this.formIndex = index;
    },
    deleteProduct(index) {
      if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤?')) {
        this.products.splice(index, 1);
        localStorage.setItem('productData', JSON.stringify(this.products));
      }
    },
    resetForm() {
      this.form = { sku: '', name: '', type: '', unit: '‡∏ä‡∏¥‡πâ‡∏ô', pack: 1, cost: 0, price: 0, min: 0, location: '' };
      this.formIndex = null;
    },
    filteredProducts() {
      const q = this.search.toLowerCase();
      return this.products.filter(p =>
        p.sku.toLowerCase().includes(q) ||
        p.name.toLowerCase().includes(q) ||
        p.type.toLowerCase().includes(q)
      );
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}

</script>

</body>
</div><div x-cloak="" x-data="stockMovementApp()" x-init="loadRecords()" x-show="open === 'movement'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8">
<title>üì• Stock Movement</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://unpkg.com/alpinejs"></script>
</meta></head>
<body class="bg-gray-100 p-6" x-data="stockMovementApp()" x-init="loadRecords()">
<h2 class="text-xl font-bold">üì• Stock Movement</h2>
<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
<input class="border p-2 rounded w-full" type="date" x-model="form.date"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß</label>
<select @change="generateRef()" class="border p-2 rounded w-full" x-model="form.type">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
<option>‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
<option>‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å</option>
<option>‡πÇ‡∏≠‡∏ô</option>
<option>‡∏Ñ‡∏∑‡∏ô</option>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
<input class="border p-2 rounded w-full bg-gray-100" readonly="" x-model="form.ref"/>
</div>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
<input class="border p-2 rounded w-full" x-model="form.note"/>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
<input class="border p-2 rounded w-full" x-model="form.fromWarehouse"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
<input class="border p-2 rounded w-full" x-model="form.toWarehouse"/>
</div>
</div>
<template x-if="form.type === '‡πÇ‡∏≠‡∏ô'">
<div class="md:col-span-2 grid grid-cols-2 gap-4">
<div>
<label class="block text-sm font-medium mb-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</label>
<input class="border p-2 rounded w-full" x-model="form.fromWarehouse"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
<input class="border p-2 rounded w-full" x-model="form.toWarehouse"/>
</div>
</div>
</template>
<div class="mt-4">
<div class="flex justify-between items-center mb-2">
<h3 class="font-semibold">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
<button @click="addItem()" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>
<table class="w-full text-sm border">
<thead class="bg-gray-100">
<tr>
<th class="border px-2 py-1">SKU</th>
<th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="border px-2 py-1">Location ‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</th>
<th class="border px-2 py-1">Location ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
<th class="border px-2 py-1">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="idx" x-for="(item, idx) in form.items">
<tr>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="text" x-model="item.sku"/></td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="text" x-model="item.name"/></td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="number" x-model="item.qty"/> ‡∏ä‡∏¥‡πâ‡∏ô</td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="text" x-model="item.locationFrom"/></td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="text" x-model="item.locationTo"/></td>
<td class="border px-2 py-1 text-center">
<button @click="form.items.splice(idx, 1)" class="text-red-600">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
</div>
<div class="flex gap-2 mt-2">
<button @click="saveRecord()" class="bg-blue-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="resetForm()" class="bg-gray-400 text-white px-4 py-2 rounded">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
<div class="mt-4">
<input class="border rounded px-2 py-1 w-full md:w-1/3" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ / SKU / ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó" type="text" x-model="search"/>
</div>
<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß -->
<table class="min-w-full text-sm mt-2">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="px-2 py-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
<th class="px-2 py-1">SKU</th>
<th class="px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="px-2 py-1 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="px-2 py-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á</th>
<th class="px-2 py-1">‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</th>
<th class="px-2 py-1">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á</th>
<th class="px-2 py-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(r, index) in filteredRecords()">
<template :key="item.sku + item.name" x-for="item in r.items">
<tr class="border-b">
<td class="px-2 py-1" x-text="r.date"></td>
<td class="px-2 py-1" x-text="r.type"></td>
<td class="px-2 py-1" x-text="item.sku"></td>
<td class="px-2 py-1" x-text="item.name"></td>
<td class="px-2 py-1 text-right" x-text="item.qty + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></td>
<td class="px-2 py-1" x-text="item.locationFrom"></td>
<td class="px-2 py-1" x-text="item.locationTo"></td>
<td class="px-2 py-1" x-text="r.ref"></td>
<td class="px-2 py-1 text-center">
<button @click="editRecord(index)" class="text-blue-600 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
<button @click="deleteRecord(index)" class="text-red-600 text-sm ml-1">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</template>
</tbody>
</table>
<script>
function stockMovementApp() {
  return {
    form: { note: "", date: '', type: '', ref: '', fromWarehouse: '', toWarehouse: '', note: '', items: [] },
    formIndex: null,
    search: '',
    records: [],
    editIndex: null,

    loadRecords() {
      const data = localStorage.getItem('stockMovementData');
      this.records = data ? JSON.parse(data) : [];
    },

    generateRef() {
      if (!this.form.date) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô");
        this.form.type = '';
        return;
      }
      const date = this.form.date.replaceAll('-', '').slice(0,6);
      const running = String(this.records.length + 1).padStart(4, '0');
      let prefix = 'TR';
      if (this.form.type === '‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å') prefix = 'TF';
      else if (this.form.type === '‡πÇ‡∏≠‡∏ô') prefix = 'MO';
      else if (this.form.type === '‡∏Ñ‡∏∑‡∏ô') prefix = 'RT';
      this.form.ref = `${prefix}-${date}${running}`;
    },

    filteredRecords() {
      const q = this.search.toLowerCase();
      return this.records.filter(r =>
        r.items.some(item => item.sku.toLowerCase().includes(q) || item.name.toLowerCase().includes(q)) ||
        r.type.toLowerCase().includes(q)
      );
    },

    editRecord(index) {
      this.form = JSON.parse(JSON.stringify(this.records[index]));
      this.formIndex = index;
    },

    deleteRecord(index) {
      if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
        this.records.splice(index, 1);
        localStorage.setItem('stockMovementData', JSON.stringify(this.records));
      }
    },

    resetForm() {
      this.form = { date: '', type: '', ref: '', fromWarehouse: '', toWarehouse: '', note: '', items: [] };
      this.formIndex = null;
    },

    addItem() {
      this.form.items.push({ sku: '', name: '', qty: 1, locationFrom: '', locationTo: '' });
    },

    saveRecord() {
      if (this.form.items.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
        return;
      }

      if (!this.form.ref) this.generateRef();

      if (this.formIndex === null) {
        this.records.push({ ...this.form });
      } else {
        this.records[this.formIndex] = { ...this.form };
      }

      localStorage.setItem('stockMovementData', JSON.stringify(this.records));
      this.resetForm();
    },

    load() {
      const saved = localStorage.getItem('stockMovement');
      this.records = saved ? JSON.parse(saved) : [];
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}
</script>

</body>

</div><div x-cloak="" x-data="goodsReceivingApp()" x-init="loadRecords()" x-show="open === 'receiving'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>üì¶ Goods Receiving with PO/TR Mapping</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://unpkg.com/alpinejs"></script>
</head>
<body class="bg-gray-100 p-6">
<div class="p-4 bg-white rounded shadow space-y-4 max-w-7xl mx-auto" x-data="goodsReceivingApp()" x-init="loadRecords()">
<h2 class="text-xl font-bold">üì¶ Goods Receiving (‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤)</h2>
<div class="mb-4">
<label class="block text-sm font-medium mb-1 text-gray-700">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Receiving No.</label>
<input @change="loadRecordByRecNo()" @input="suggestReceipts()" class="border p-2 rounded w-full" list="receiptsList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå Receiving No." type="text" x-model="searchRec"/>
<datalist id="receiptsList">
<template :key="r" x-for="r in receiptSuggestions">
<option :value="r" x-text="r"></option>
</template>
</datalist>
</div>
<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block text-sm font-medium mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</label>
<input class="border p-2 rounded w-full" type="date" x-model="form.date"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">Receiving No.</label>
<input class="border p-2 rounded w-full bg-gray-100" readonly="" x-model="form.rec"/>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏•‡∏Ç PO/TR</label>
<select @change="loadItemsFromPO()" class="border p-2 rounded w-full" x-model="form.po">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç PO/TR --</option>
<template :key="po" x-for="po in Object.keys(poDetails)">
<option x-text="po"></option>
</template>
</select>
</div>
<div>
<label class="block text-sm font-medium mb-1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà Invoice</label>
<input class="border p-2 rounded w-full" x-model="form.invoice"/>
</div>
</div>
<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ -->
<div class="overflow-auto">
<table class="min-w-full mt-4 text-sm">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1">SKU</th>
<th class="px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="px-2 py-1 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡πà‡∏á</th>
<th class="px-2 py-1 text-right">‡∏£‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
<th class="px-2 py-1 text-right">‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å</th>
<th class="px-2 py-1">Batch No.</th>
<th class="px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</th>
<th class="px-2 py-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
<th class="px-2 py-1">‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á</th>
<th class="px-2 py-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
<th class="px-2 py-1">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="idx" x-for="(item, idx) in form.items">
<tr class="border-b">
<td class="px-2 py-1" x-text="item.sku"></td>
<td class="px-2 py-1" x-text="item.name"></td>
<td class="px-2 py-1 text-right" x-text="item.qty_ordered + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></td>
<td class="px-2 py-1"><input :max="item.qty_remaining" class="w-full border rounded p-1" type="number" x-model="item.qty_received"/></td>
<td class="px-2 py-1 text-right" x-text="item.qty_remaining + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></td>
<td class="px-2 py-1"><input class="w-full border rounded p-1" x-model="item.batch"/></td>
<td class="px-2 py-1"><input class="w-full border rounded p-1" type="date" x-model="item.mfg"/></td>
<td class="px-2 py-1"><input class="w-full border rounded p-1" type="date" x-model="item.exp"/></td>
<td class="px-2 py-1"><input class="w-full border rounded p-1" x-model="item.receiver"/></td>
<td class="px-2 py-1"><input class="w-full border rounded p-1" x-model="item.note"/></td>
<td class="px-2 py-1 text-center"><button @click="removeLine(idx)" class="text-red-600">‡∏•‡∏ö</button></td>
</tr>
</template>
</tbody>
</table>
</div>
<!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Receiving No -->
<div class="flex gap-2 items-center">
<input class="border p-2 rounded w-full max-w-xs" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Receiving No..." type="text" x-model="searchRec"/>
<button @click="loadRecordByRec()" class="bg-blue-600 text-white px-4 py-2 rounded">‡πÇ‡∏´‡∏•‡∏î</button>
</div>
<div class="flex gap-2 mt-4">
<button @click="saveRecord()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="resetForm()" class="bg-gray-500 text-white px-4 py-2 rounded">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
<div class="mt-8">
<h3 class="text-lg font-semibold mb-2">üìÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</h3>
<template :key="i" x-for="(rec, i) in records">
<div class="border rounded p-4 mb-4 bg-gray-50">
<div class="font-bold text-blue-700 mb-2">Receiving No: <span x-text="rec.rec"></span> | ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span x-text="rec.date"></span> | ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: <span x-text="rec.po"></span></div>
<table class="text-sm w-full">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1">SKU</th>
<th class="px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="px-2 py-1 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="px-2 py-1">Batch</th>
<th class="px-2 py-1">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
<th class="px-2 py-1">‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö</th>
<th class="px-2 py-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
</tr>
</thead>
<tbody>
<template x-for="item in rec.items">
<tr class="border-b">
<td class="px-2 py-1" x-text="item.sku"></td>
<td class="px-2 py-1" x-text="item.name"></td>
<td class="px-2 py-1 text-right" x-text="item.qty_received + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></td>
<td class="px-2 py-1" x-text="item.batch"></td>
<td class="px-2 py-1" x-text="item.exp"></td>
<td class="px-2 py-1" x-text="item.receiver"></td>
<td class="px-2 py-1" x-text="item.note"></td>
</tr>
</template>
</tbody>
</table>
</div>
</template>
</div>
</div>
<script>
function goodsReceivingApp() {
  return {
    form: {
      date: '', rec: '', po: '', items: []
    },
    records: [],

searchRec: '',
receiptSuggestions: [],
suggestReceipts() {
  const keyword = this.searchRec.toLowerCase();
  this.receiptSuggestions = this.records
    .map(r => r.rec)
    .filter(rec => rec.toLowerCase().includes(keyword));
},

    poDetails: {
      "PO-202507110001": [
        { sku: "DENT-001", name: "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠‡∏¢‡∏≤‡∏á", qty_ordered: 100 },
        { sku: "DENT-002", name: "‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠", qty_ordered: 50 }
      ],
      "TR-202507110002": [
        { sku: "DENT-003", name: "‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ü‡∏±‡∏ô", qty_ordered: 20 }
      ]
    },

    loadRecords() {
      const data = localStorage.getItem('goodsReceivingV3');
      this.records = data ? JSON.parse(data) : [];
    },
    getReceivedQtyByPO(po) {
      const map = {};
      this.records.forEach(rec => {
        if (rec.po === po) {
          rec.items.forEach(item => {
            if (!map[item.sku]) map[item.sku] = 0;
            map[item.sku] += Number(item.qty_received) || 0;
          });
        }
      });
      return map;
    },
    saveRecord() {
      const overReceived = this.form.items.some(item => Number(item.qty_received) > item.qty_remaining);
      if (overReceived) {
        alert("‚ùå ‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß");
        return;
      }
    
      if (!this.form.rec) {
        const running = String(this.records.length + 1).padStart(4, '4');
        const date = new Date().toISOString().slice(0,10).replaceAll('-', '').slice(0,6).slice(0,6);
        this.form.rec = `REC-${date}${running}`;
      }
      this.records.push({ ...this.form });
      localStorage.setItem('goodsReceivingV3', JSON.stringify(this.records));
      this.resetForm();
    },
    resetForm() {
      this.form = { date: '', rec: '', po: '', items: [] };
    },
    loadItemsFromPO() {
      const po = this.form.po;
      const items = this.poDetails[po] || [];
      const receivedMap = this.getReceivedQtyByPO(po);

      this.form.items = items.map(item => {
        const receivedAlready = receivedMap[item.sku] || 0;
        const remaining = item.qty_ordered - receivedAlready;
        return {
          ...item,
          qty_received: 0,
          batch: '', mfg: '', exp: '',
          receiver: '', note: '',
          qty_received_already: receivedAlready,
          qty_remaining: remaining < 0 ? 0 : remaining
        };
      });
    },
    
    loadRecordByRec() {
      const found = this.records.find(r => r.rec === this.searchRec.trim());
      if (found) {
        this.form = JSON.parse(JSON.stringify(found));
        alert("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
      } else {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Receiving No ‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤");
      }
    },
    
loadRecordByRecNo() {
  const found = this.records.find(r => r.rec === this.searchRec);
  if (found) {
    this.form = JSON.parse(JSON.stringify(found)); // deep copy
  } else {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö Receiving No ‡∏ô‡∏µ‡πâ");
  }
},

removeLine(i) {
      this.form.items.splice(i, 1);
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}
</script>

</body>
</div><div x-cloak="" x-data="stockIssueApp()" x-init="load()" x-show="open === 'issue'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>üì§ Stock Issue / Request</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://unpkg.com/alpinejs"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
<div class="max-w-5xl mx-auto bg-white rounded shadow p-6" x-data="stockIssueApp()" x-init="load()">
<h2 class="text-2xl font-bold mb-2">üì§ Stock Issue / Request</h2>
<div class="text-right text-sm text-gray-500 mb-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å: <span x-text="form.id"></span></div>
<!-- Form -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
<div>
<label class="font-medium text-sm">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å</label>
<input class="w-full border p-2 rounded" type="date" x-model="form.date"/>
</div>
<div>
<label class="font-medium text-sm">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</label>
<input class="w-full border p-2 rounded" type="text" x-model="form.requester"/>
</div>
<div>
<label class="font-medium text-sm">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô / ‡∏™‡∏≤‡∏Ç‡∏≤</label>
<input class="w-full border p-2 rounded" type="text" x-model="form.department"/>
</div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<div>
<label class="font-medium text-sm">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
<select class="w-full border p-2 rounded" x-model="form.reason">
<option>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á</option>
<option>‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</option>
<option>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</option>
</select>
</div>
<div>
<label class="font-medium text-sm">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
<input class="w-full border p-2 rounded" type="text" x-model="form.approver"/>
</div>
</div>
<div class="mb-4">
<button @click="addItem()" class="bg-blue-600 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>
<table class="w-full text-sm border mb-4">
<thead class="bg-gray-100">
<tr>
<th class="border px-2 py-1">SKU</th>
<th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="border px-2 py-1">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(item, index) in form.items">
<tr>
<td class="border px-2 py-1">
<input class="w-full p-1 border rounded" type="text" x-model="item.sku"/>
</td>
<td class="border px-2 py-1">
<input class="w-full p-1 border rounded" type="text" x-model="item.name"/>
</td>
<td class="border px-2 py-1">
<input class="w-full p-1 border rounded" type="number" x-model.number="item.qty"/> ‡∏ä‡∏¥‡πâ‡∏ô
    </td>
<td class="border px-2 py-1">
<select class="w-full border rounded p-1" x-model="item.status">
<option>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
<option>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
<option>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</option>
</select>
</td>
<td class="border px-2 py-1 text-center">
<button @click="form.items.splice(index, 1)" class="text-red-600">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
<div class="flex gap-2">
<button @click="save()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="reset()" class="bg-gray-500 text-white px-4 py-2 rounded">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<!-- üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å (‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á) -->
<!-- üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ & ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
<div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
<div>
<label class="text-sm font-medium">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ SKU / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</label>
<input class="w-full border p-2 rounded" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô..." type="text" x-model="searchKeyword"/>
</div>
<div>
<label class="text-sm font-medium">üìå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
<select class="w-full border p-2 rounded" x-model="filterStatus">
<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
<option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
<option value="‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</option>
<option value="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
</select>
</div>
<div>
<label class="text-sm font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å</label>
<input class="w-full border p-2 rounded" type="date" x-model="filterDateFrom"/>
</div>
<div>
<label class="text-sm font-medium">üìÖ ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
<input class="w-full border p-2 rounded" type="date" x-model="filterDateTo"/>
</div>
</div>
<!-- ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
<div class="mt-8">
<h3 class="font-semibold text-lg mb-2">üìÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
<template :key="i" x-for="(r, i) in filteredRecords()">
<div class="border rounded p-4 mb-4 bg-gray-50">
<div class="text-blue-700 font-medium mb-2 flex justify-between">
<div>üìÖ <span x-text="r.date"></span> | üë§ <span x-text="r.requester"></span> | üÜî <span x-text="r.id || '-'"></span> | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°: <span x-text="r.items.map(i =&gt; i.status).join(', ')"></span></div>
<button @click="form = JSON.parse(JSON.stringify(r)); currentIndex = i" class="text-blue-600 text-sm underline">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
</div>
<table class="w-full text-sm">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1">SKU</th>
<th class="px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th>
<th class="px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
</tr>
</thead>
<tbody>
<template x-for="item in r.items">
<tr>
<td class="px-2 py-1" x-text="item.sku"></td>
<td class="px-2 py-1" x-text="item.name"></td>
<td class="px-2 py-1 text-right" x-text="item.qty + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></td>
<td class="px-2 py-1" x-text="item.status"></td>
</tr>
</template>
</tbody>
</table>
</div>
</template>
</div>
</div>
<script>
function stockIssueApp() {
  return {
    form: {
      id: "",
      id: "",
      date: '', requester: '', department: '', reason: '', approver: '', items: []
    },
    currentIndex: null,
    searchKeyword: '',
    requestSuggestions: [],
    records: [],
    searchKeyword: "",
    filterStatus: "",
    filterDateFrom: "",
    filterDateTo: "",

    load() {
      const saved = localStorage.getItem('stockIssue');
      this.records = saved ? JSON.parse(saved) : [];
    },

    suggestRequests() {
      const k = this.searchKeyword.toLowerCase();
      this.requestSuggestions = this.records.map(r => `${r.date} - ${r.requester}`).filter(s => s.toLowerCase().includes(k));
    },

    loadRequestByKeyword() {
      const match = this.records.findIndex(r => `${r.date} - ${r.requester}` === this.searchKeyword);
      if (match !== -1) {
        this.form = JSON.parse(JSON.stringify(this.records[match]));
        this.currentIndex = match;
      } else {
        alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô");
      }
    },

    generateID() {
      if (!this.form.date) return;
      const prefix = "REQ-";
      const ymd = this.form.date.replace(/-/g, '').slice(0,6);
      const count = this.records.filter(r => r.date === this.form.date).length + 1;
      const serial = count.toString().padStart(4, "0");
      this.form.id = `${prefix}${ymd}${serial}`;
    },

    
filteredRecords() {
  return this.records.filter(r => {
    const keyword = this.searchKeyword.toLowerCase();
    const matchKeyword = !keyword || (
      (r.id && r.id.toLowerCase().includes(keyword)) ||
      r.items.some(i =>
        (i.sku && i.sku.toLowerCase().includes(keyword)) ||
        (i.name && i.name.toLowerCase().includes(keyword))
      )
    );

    const matchStatus = !this.filterStatus || r.items.some(i => i.status === this.filterStatus);

    const from = this.filterDateFrom ? new Date(this.filterDateFrom) : null;
    const to = this.filterDateTo ? new Date(this.filterDateTo) : null;
    const rDate = new Date(r.date);
    const matchDate = (!from || rDate >= from) && (!to || rDate <= to);

    return matchKeyword && matchStatus && matchDate;
  });
},

    save() {
      this.generateID();
      if (this.form.items.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
        return;
      }

      if (this.currentIndex !== null) {
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°
        this.records[this.currentIndex] = JSON.parse(JSON.stringify(this.form));
      } else {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
        this.records.push(JSON.parse(JSON.stringify(this.form)));
      }

      localStorage.setItem('stockIssue', JSON.stringify(this.records));
      this.reset();
    },

    reset() {
      this.form = {
        date: '', requester: '', department: '', reason: '', approver: '', items: []
      };
      this.currentIndex = null;
      this.searchKeyword = '';
      this.requestSuggestions = [];
    },

    addItem() {
      this.form.items.push({ sku: '', name: '', qty: 1, status: '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£' });
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}

</script>

</body>
</div><div x-cloak="" x-data="adjustmentApp()" x-init="load()" x-show="open === 'adjustment'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>üìâ Inventory Adjustment</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://unpkg.com/alpinejs"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
<div class="max-w-5xl mx-auto bg-white shadow p-6 rounded" x-data="adjustmentApp()" x-init="load()">
<h2 class="text-2xl font-bold mb-2">üìâ Inventory Adjustment (‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏Ñ‡∏•‡∏±‡∏á)</h2>
<div class="text-right text-sm text-gray-600 mb-2">
    ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î: <span x-text="form.id"></span>
</div>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
<div>
<label class="text-sm font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á</label>
<input @change="generateID()" class="w-full border p-2 rounded" type="date" x-model="form.date"/>
</div>
<div>
<label class="text-sm font-medium">üë§ ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
<input class="w-full border p-2 rounded" type="text" x-model="form.approver"/>
</div>
<div class="md:col-span-2">
<label class="text-sm font-medium">üìù ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</label>
<input class="w-full border p-2 rounded" type="text" x-model="form.reason"/>
</div>
</div>
<div class="mb-3">
<button @click="addItem()" class="bg-blue-600 text-white px-3 py-1 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö</button>
</div>
<table class="w-full text-sm border mb-6">
<thead class="bg-gray-100">
<tr>
<th class="border px-2 py-1">SKU</th>
<th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</th>
<th class="border px-2 py-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
<th class="border px-2 py-1">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(item, index) in form.items">
<tr>
<td class="border px-2 py-1"><input class="w-full border rounded p-1" x-model="item.sku"/></td>
<td class="border px-2 py-1"><input class="w-full border rounded p-1" x-model="item.name"/></td>
<td class="border px-2 py-1"><input class="w-full border rounded p-1" type="number" x-model.number="item.qty_system"/></td>
<td class="border px-2 py-1"><input class="w-full border rounded p-1" type="number" x-model.number="item.qty_actual"/></td>
<td class="border px-2 py-1">
<input :value="(item.qty_actual - item.qty_system) &gt; 0 ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : ((item.qty_actual - item.qty_system) &lt; 0 ? '‡∏•‡∏î' : '‡∏Ñ‡∏á‡∏ó‡∏µ‡πà')" class="w-full border p-1 rounded bg-gray-100" disabled="" type="text"/>
</td>
<td class="border px-2 py-1 text-center">
<button @click="form.items.splice(index,1)" class="text-red-600">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
<div class="flex gap-2 mb-6">
<button @click="save()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="reset()" class="bg-gray-500 text-white px-4 py-2 rounded">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
<input class="border px-3 py-2 rounded w-full" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢ SKU / ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡πÄ‡∏•‡∏Ç‡∏£‡∏±‡∏ô" type="text" x-model="search"/>
<select class="border px-3 py-2 rounded w-full" x-model="searchType">
<option value="">üìÇ ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
<option value="‡πÄ‡∏û‡∏¥‡πà‡∏°">üìà ‡πÄ‡∏û‡∏¥‡πà‡∏°</option>
<option value="‡∏•‡∏î">üìâ ‡∏•‡∏î</option>
</select>
</div>
<h3 class="text-lg font-semibold mt-6 mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î</h3>
<template :key="i" x-for="(r, i) in filteredRecords()">
<div class="border p-4 mb-4 rounded bg-gray-50">
<div class="font-medium text-blue-700 mb-2 flex justify-between items-center">
<span x-text="'üìÖ ' + r.date"></span>
<button @click="edit(i)" class="text-blue-600 text-sm underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
</div>
<div class="text-sm text-gray-700 mb-1">
        üÜî <span x-text="r.id"></span> | üë§ <span x-text="r.approver"></span> | üìù <span x-text="r.reason"></span>
</div>
<table class="w-full text-sm border">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1">SKU</th>
<th class="px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th>
<th class="px-2 py-1">‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</th>
<th class="px-2 py-1">‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</th>
<th class="px-2 py-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
</tr>
</thead>
<tbody>
<template x-for="item in r.items">
<tr>
<td class="px-2 py-1" x-text="item.sku"></td>
<td class="px-2 py-1" x-text="item.name"></td>
<td class="px-2 py-1 text-right" x-text="item.qty_system"></td>
<td class="px-2 py-1 text-right" x-text="item.qty_actual"></td>
<td class="px-2 py-1 text-right" x-text="(item.qty_actual - item.qty_system) &gt; 0 ? '‡πÄ‡∏û‡∏¥‡πà‡∏°' : ((item.qty_actual - item.qty_system) &lt; 0 ? '‡∏•‡∏î' : '‡∏Ñ‡∏á‡∏ó‡∏µ‡πà')"></td>
</tr>
</template>
</tbody>
</table>
</div>
</template>
</div>
<script>
function adjustmentApp() {
  return {
    form: {
      id: '', date: '', approver: '', reason: '',
      items: []
    },
    records: [],
    search: "",
    searchType: "",
    editIndex: null,
    load() {
      const data = localStorage.getItem('inventoryAdjustment');
      this.records = data ? JSON.parse(data) : [];
    },
    generateID() {
      if (!this.form.date) return;
      const prefix = 'AJD-';
      const ymd = this.form.date.replace(/-/g, '').slice(0,6);
      const sameDateRecords = this.records.filter(r => r.date === this.form.date);
      const nextNum = (sameDateRecords.length + 1).toString().padStart(4, '0');
      this.form.id = `${prefix}${ymd}${nextNum}`;
    },
    filteredRecords() {
      const s = this.search.toLowerCase();
      return this.records
        .map(r => {
          const filteredItems = r.items.filter(item => {
            const diff = item.qty_actual - item.qty_system;
            const typeMatch = this.searchType === '' ||
              (this.searchType === '‡πÄ‡∏û‡∏¥‡πà‡∏°' && diff > 0) ||
              (this.searchType === '‡∏•‡∏î' && diff < 0);
            const textMatch = r.id.toLowerCase().includes(s) ||
              r.reason.toLowerCase().includes(s) ||
              r.approver.toLowerCase().includes(s) ||
              item.sku.toLowerCase().includes(s);
            return typeMatch && textMatch;
          });
          return { ...r, items: filteredItems };
        })
        .filter(r => r.items.length > 0);
    },
    edit(index) {
      this.form = JSON.parse(JSON.stringify(this.records[index]));
      this.editIndex = index;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    },
    save() {
      if (!this.form.date || !this.form.approver || this.form.items.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
        return;
      }
      this.generateID();
      if (this.editIndex !== null) {
        this.records[this.editIndex] = JSON.parse(JSON.stringify(this.form));
        this.editIndex = null;
      } else {
        this.records.push(JSON.parse(JSON.stringify(this.form)));
      }
      localStorage.setItem('inventoryAdjustment', JSON.stringify(this.records));
      this.reset();
      this.load();
    },
    reset() {
      this.form = {
        id: '', date: '', approver: '', reason: '', items: []
      };
    },
    addItem() {
      this.form.items.push({
        sku: '', name: '', qty_system: 0, qty_actual: 0
      });
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}

</script>

</body>
</div><div x-cloak="" x-data="stockCountApp()" x-init="init()" x-show="open === 'count'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>üìã Module 7: Stock Count &amp; Audit</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer="" src="https://unpkg.com/alpinejs"></script>
</head>
<body class="bg-gray-50 p-6 text-gray-800">
<div class="max-w-5xl mx-auto bg-white shadow p-6 rounded" x-data="stockCountApp()" x-init="init()">
<h2 class="text-2xl font-bold mb-4">üìã ‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å (Stock Count &amp; Audit)</h2>
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
<div>
<label class="text-sm font-semibold">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</label>
<input class="w-full border p-2 rounded" type="date" x-model="form.date"/>
</div>
<div>
<label class="text-sm font-semibold">üë§ ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</label>
<input class="w-full border p-2 rounded" type="text" x-model="form.auditor"/>
</div>
<div>
<label class="text-sm font-semibold">üÜî ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</label>
<input class="w-full border p-2 rounded bg-gray-100" readonly="" type="text" x-model="form.ref"/>
</div>
</div>
<div class="mb-3">
<button @click="addItem()" class="bg-blue-600 text-white px-3 py-1 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>
<table class="w-full text-sm border mb-6">
<thead class="bg-gray-100">
<tr>
<th class="border px-2 py-1">SKU</th>
<th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</th>
<th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="border px-2 py-1">‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û</th>
<th class="border px-2 py-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
<th class="border px-2 py-1">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(item, index) in form.items">
<tr>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" x-model="item.sku"/></td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" x-model="item.name"/></td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="number" x-model.number="item.qty_system"/></td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" type="number" x-model.number="item.qty_actual"/></td>
<td class="border px-2 py-1 text-center">
<span class="font-semibold" x-text="item.qty_actual === item.qty_system ? '‡∏ï‡∏£‡∏á' : (item.qty_actual &gt; item.qty_system ? '‡πÄ‡∏Å‡∏¥‡∏ô' : '‡∏Ç‡∏≤‡∏î')"></span>
</td>
<td class="border px-2 py-1">
<input @change="saveImage($event, index)" class="text-xs" type="file"/>
</td>
<td class="border px-2 py-1"><input class="w-full border p-1 rounded" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." x-model="item.note"/></td>
<td class="border px-2 py-1 text-center">
<button @click="form.items.splice(index,1)" class="text-red-600 text-sm">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
<div class="flex gap-2 mb-6">
<button @click="save()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="reset()" class="bg-gray-600 text-white px-4 py-2 rounded">‚ôªÔ∏è ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<div class="mb-4 flex gap-4">
<input class="border px-3 py-2 rounded w-full" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ / SKU / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" type="text" x-model="search"/>
<select class="border p-2 rounded" x-model="filterStatus">
<option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
<option value="‡∏ï‡∏£‡∏á">‡∏ï‡∏£‡∏á</option>
<option value="‡∏Ç‡∏≤‡∏î">‡∏Ç‡∏≤‡∏î</option>
<option value="‡πÄ‡∏Å‡∏¥‡∏ô">‡πÄ‡∏Å‡∏¥‡∏ô</option>
</select>
</div>
<h3 class="text-lg font-semibold mt-6 mb-2">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ô‡∏±‡∏ö</h3>
<template :key="i" x-for="(r, i) in filteredRecords()">
<div class="bg-gray-50 p-4 border rounded mb-4">
<div class="flex items-center justify-between bg-white px-4 py-2 rounded-t border-t border-l border-r">
<div class="text-sm text-gray-600 flex gap-6 items-center">
<div>üìÖ <span x-text="new Date(r.date).toLocaleDateString('th-TH')"></span></div>
<div>üë§ <span x-text="r.auditor"></span></div>
<div>üÜî <span x-text="r.ref"></span></div>
</div>
<button @click="edit(i)" class="text-sm text-blue-600 underline">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
</div>
<table class="w-full text-sm border mt-2">
<thead class="bg-gray-200">
<tr>
<th class="px-2 py-1 w-24">SKU</th>
<th class="px-2 py-1 w-40">‡∏ä‡∏∑‡πà‡∏≠</th>
<th class="px-2 py-1 w-32 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</th>
<th class="px-2 py-1 w-32 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏±‡∏ö‡πÑ‡∏î‡πâ</th>
<th class="px-2 py-1 w-24 text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="px-2 py-1 w-32 text-center">‡πÅ‡∏ô‡∏ö‡∏†‡∏≤‡∏û</th>
<th class="px-2 py-1 w-40">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
</tr>
</thead>
<tbody>
<template x-for="item in r.items">
<tr>
<td class="px-2 py-1 w-24" x-text="item.sku"></td>
<td class="px-2 py-1 w-40" x-text="item.name"></td>
<td class="px-2 py-1 text-right w-32" x-text="item.qty_system"></td>
<td class="px-2 py-1 text-right w-32" x-text="item.qty_actual"></td>
<td class="px-2 py-1 text-center w-24">
<span x-text="item.qty_actual === item.qty_system ? '‡∏ï‡∏£‡∏á' : (item.qty_actual &gt; item.qty_system ? '‡πÄ‡∏Å‡∏¥‡∏ô' : '‡∏Ç‡∏≤‡∏î')"></span>
</td>
<td class="px-2 py-1 text-center w-32">
<template x-if="item.image">
<img :src="item.image" alt="‡∏†‡∏≤‡∏û" class="h-12 object-contain mx-auto"/>
</template>
</td>
<td class="px-2 py-1 w-40" x-text="item.note"></td>
</tr>
</template>
</tbody>
</table>
</div>
</template>
</div>
<script>
function stockCountApp() {
  return {
    form: {
      date: '',
      auditor: '',
      ref: '',
      items: []
    },
    records: [],
    search: '',
    filterStatus: '',
    editIndex: null,

    init() {
      this.load();
      this.$watch('form.date', value => {
        if (!this.form.ref && value) {
          const datePart = value.replaceAll('-', '').slice(0,6);
          const num = String(this.records.length + 1).padStart(4, '0');
          this.form.ref = `STK-${datePart}${num}`;
        }
      });
    },

    load() {
      const data = localStorage.getItem('stockCountAudit');
      this.records = data ? JSON.parse(data) : [];
    },

    save() {
      if (this.editIndex !== null) {
        this.records[this.editIndex] = JSON.parse(JSON.stringify(this.form));
        this.editIndex = null;
      } else {
        this.records.push(JSON.parse(JSON.stringify(this.form)));
      }
      localStorage.setItem('stockCountAudit', JSON.stringify(this.records));
      this.reset();
    },

    reset() {
      this.form = {
        date: '',
        auditor: '',
        ref: '',
        items: []
      };
    },

    edit(i) {
      this.form = JSON.parse(JSON.stringify(this.records[i]));
      this.editIndex = i;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    addItem() {
      this.form.items.push({
        sku: '',
        name: '',
        qty_system: 0,
        qty_actual: 0,
        note: '',
        image: ''
      });
    },

    saveImage(event, index) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        this.form.items[index].image = e.target.result;
      };
      reader.readAsDataURL(file);
    },

    filteredRecords() {
      return this.records.filter(r => {
        const keyword = this.search.toLowerCase();
        const statusMatch = this.filterStatus === '' || r.items.some(it => {
          const result = it.qty_actual === it.qty_system ? '‡∏ï‡∏£‡∏á' : (it.qty_actual > it.qty_system ? '‡πÄ‡∏Å‡∏¥‡∏ô' : '‡∏Ç‡∏≤‡∏î');
          return result === this.filterStatus;
        });
        const keywordMatch = r.ref?.toLowerCase().includes(keyword) || r.items.some(it =>
          it.sku.toLowerCase().includes(keyword) || it.name.toLowerCase().includes(keyword)
        );
        return keywordMatch && statusMatch;
      });
    }
  }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const mockData = [{
    date: "2025-07-12",
    auditor: "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ä‡∏≤‡∏¢",
    ref: "STK-202507120001",
    items: [
      {
        sku: "DENT-001",
        name: "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠‡∏¢‡∏≤‡∏á",
        qty_system: 100,
        qty_actual: 90,
        note: "‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡∏î",
        image: ""
      },
      {
        sku: "DENT-002",
        name: "‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠",
        qty_system: 50,
        qty_actual: 50,
        note: "",
        image: ""
      }
    ]
  }];
  localStorage.setItem('stockCountAudit', JSON.stringify(mockData));
});
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}


</script>

</body>

</div><div x-cloak="" x-data="batchTracker()" x-init="load()" x-show="open === 'expiry'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>Module 8: Expiry &amp; Batch Tracking</title>
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6" x-data="batchTracker()" x-init="load()">
<!-- üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô -->
<div class="max-w-7xl mx-auto bg-white p-6 rounded shadow">
<div class="flex justify-between items-center mb-4">
<h1 class="text-xl font-semibold">üì¶ Module 8: Expiry &amp; Batch Tracking</h1>
<button @click="add()" class="bg-blue-600 text-white px-4 py-2 rounded">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>
<div class="flex flex-col md:flex-row gap-4 mb-4">
<input class="w-full md:w-1/2 border px-3 py-2 rounded" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ SKU / ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏Ñ‡∏•‡∏±‡∏á" type="text" x-model="search"/>
<select class="border px-3 py-2 rounded" x-model="filter">
<option value="">‚è≥ ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
<option value="15">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 15 ‡∏ß‡∏±‡∏ô</option>
<option value="30">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô</option>
<option value="60">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 60 ‡∏ß‡∏±‡∏ô</option>
</select>
</div>
<table class="w-full text-sm border border-gray-300">
<thead class="bg-gray-100">
<tr>
<th class="border px-2 py-1">SKU</th>
<th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="border px-2 py-1">Batch No.</th>
<th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</th>
<th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
<th class="border px-2 py-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="border px-2 py-1">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö</th>
<th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
<th class="border px-2 py-1">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody>
<template :key="i" x-for="(item, i) in filtered()">
<tr :class="highlight(item)">
<td class="border px-2 py-1" x-text="item.sku"></td>
<td class="border px-2 py-1" x-text="item.name"></td>
<td class="border px-2 py-1" x-text="item.batch"></td>
<td class="border px-2 py-1" x-text="item.mfg"></td>
<td class="border px-2 py-1" x-text="item.exp"></td>
<td class="border px-2 py-1 text-right" x-text="item.qty + ' ‡∏ä‡∏¥‡πâ‡∏ô'"></td>
<td class="border px-2 py-1" x-text="item.location"></td>
<td class="border px-2 py-1 text-center" x-text="status(item)"></td>
<td class="border px-2 py-1 text-center">
<button @click="edit(i)" class="text-blue-600 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button> |
              <button @click="remove(i)" class="text-red-600 text-sm">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
</div>
<script>
function batchTracker() {
  return {
    list: [],
    search: '',
    filter: '',
    editing: false,
    editIndex: null,
    form: { sku: '', name: '', batch: '', mfg: '', exp: '', qty: 0, location: '' },

    load() {
      const saved = localStorage.getItem('batchTracking');
      this.list = saved ? JSON.parse(saved) : [];
    },
    save() {
      if (this.editIndex !== null) {
        this.list[this.editIndex] = { ...this.form };
      } else {
        this.list.push({ ...this.form });
      }
      localStorage.setItem('batchTracking', JSON.stringify(this.list));
      this.cancel();
    },
    cancel() {
      this.form = { sku: '', name: '', batch: '', mfg: '', exp: '', qty: 0, location: '' };
      this.editing = false;
      this.editIndex = null;
    },
    add() {
      this.cancel();
      this.editing = true;
    },
    edit(i) {
      this.form = { ...this.list[i] };
      this.editing = true;
      this.editIndex = i;
    },
    remove(i) {
      if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) {
        this.list.splice(i, 1);
        localStorage.setItem('batchTracking', JSON.stringify(this.list));
      }
    },
    filtered() {
      const today = new Date();
      return this.list.filter(item => {
        const keyword = this.search.toLowerCase();
        const match = item.sku.toLowerCase().includes(keyword) || item.name.toLowerCase().includes(keyword) || item.location.toLowerCase().includes(keyword);
        if (!match) return false;

        if (this.filter) {
          const exp = new Date(item.exp);
          const diff = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
          return diff <= parseInt(this.filter);
        }
        return true;
      });
    },
    status(item) {
      const exp = new Date(item.exp);
      const today = new Date();
      const diff = Math.ceil((exp - today) / (1000 * 60 * 60 * 24));
      if (diff < 0) return '‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß';
      if (diff <= 15) return '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (15 ‡∏ß‡∏±‡∏ô)';
      if (diff <= 30) return '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (30 ‡∏ß‡∏±‡∏ô)';
      if (diff <= 60) return '‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (60 ‡∏ß‡∏±‡∏ô)';
      return '‡∏õ‡∏Å‡∏ï‡∏¥';
    },
    highlight(item) {
      const status = this.status(item);
      if (status.includes("15")) return "bg-yellow-100";
      if (status.includes("‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏")) return "bg-red-100";
      return "";
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}
}
</script>

</body>

</div><div class="bg-white p-6 rounded shadow mb-6" x-show="editing">
<h2 class="text-md font-semibold mb-2">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
<div class="grid md:grid-cols-3 gap-4">
<div>
<label class="text-sm font-semibold">SKU</label>
<input class="border p-2 rounded w-full" type="text" x-model="form.sku"/>
</div>
<div>
<label class="text-sm font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
<input class="border p-2 rounded w-full" type="text" x-model="form.name"/>
</div>
<div>
<label class="text-sm font-semibold">Batch No.</label>
<input class="border p-2 rounded w-full" type="text" x-model="form.batch"/>
</div>
<div>
<label class="text-sm font-semibold">‡∏ß‡∏±‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</label>
<input class="border p-2 rounded w-full" type="date" x-model="form.mfg"/>
</div>
<div>
<label class="text-sm font-semibold">‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label>
<input class="border p-2 rounded w-full" type="date" x-model="form.exp"/>
</div>
<div>
<label class="text-sm font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
<input class="border p-2 rounded w-full" type="number" x-model="form.qty"/>
</div>
<div>
<label class="text-sm font-semibold">‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏Å‡πá‡∏ö</label>
<input class="border p-2 rounded w-full" type="text" x-model="form.location"/>
</div>
</div>
<div class="mt-4 flex gap-2">
<button @click="save()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="cancel()" class="bg-gray-300 px-4 py-2 rounded">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
</div><div x-cloak="" x-data="dashboard()" x-init="load()" x-show="open === 'overview'" x-transition="">
<html lang="th">
<head>
<meta charset="utf-8"/>
<title>Module 9: Inventory Dashboard</title>
<script defer="" src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6" x-data="dashboard()" x-init="load()">
<div class="max-w-7xl mx-auto space-y-6">
<h1 class="text-2xl font-semibold text-gray-800">üìä Module 9: Inventory Dashboard</h1>
<!-- Summary cards -->
<div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
<div class="bg-white p-4 rounded shadow">
<p class="text-sm text-gray-500">üì¶ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏£‡∏ß‡∏°</p>
<p class="text-xl font-semibold text-green-700" x-text="totalValue.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó'"></p>
</div>
<div class="bg-white p-4 rounded shadow">
<p class="text-sm text-gray-500">üìâ ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ Minimum Stock</p>
<p class="text-xl font-semibold text-red-600" x-text="lowStock.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'"></p>
</div>
<div class="bg-white p-4 rounded shadow">
<p class="text-sm text-gray-500">‚è∞ ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô</p>
<p class="text-xl font-semibold text-yellow-500" x-text="nearExpiry.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'"></p>
</div>
<div class="bg-white p-4 rounded shadow">
<p class="text-sm text-gray-500">üí§ ‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß &gt; 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
<p class="text-xl font-semibold text-gray-600" x-text="inactive.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'"></p>
</div>
</div>
<!-- Charts -->
<div class="grid md:grid-cols-2 gap-6">
<div class="bg-white p-4 rounded shadow">
<h2 class="text-md font-semibold mb-2">Top 5 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î</h2>
<canvas height="200" id="topUsedChart"></canvas>
</div>
<div class="bg-white p-4 rounded shadow">
<h2 class="text-md font-semibold mb-2">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
<canvas height="200" id="typeChart"></canvas>
</div>
</div>
</div>
<script>
function dashboard() {
  return {
    productList: [],
    batchList: [],
    stockList: [],
    totalValue: 0,
    lowStock: [],
    nearExpiry: [],
    inactive: [],
    topUsed: {},
    categoryCount: {},

    load() {
      this.productList = JSON.parse(localStorage.getItem("productMaster") || "[]");
      this.batchList = JSON.parse(localStorage.getItem("batchTracking") || "[]");
      this.stockList = JSON.parse(localStorage.getItem("stockMovement") || "[]");

      const today = new Date();
      const oldDate = new Date(today);
      oldDate.setMonth(today.getMonth() - 6);

      this.totalValue = 0;
      this.lowStock = [];
      this.nearExpiry = [];
      this.inactive = [];
      this.topUsed = {};
      this.categoryCount = {};

      this.productList.forEach(p => {
        const qty = Number(p.qty || 0);
        const cost = Number(p.cost || 0);
        this.totalValue += qty * cost;

        if (qty <= (Number(p.min || 0))) this.lowStock.push(p);

        const lastUsed = new Date(p.lastUsed || "2000-01-01");
        if (lastUsed < oldDate) this.inactive.push(p);

        const cat = p.type || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
        this.categoryCount[cat] = (this.categoryCount[cat] || 0) + 1;
      });

      const nearExp = this.batchList.filter(b => {
        const d = new Date(b.exp);
        const diff = (d - today) / (1000 * 60 * 60 * 24);
        return diff <= 30 && diff >= 0;
      });
      this.nearExpiry = nearExp;

      this.stockList.forEach(m => {
        const key = m.sku;
        this.topUsed[key] = (this.topUsed[key] || 0) + Number(m.qty || 0);
      });

      this.renderCharts();
    },

    renderCharts() {
      const sorted = Object.entries(this.topUsed).sort((a,b) => b[1]-a[1]).slice(0, 5);
      new Chart(document.getElementById('topUsedChart'), {
        type: 'bar',
        data: {
          labels: sorted.map(i => i[0]),
          datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å', data: sorted.map(i => i[1]), backgroundColor: 'skyblue' }]
        }
      });

      const pie = Object.entries(this.categoryCount);
      new Chart(document.getElementById('typeChart'), {
        type: 'pie',
        data: {
          labels: pie.map(i => i[0]),
          datasets: [{ data: pie.map(i => i[1]), backgroundColor: ['#4ade80','#60a5fa','#facc15','#f87171','#a78bfa'] }]
        }
      });
    }
  }
}
</script>

<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}


</script>

</body>
</div><div x-cloak="" x-show="open === 'damage'" x-transition="">
<div class="max-w-7xl mx-auto py-6 px-4">
<h1 class="text-2xl font-semibold mb-4">‚ùå Damage / Return Report</h1>
<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢ / ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
<div class="bg-white p-4 rounded shadow mb-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label class="block font-medium">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö</label>
<input class="w-full border px-3 py-1 rounded" id="reportDate" type="date"/>
</div>
<div>
<label class="block font-medium">SKU</label>
<input class="w-full border px-3 py-1 rounded" id="sku" type="text"/>
</div>
<div>
<label class="block font-medium">Batch No.</label>
<input class="w-full border px-3 py-1 rounded" id="batch" type="text"/>
</div>
<div>
<label class="block font-medium">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
<input class="w-full border px-3 py-1 rounded" id="qty" type="number"/>
</div>
<div>
<label class="block font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö</label>
<input class="w-full border px-3 py-1 rounded" id="location" type="text"/>
</div>
<div>
<label class="block font-medium">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</label>
<select class="w-full border px-3 py-1 rounded" id="damageType">
<option>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢</option>
<option>‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</option>
<option>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</option>
<option>‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
</select>
</div>
<div>
<label class="block font-medium">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (URL)</label>
<input class="w-full border px-3 py-1 rounded" id="photo" type="text"/>
</div>
<div>
<label class="block font-medium">‡∏Ñ‡∏ô‡πÅ‡∏à‡πâ‡∏á</label>
<input class="w-full border px-3 py-1 rounded" id="reporter" type="text"/>
</div>
<div>
<label class="block font-medium">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
<input class="w-full border px-3 py-1 rounded" id="inspector" type="text"/>
</div>
</div>
<div class="mt-4">
<label class="block font-medium">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
<textarea class="w-full border px-3 py-1 rounded" id="remark"></textarea>
</div>
<button class="mt-4 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded" onclick="addReport()">
        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
      </button>
</div>
<!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
<div class="bg-white rounded shadow">
<table class="w-full text-left">
<thead class="bg-gray-200 text-gray-800">
<tr>
<th class="px-2 py-1">#</th>
<th class="px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="px-2">SKU</th>
<th class="px-2">Batch</th>
<th class="px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="px-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="px-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
<th class="px-2">üì∑</th>
<th class="px-2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
<th class="px-2">‡πÅ‡∏à‡πâ‡∏á‡πÇ‡∏î‡∏¢</th>
<th class="px-2">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à</th>
</tr>
</thead>
<tbody id="reportTableBody"></tbody>
</table>
</div>
</div>
<script>
    let damageData = JSON.parse(localStorage.getItem("damageReport") || "[]");

    function addReport() {
      const r = {
        date: document.getElementById("reportDate").value,
        sku: document.getElementById("sku").value,
        batch: document.getElementById("batch").value,
        qty: document.getElementById("qty").value,
        location: document.getElementById("location").value,
        damageType: document.getElementById("damageType").value,
        photo: document.getElementById("photo").value,
        reporter: document.getElementById("reporter").value,
        inspector: document.getElementById("inspector").value,
        remark: document.getElementById("remark").value
      };
      damageData.push(r);
      localStorage.setItem("damageReport", JSON.stringify(damageData));
      renderReportTable();
    }

    function renderReportTable() {
      const body = document.getElementById("reportTableBody");
      body.innerHTML = "";
      damageData.forEach((r, i) => {
        body.innerHTML += `
          <tr class="border-b hover:bg-gray-50">
            <td class="px-2">${i + 1}</td>
            <td class="px-2">${r.date}</td>
            <td class="px-2">${r.sku}</td>
            <td class="px-2">${r.batch}</td>
            <td class="px-2">${r.qty}</td>
            <td class="px-2">${r.location}</td>
            <td class="px-2">${r.damageType}</td>
            <td class="px-2">${r.photo ? 'üì∑' : '-'}</td>
            <td class="px-2">${r.remark}</td>
            <td class="px-2">${r.reporter}</td>
            <td class="px-2">${r.inspector}</td>
          </tr>
        `;
      });
    }

    renderReportTable();
  </script>
</div><div x-cloak="" x-show="open === 'picking'" x-transition="">
<div class="max-w-7xl mx-auto bg-white p-6 rounded shadow space-y-6">
<h1 class="text-2xl font-bold text-blue-800">üìã Pick List / Picking</h1>
<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏¥‡∏ö</label>
<input class="w-full mt-1 border px-3 py-2 rounded" type="date" x-model="form.date"/>
</div>
<div>
<label class="font-medium">üìÑ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å / SO</label>
<input class="w-full mt-1 border px-3 py-2 rounded" type="text" x-model="form.so_number"/>
</div>
<div class="md:col-span-2">
<label class="font-medium">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
<textarea class="w-full mt-1 border px-3 py-2 rounded" x-model="form.remarks"></textarea>
</div>
</div>
<!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏¥‡∏ö -->
<div>
<h2 class="text-lg font-semibold mt-4 mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏¥‡∏ö</h2>
<table class="w-full border text-sm">
<thead class="bg-blue-100">
<tr>
<th class="border px-2">#</th>
<th class="border px-2">SKU</th>
<th class="border px-2">Batch</th>
<th class="border px-2">Location</th>
<th class="border px-2">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</th>
<th class="border px-2">‡∏´‡∏¢‡∏¥‡∏ö‡∏à‡∏£‡∏¥‡∏á</th>
<th class="border px-2">‡∏Ñ‡∏ô‡∏´‡∏¢‡∏¥‡∏ö</th>
<th class="border px-2">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(item, index) in form.items">
<tr>
<td class="border px-2 text-center" x-text="index+1"></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.sku"/></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.batch"/></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.location"/></td>
<td class="border px-2"><input class="w-full text-right border-none" type="number" x-model="item.qty_wanted"/></td>
<td class="border px-2"><input class="w-full text-right border-none" type="number" x-model="item.qty_picked"/></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.staff"/></td>
<td class="border px-2 text-center">
<button @click="removeItem(index)" class="text-red-500">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
<button @click="addItem()" class="mt-2 bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>
<!-- ‡∏õ‡∏∏‡πà‡∏° -->
<div class="flex space-x-3">
<button @click="save()" class="bg-blue-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="clear()" class="bg-gray-400 text-white px-4 py-2 rounded">üßπ ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
<div>
<h2 class="text-lg font-semibold mt-4 mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏¢‡∏¥‡∏ö‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h2>
<table class="w-full text-sm border">
<thead class="bg-gray-200">
<tr>
<th class="border px-2">#</th>
<th class="border px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="border px-2">SO</th>
<th class="border px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody>
<template :key="i" x-for="(r, i) in records">
<tr>
<td class="border px-2 text-center" x-text="i+1"></td>
<td class="border px-2" x-text="r.date"></td>
<td class="border px-2" x-text="r.so_number"></td>
<td class="border px-2" x-text="r.items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'"></td>
</tr>
</template>
</tbody>
</table>
</div>
</div>
<script>
function pickingApp() {
  return {
    form: {
      date: '', so_number: '', remarks: '',
      items: []
    },
    records: [],
    addItem() {
      this.form.items.push({ sku: '', batch: '', location: '', qty_wanted: 0, qty_picked: 0, staff: '' });
    },
    removeItem(index) {
      this.form.items.splice(index, 1);
    },
    save() {
      this.records.push(JSON.parse(JSON.stringify(this.form)));
      localStorage.setItem('pickingRecords', JSON.stringify(this.records));
      this.clear();
    },
    clear() {
      this.form = { date: '', so_number: '', remarks: '', items: [] };
    },
    load() {
      const data = localStorage.getItem('pickingRecords');
      if (data) this.records = JSON.parse(data);
    }
  }
}
</script>
</div><div x-cloak="" x-show="open === 'dispatch'" x-transition="">
<div class="max-w-7xl mx-auto bg-white p-6 rounded shadow space-y-6">
<h1 class="text-2xl font-bold text-blue-800">üì¶ Packing &amp; Dispatch</h1>
<!-- ‡∏ü‡∏≠‡∏£‡πå‡∏° -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label class="font-medium">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏à‡∏∏</label>
<input class="w-full mt-1 border px-3 py-2 rounded" type="date" x-model="form.date"/>
</div>
<div>
<label class="font-medium">üìÑ ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà SO / ‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</label>
<input class="w-full mt-1 border px-3 py-2 rounded" type="text" x-model="form.so_number"/>
</div>
<div>
<label class="font-medium">üöö ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
<input class="w-full mt-1 border px-3 py-2 rounded" type="text" x-model="form.delivery"/>
</div>
<div>
<label class="font-medium">üôã‚Äç‚ôÇÔ∏è ‡∏Ñ‡∏ô‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</label>
<input class="w-full mt-1 border px-3 py-2 rounded" type="text" x-model="form.staff"/>
</div>
<div class="md:col-span-2">
<label class="font-medium">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
<textarea class="w-full mt-1 border px-3 py-2 rounded" x-model="form.remarks"></textarea>
</div>
</div>
<!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏£‡∏à‡∏∏ -->
<div>
<h2 class="text-lg font-semibold mt-4 mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏£‡∏£‡∏à‡∏∏</h2>
<table class="w-full border text-sm">
<thead class="bg-blue-100">
<tr>
<th class="border px-2">#</th>
<th class="border px-2">SKU</th>
<th class="border px-2">Batch</th>
<th class="border px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
<th class="border px-2">Location</th>
<th class="border px-2">‡∏•‡∏ö</th>
</tr>
</thead>
<tbody>
<template :key="index" x-for="(item, index) in form.items">
<tr>
<td class="border px-2 text-center" x-text="index+1"></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.sku"/></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.batch"/></td>
<td class="border px-2"><input class="w-20 text-right border-none" type="number" x-model="item.qty"/></td>
<td class="border px-2"><input class="w-full border-none" x-model="item.location"/></td>
<td class="border px-2 text-center">
<button @click="removeItem(index)" class="text-red-500">‡∏•‡∏ö</button>
</td>
</tr>
</template>
</tbody>
</table>
<button @click="addItem()" class="mt-2 bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>
<!-- ‡∏õ‡∏∏‡πà‡∏° -->
<div class="flex space-x-3 mt-4">
<button @click="save()" class="bg-blue-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button @click="clear()" class="bg-gray-400 text-white px-4 py-2 rounded">üßπ ‡∏•‡πâ‡∏≤‡∏á</button>
</div>
<!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
<div>
<h2 class="text-lg font-semibold mt-6 mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</h2>
<table class="w-full text-sm border">
<thead class="bg-gray-200">
<tr>
<th class="border px-2">#</th>
<th class="border px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th class="border px-2">SO</th>
<th class="border px-2">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÇ‡∏î‡∏¢</th>
<th class="border px-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
</tr>
</thead>
<tbody>
<template :key="i" x-for="(r, i) in records">
<tr>
<td class="border px-2 text-center" x-text="i+1"></td>
<td class="border px-2" x-text="r.date"></td>
<td class="border px-2" x-text="r.so_number"></td>
<td class="border px-2" x-text="r.staff"></td>
<td class="border px-2" x-text="r.items.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'"></td>
</tr>
</template>
</tbody>
</table>
</div>
</div>
<script>
function dispatchApp() {
  return {
    form: {
      date: '', so_number: '', delivery: '', staff: '', remarks: '',
      items: []
    },
    records: [],
    addItem() {
      this.form.items.push({ sku: '', batch: '', qty: 0, location: '' });
    },
    removeItem(index) {
      this.form.items.splice(index, 1);
    },
    save() {
      this.records.push(JSON.parse(JSON.stringify(this.form)));
      localStorage.setItem('dispatchRecords', JSON.stringify(this.records));
      this.clear();
    },
    clear() {
      this.form = { date: '', so_number: '', delivery: '', staff: '', remarks: '', items: [] };
    },
    load() {
      const data = localStorage.getItem('dispatchRecords');
      if (data) this.records = JSON.parse(data);
    }
  }
}
</script>
</div><div x-cloak="" x-show="open === 'kpi'" x-transition="">
<div class="container">
<div class="dashboard-title">üìà Warehouse Dashboard &amp; KPI</div>
<div class="chart-container">
<h5>üì¶ ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
<canvas height="100" id="movementChart"></canvas>
</div>
<div class="chart-container">
<h5>üèÜ Top 10 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏¥‡∏Å‡∏ö‡πà‡∏≠‡∏¢</h5>
<canvas height="100" id="topItemsChart"></canvas>
</div>
<div class="chart-container">
<h5>‚úÖ Accuracy ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏à‡∏£‡∏¥‡∏á</h5>
<canvas height="100" id="accuracyChart"></canvas>
</div>
<div class="chart-container">
<h5>üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô 30 ‡∏ß‡∏±‡∏ô</h5>
<canvas height="100" id="expiryChart"></canvas>
</div>
</div>
<script>
    new Chart(document.getElementById('movementChart'), {
      type: 'line',
      data: {
        labels: ['‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.'],
        datasets: [
          { label: 'Inbound', data: [120, 150, 100, 180, 160, 140], borderColor: '#198754', fill: false },
          { label: 'Outbound', data: [100, 140, 90, 170, 150, 130], borderColor: '#dc3545', fill: false }
        ]
      }
    });

    new Chart(document.getElementById('topItemsChart'), {
      type: 'bar',
      data: {
        labels: ['DENT-001', 'DENT-002', 'DENT-003', 'DENT-004', 'DENT-005', 'DENT-006', 'DENT-007', 'DENT-008', 'DENT-009', 'DENT-010'],
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ö‡∏¥‡∏Å',
          data: [50, 45, 40, 38, 36, 35, 30, 28, 25, 20],
          backgroundColor: '#0d6efd'
        }]
      }
    });

    new Chart(document.getElementById('accuracyChart'), {
      type: 'doughnut',
      data: {
        labels: ['‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'],
        datasets: [{
          data: [95, 5],
          backgroundColor: ['#198754', '#dc3545']
        }]
      }
    });

    new Chart(document.getElementById('expiryChart'), {
      type: 'bar',
      data: {
        labels: ['DENT-001', 'DENT-003', 'DENT-007'],
        datasets: [{
          label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏',
          data: [20, 15, 10],
          backgroundColor: '#ffc107'
        }]
      }
    });
  </script>
</div><div x-cloak="" x-show="open === 'onhand'" x-transition="">
<div class="container">
<h3 class="text-2xl font-bold text-blue-800 mb-4">üìä On-hand Status Monitor</h3>
<div class="row mb-3">
<div class="col-md-4">
<input class="w-full md:w-1/3 border px-3 py-2 rounded shadow-sm" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ SKU ‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." type="text"/>
</div>
</div>
<table class="w-full table-auto border-collapse shadow text-sm" id="statusTable">
<thead class="bg-gray-200 text-gray-700 text-sm uppercase">
<tr>
<th class="px-3 py-2 border">#</th>
<th class="px-3 py-2 border">SKU</th>
<th class="px-3 py-2 border">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
<th class="px-3 py-2 border">‡∏Ñ‡∏•‡∏±‡∏á</th>
<th class="px-3 py-2 border">Location</th>
<th class="px-3 py-2 border">On Hand</th>
<th class="px-3 py-2 border">Reserved</th>
<th class="px-3 py-2 border">Picking</th>
<th class="px-3 py-2 border">Transfer</th>
<th class="px-3 py-2 border">Receiving</th>
<th class="px-3 py-2 border">Available</th>
<th class="px-3 py-2 border">FEFO Batch</th>
</tr>
</thead>
<tbody id="statusList"></tbody>
</table>
</div>
<script>
    const data = [
      {
        sku: "DENT-001",
        name: "‡∏ñ‡∏∏‡∏á‡∏°‡∏∑‡∏≠‡∏¢‡∏≤‡∏á",
        warehouse: "WH-A",
        location: "A1-01",
        onHand: 120,
        reserved: 10,
        picking: 5,
        transfer: 3,
        receiving: 0,
        fefoBatch: "B001 / 2025-10-01"
      },
      {
        sku: "DENT-002",
        name: "‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠",
        warehouse: "WH-A",
        location: "A1-02",
        onHand: 80,
        reserved: 20,
        picking: 5,
        transfer: 10,
        receiving: 15,
        fefoBatch: "B002 / 2025-11-15"
      }
    ];

    function renderTable() {
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      const list = document.getElementById("statusList");
      list.innerHTML = "";

      data
        .filter(item =>
          item.sku.toLowerCase().includes(keyword) || item.name.toLowerCase().includes(keyword)
        )
        .forEach((item, index) => {
          const available = item.onHand - item.reserved - item.picking - item.transfer;
          const row = `<tr>
            <td>${index + 1}</td>
            <td>${item.sku}</td>
            <td>${item.name}</td>
            <td>${item.warehouse}</td>
            <td>${item.location}</td>
            <td>${item.onHand}</td>
            <td>${item.reserved}</td>
            <td>${item.picking}</td>
            <td>${item.transfer}</td>
            <td>${item.receiving}</td>
            <td>${available}</td>
            <td>${item.fefoBatch}</td>
          </tr>`;
          list.insertAdjacentHTML("beforeend", row);
        });
    }

    document.getElementById("searchInput").addEventListener("input", renderTable);
    window.onload = renderTable;
    function purchaseRequisitionApp() {
  return {
    form: {
      prNo: '',
      date: '',
      department: '',
      requestedBy: '',
      requiredDate: '',
      note: '',
      items: []
    },
    savedPRs: [],

    loadPRs() {
      const data = localStorage.getItem('savedPRs');
      this.savedPRs = data ? JSON.parse(data) : [];
      this.resetForm();
    },

    generatePRNo() {
      const num = this.savedPRs.length + 1;
      return `PR-${String(num).padStart(6, '0')}`;
    },

    addItem() {
      this.form.items.push({ code: '', name: '', qty: 1, unit: '', price: 0 });
    },

    removeItem(index) {
      this.form.items.splice(index, 1);
    },

    updateTotal(index) {
      // auto calculate handled via x-text in template
    },

    savePR() {
      if (!this.form.date || !this.form.department || !this.form.requestedBy) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
        return;
      }
      this.savedPRs.push({ ...this.form });
      localStorage.setItem('savedPRs', JSON.stringify(this.savedPRs));
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      this.resetForm();
    },

    resetForm() {
      this.form = {
        prNo: this.generatePRNo(),
        date: new Date().toISOString().split('T')[0],
        department: '',
        requestedBy: '',
        requiredDate: '',
        note: '',
        items: []
      };
    }
  };
}
function rfqApp() {
  return {
    form: {
      rfqNo: '',
      date: '',
      dueDate: '',
      suppliers: [],
      items: []
    },
    savedRFQs: [],

    loadRFQs() {
      const data = localStorage.getItem('savedRFQs');
      this.savedRFQs = data ? JSON.parse(data) : [];
      this.resetForm();
    },

    generateRFQNo() {
      const num = this.savedRFQs.length + 1;
      return `RFQ-${String(num).padStart(6, '0')}`;
    },

    addSupplier() {
      this.form.suppliers.push('');
    },

    removeSupplier(index) {
      this.form.suppliers.splice(index, 1);
    },

    addItem() {
      this.form.items.push({ code: '', name: '', qty: 1, unit: '' });
    },

    removeItem(index) {
      this.form.items.splice(index, 1);
    },

    saveRFQ() {
      if (!this.form.date || this.form.suppliers.length === 0 || this.form.items.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô");
        return;
      }
      this.savedRFQs.push({ ...this.form });
      localStorage.setItem('savedRFQs', JSON.stringify(this.savedRFQs));
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å RFQ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      this.resetForm();
    },

    resetForm() {
      this.form = {
        rfqNo: this.generateRFQNo(),
        date: new Date().toISOString().split('T')[0],
        dueDate: '',
        suppliers: [],
        items: []
      };
    }
  };
}
function poApp() {
  return {
    form: {
      poNo: '',
      date: '',
      supplier: '',
      address: '',
      creditTerm: '',
      paymentTerm: '',
      items: [],
      subtotal: 0,
      discount: 0,
      vat: 7,
      total: 0
    },
    savedPOs: [],

    loadPOs() {
      const data = localStorage.getItem('savedPOs');
      this.savedPOs = data ? JSON.parse(data) : [];
      this.resetForm();
    },

    generatePONo() {
      const now = new Date();
      const y = now.getFullYear();
      const num = this.savedPOs.length + 1;
      return `PO-${y}-${String(num).padStart(4, '0')}`;
    },

    addItem() {
      this.form.items.push({ code: '', name: '', qty: 1, price: 0 });
      this.calcTotal();
    },

    removeItem(i) {
      this.form.items.splice(i, 1);
      this.calcTotal();
    },

    calcTotal() {
      const sub = this.form.items.reduce((sum, i) => sum + i.qty * i.price, 0);
      this.form.subtotal = sub.toFixed(2);
      const discount = this.form.discount || 0;
      const vatRate = this.form.vat || 0;
      const afterDiscount = sub - discount;
      const vat = afterDiscount * vatRate / 100;
      this.form.total = (afterDiscount + vat).toFixed(2);
    },

    savePO() {
      if (!this.form.date || !this.form.supplier || this.form.items.length === 0) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        return;
      }
      this.savedPOs.push({ ...this.form });
      localStorage.setItem('savedPOs', JSON.stringify(this.savedPOs));
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PO ‡πÅ‡∏•‡πâ‡∏ß');
      this.resetForm();
    },

    resetForm() {
      this.form = {
        poNo: this.generatePONo(),
        date: new Date().toISOString().split('T')[0],
        supplier: '',
        address: '',
        creditTerm: '',
        paymentTerm: '',
        items: [],
        subtotal: 0,
        discount: 0,
        vat: 7,
        total: 0
      };
    }
  };
}
function grnApp() {
  return {
    form: {
      grnNo: '',
      date: '',
      poNo: '',
      receiver: '',
      note: '',
      items: []
    },
    savedGRNs: [],

    loadGRNs() {
      const data = localStorage.getItem('savedGRNs');
      this.savedGRNs = data ? JSON.parse(data) : [];
      this.resetForm();
    },

    generateGRNNo() {
      const num = this.savedGRNs.length + 1;
      return `GRN-${String(num).padStart(6, '0')}`;
    },

    addItem() {
      this.form.items.push({ code: '', name: '', qty: 1, batch: '', expiry: '' });
    },

    removeItem(index) {
      this.form.items.splice(index, 1);
    },

    saveGRN() {
      if (!this.form.date || !this.form.poNo || !this.form.receiver || this.form.items.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return;
      }
      this.savedGRNs.push({ ...this.form });
      localStorage.setItem('savedGRNs', JSON.stringify(this.savedGRNs));
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GRN ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      this.resetForm();
    },

    resetForm() {
      this.form = {
        grnNo: this.generateGRNNo(),
        date: new Date().toISOString().split('T')[0],
        poNo: '',
        receiver: '',
        note: '',
        items: []
      };
    }
  };
}
function supplierApp() {
  return {
    form: {
      code: '',
      name: '',
      type: '',
      address: '',
      phone: '',
      email: '',
      website: '',
      taxId: '',
      rating: 3
    },
    suppliers: [],

    loadSuppliers() {
      const data = localStorage.getItem('suppliers');
      this.suppliers = data ? JSON.parse(data) : [];
    },

    saveSupplier() {
      if (!this.form.code || !this.form.name) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Supplier Code ‡πÅ‡∏•‡∏∞ Name");
        return;
      }
      this.suppliers.push({ ...this.form });
      localStorage.setItem('suppliers', JSON.stringify(this.suppliers));
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
      this.resetForm();
    },

    deleteSupplier(index) {
      if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
        this.suppliers.splice(index, 1);
        localStorage.setItem('suppliers', JSON.stringify(this.suppliers));
      }
    },

    resetForm() {
      this.form = {
        code: '',
        name: '',
        type: '',
        address: '',
        phone: '',
        email: '',
        website: '',
        taxId: '',
        rating: 3
      };
    }
  };
}
function invoiceApp() {
  return {
    form: {
      invoiceNo: '',
      date: '',
      dueDate: '',
      poNo: '',
      total: 0,
      items: []
    },
    savedInvoices: [],

    loadInvoices() {
      const data = localStorage.getItem('invoices');
      this.savedInvoices = data ? JSON.parse(data) : [];
      this.resetForm();
    },

    generateInvoiceNo() {
      const num = this.savedInvoices.length + 1;
      return `INV-${String(num).padStart(6, '0')}`;
    },

    addItem() {
      this.form.items.push({ name: '', qty: 1, price: 0 });
      this.calcTotal();
    },

    removeItem(index) {
      this.form.items.splice(index, 1);
      this.calcTotal();
    },

    calcTotal() {
      const sum = this.form.items.reduce((t, i) => t + i.qty * i.price, 0);
      this.form.total = sum.toFixed(2);
    },

    saveInvoice() {
      if (!this.form.date || !this.form.poNo || this.form.items.length === 0) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
        return;
      }
      this.savedInvoices.push({ ...this.form });
      localStorage.setItem('invoices', JSON.stringify(this.savedInvoices));
      alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß");
      this.resetForm();
    },

    resetForm() {
      this.form = {
        invoiceNo: this.generateInvoiceNo(),
        date: new Date().toISOString().split('T')[0],
        dueDate: '',
        poNo: '',
        total: 0,
        items: []
      };
    }
  };
}
function reportApp() {
  return {
    fromDate: '',
    toDate: '',
    poList: [],
    filteredPOs: [],
    supplierCount: {},

    loadAllData() {
      const po = localStorage.getItem('pos');
      this.poList = po ? JSON.parse(po) : [];
      this.filteredPOs = this.poList;
      this.countSuppliers();
    },

    formatNumber(num) {
      return parseFloat(num).toLocaleString();
    },

    filter() {
      if (!this.fromDate || !this.toDate) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà");
        return;
      }
      this.filteredPOs = this.poList.filter(po => {
        return po.date >= this.fromDate && po.date <= this.toDate;
      });
      this.countSuppliers();
    },

    countSuppliers() {
      this.supplierCount = {};
      this.filteredPOs.forEach(po => {
        if (!this.supplierCount[po.supplier]) this.supplierCount[po.supplier] = 0;
        this.supplierCount[po.supplier]++;
      });
    },

    exportCSV() {
      let csv = 'PO No,Date,Supplier,Total\n';
      this.filteredPOs.forEach(po => {
        csv += `${po.poNo},${po.date},${po.supplier},${po.total}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'report.csv';
      link.click();
    }
  };
}
function auditApp() {
  return {
    logs: [],
    search: '',
    typeFilter: '',

    loadLogs() {
      const data = localStorage.getItem('auditLogs');
      this.logs = data ? JSON.parse(data) : [];
    },

    filteredLogs() {
      return this.logs.filter(log => {
        const matchesSearch = this.search === '' || log.detail.toLowerCase().includes(this.search.toLowerCase());
        const matchesType = this.typeFilter === '' || log.action === this.typeFilter;
        return matchesSearch && matchesType;
      }).sort((a, b) => new Date(b.time) - new Date(a.time));
    }
  };
}

// üîÅ ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
function addAuditLog(action, detail, user = "admin") {
  const logs = JSON.parse(localStorage.getItem('auditLogs') || '[]');
  logs.push({
    time: new Date().toLocaleString(),
    user: user,
    action: action,       // ‡πÄ‡∏ä‡πà‡∏ô "Create", "Edit", "Delete"
    detail: detail        // ‡πÄ‡∏ä‡πà‡∏ô "Created PO PO-000123"
  });
  localStorage.setItem('auditLogs', JSON.stringify(logs));
}

  </script>
</div>
</div>
<div x-show="mainTab === 'purchase'" x-cloak>
<div x-show="open === 'pr'" x-cloak class="bg-white p-6 rounded shadow" x-data="prApp()" x-init="loadPRs()">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold">üìù Purchase Requisition (PR)</h2>
    <div class="space-x-2">
      <button @click="savePR()" class="px-4 py-2 rounded text-white bg-blue-600 hover:bg-blue-700">üíæ Save</button>
      <button @click="resetForm()" class="px-4 py-2 rounded border">‚ôªÔ∏è Reset</button>
    </div>
  </div>

  <!-- Form -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <input x-model="form.prNo" class="border px-3 py-2 rounded w-full bg-gray-50" readonly>
    <input x-model="form.date" type="date" class="border px-3 py-2 rounded w-full">
    <input x-model="form.department" class="border px-3 py-2 rounded w-full" placeholder="Department">
    <input x-model="form.requestedBy" class="border px-3 py-2 rounded w-full" placeholder="Requested by">
    <input x-model="form.requiredDate" type="date" class="border px-3 py-2 rounded w-full">
    <input x-model="form.note" class="border px-3 py-2 rounded w-full md:col-span-3" placeholder="Note">
  </div>

  <!-- Items -->
  <div class="overflow-auto border rounded">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">Code</th>
          <th class="p-2">Name</th>
          <th class="p-2">Qty</th>
          <th class="p-2">Unit</th>
          <th class="p-2">Note</th>
          <th class="p-2">‚Äî</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(it,i) in form.items" :key="i">
          <tr class="border-t">
            <td class="p-2"><input x-model="it.code" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model="it.name" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model.number="it.qty" type="number" min="1" class="border px-2 py-1 rounded w-full text-right"></td>
            <td class="p-2"><input x-model="it.unit" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model="it.note" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2 text-center"><button @click="removeItem(i)" class="text-red-600">üóëÔ∏è</button></td>
          </tr>
        </template>
        <tr>
          <td colspan="6" class="text-center p-2">
            <button @click="addItem()" class="px-3 py-1 rounded border">‚ûï Add Item</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- List -->
  <div class="mt-6">
    <h3 class="font-semibold mb-2">Saved PRs</h3>
    <table class="min-w-full text-sm border rounded">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">PR No</th>
          <th class="p-2">Date</th>
          <th class="p-2">Dept</th>
          <th class="p-2">Action</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(r,i) in savedPRs" :key="r.prNo">
          <tr class="border-t hover:bg-gray-50">
            <td class="p-2" x-text="r.prNo"></td>
            <td class="p-2" x-text="r.date"></td>
            <td class="p-2" x-text="r.department"></td>
            <td class="p-2">
              <button @click="createRFQFromPR(r)" class="text-blue-600">‚û°Ô∏è Create RFQ</button>
            </td>
          </tr>
        </template>
        <tr x-show="savedPRs.length===0">
          <td colspan="4" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div x-show="open === 'rfq'" x-cloak class="bg-white p-6 rounded shadow" x-data="rfqApp()" x-init="loadRFQs()">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold">üì§ Request for Quotation (RFQ)</h2>
    <div class="space-x-2">
      <button @click="saveRFQ()" class="px-4 py-2 rounded text-white bg-blue-600 hover:bg-blue-700">üíæ Save</button>
      <button @click="resetForm()" class="px-4 py-2 rounded border">‚ôªÔ∏è Reset</button>
    </div>
  </div>

  <!-- Form -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <input x-model="form.rfqNo" class="border px-3 py-2 rounded w-full bg-gray-50" readonly>
    <input x-model="form.date" type="date" class="border px-3 py-2 rounded w-full">
    <input x-model="form.dueDate" type="date" class="border px-3 py-2 rounded w-full">
  </div>

  <!-- Suppliers -->
  <div class="overflow-auto border rounded mb-4">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">Supplier</th>
          <th class="p-2">‚Äî</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(s,i) in form.suppliers" :key="i">
          <tr class="border-t">
            <td class="p-2"><input x-model="form.suppliers[i]" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2 text-center"><button @click="removeSupplier(i)" class="text-red-600">üóëÔ∏è</button></td>
          </tr>
        </template>
        <tr>
          <td colspan="2" class="text-center p-2">
            <button @click="addSupplier()" class="px-3 py-1 rounded border">‚ûï Add Supplier</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Items -->
  <div class="overflow-auto border rounded">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">Code</th>
          <th class="p-2">Name</th>
          <th class="p-2">Qty</th>
          <th class="p-2">Unit</th>
          <th class="p-2">‚Äî</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(it,i) in form.items" :key="i">
          <tr class="border-t">
            <td class="p-2"><input x-model="it.code" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model="it.name" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model.number="it.qty" type="number" min="1" class="border px-2 py-1 rounded w-full text-right"></td>
            <td class="p-2"><input x-model="it.unit" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2 text-center"><button @click="removeItem(i)" class="text-red-600">üóëÔ∏è</button></td>
          </tr>
        </template>
        <tr>
          <td colspan="5" class="text-center p-2">
            <button @click="addItem()" class="px-3 py-1 rounded border">‚ûï Add Item</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- List -->
  <div class="mt-6">
    <h3 class="font-semibold mb-2">Saved RFQs</h3>
    <table class="min-w-full text-sm border rounded">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">RFQ No</th>
          <th class="p-2">Date</th>
          <th class="p-2">Linked PR</th>
          <th class="p-2">Action</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(r,i) in savedRFQs" :key="r.rfqNo">
          <tr class="border-t hover:bg-gray-50">
            <td class="p-2" x-text="r.rfqNo"></td>
            <td class="p-2" x-text="r.date"></td>
            <td class="p-2" x-text="r.linkPRNo"></td>
            <td class="p-2">
              <button @click="createPOFromRFQ(r)" class="text-green-600">‚û°Ô∏è Create PO</button>
            </td>
          </tr>
        </template>
        <tr x-show="savedRFQs.length===0">
          <td colspan="4" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<div x-show="open === 'po'" x-cloak class="bg-white p-6 rounded shadow" x-data="poApp()" x-init="loadPOs()">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-semibold">üìë Purchase Order (PO)</h2>
    <div class="space-x-2">
      <button @click="savePO()" class="px-4 py-2 rounded text-white bg-blue-600 hover:bg-blue-700">üíæ Save</button>
      <button @click="resetForm()" class="px-4 py-2 rounded border">‚ôªÔ∏è Reset</button>
    </div>
  </div>

  <!-- Form -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
    <input x-model="form.poNo" class="border px-3 py-2 rounded w-full bg-gray-50" readonly>
    <input x-model="form.date" type="date" class="border px-3 py-2 rounded w-full">
    <input x-model="form.supplier" class="border px-3 py-2 rounded w-full" placeholder="Supplier">
    <input x-model="form.address" class="border px-3 py-2 rounded w-full md:col-span-3" placeholder="Address">
    <input x-model="form.creditTerm" class="border px-3 py-2 rounded w-full" placeholder="Credit term">
    <input x-model="form.paymentTerm" class="border px-3 py-2 rounded w-full" placeholder="Payment term">
  </div>

  <!-- Items -->
  <div class="overflow-auto border rounded mb-4">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">Code</th>
          <th class="p-2">Name</th>
          <th class="p-2">Qty</th>
          <th class="p-2">Price</th>
          <th class="p-2">Amount</th>
          <th class="p-2">‚Äî</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(it,i) in form.items" :key="i">
          <tr class="border-t">
            <td class="p-2"><input x-model="it.code" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model="it.name" class="border px-2 py-1 rounded w-full"></td>
            <td class="p-2"><input x-model.number="it.qty" type="number" min="1" class="border px-2 py-1 rounded w-full text-right" @input="calcTotal()"></td>
            <td class="p-2"><input x-model.number="it.price" type="number" step="0.01" class="border px-2 py-1 rounded w-full text-right" @input="calcTotal()"></td>
            <td class="p-2 text-right" x-text="(Number(it.qty||0)*Number(it.price||0)).toFixed(2)"></td>
            <td class="p-2 text-center"><button @click="removeItem(i)" class="text-red-600">üóëÔ∏è</button></td>
          </tr>
        </template>
        <tr>
          <td colspan="6" class="text-center p-2">
            <button @click="addItem()" class="px-3 py-1 rounded border">‚ûï Add Item</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Totals -->
  <div class="text-right space-y-1 mb-6">
    <div>Subtotal: <span x-text="form.subtotal.toFixed(2)"></span></div>
    <div>
      Discount: 
      <input x-model.number="form.discount" type="number" step="0.01" class="border px-2 py-1 rounded w-24 text-right" @input="calcTotal()">
    </div>
    <div>
      VAT(%): 
      <input x-model.number="form.vat" type="number" step="0.01" class="border px-2 py-1 rounded w-24 text-right" @input="calcTotal()">
    </div>
    <div class="font-semibold">Total: <span x-text="form.total.toFixed(2)"></span></div>
  </div>

  <!-- List -->
  <div class="mt-6">
    <h3 class="font-semibold mb-2">Saved POs</h3>
    <table class="min-w-full text-sm border rounded">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2">PO No</th>
          <th class="p-2">Date</th>
          <th class="p-2">Supplier</th>
          <th class="p-2">Linked RFQ</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="r in savedPOs" :key="r.poNo">
          <tr class="border-t hover:bg-gray-50">
            <td class="p-2" x-text="r.poNo"></td>
            <td class="p-2" x-text="r.date"></td>
            <td class="p-2" x-text="r.supplier"></td>
            <td class="p-2" x-text="r.linkRFQNo"></td>
          </tr>
        </template>
        <tr x-show="savedPOs.length===0">
          <td colspan="4" class="text-center text-gray-500 p-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<div x-show="open === 'grn'" x-data="grnApp()" x-init="loadGRNs()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">
    <h2 class="text-xl font-bold">üì• Goods Received Note (GRN)</h2>

    <!-- Header -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label>GRN No.</label><input class="w-full border rounded p-2 bg-gray-100" x-model="form.grnNo" readonly /></div>
      <div><label>Receive Date</label><input class="w-full border rounded p-2" type="date" x-model="form.date" /></div>
      <div><label>PO No. (Reference)</label><input class="w-full border rounded p-2" x-model="form.poNo" /></div>
      <div><label>Received By</label><input class="w-full border rounded p-2" x-model="form.receiver" /></div>
      <div><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input class="w-full border rounded p-2" x-model="form.note" /></div>
    </div>

    <!-- Items -->
    <div class="border-t pt-4">
      <h3 class="font-semibold mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-1">Item Code</th>
            <th class="p-1">Item Name</th>
            <th class="p-1">Qty Received</th>
            <th class="p-1">Batch No.</th>
            <th class="p-1">Expiry Date</th>
            <th class="p-1">‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(item, i) in form.items" :key="i">
            <tr>
              <td><input class="border rounded p-1 w-full" x-model="item.code" /></td>
              <td><input class="border rounded p-1 w-full" x-model="item.name" /></td>
              <td><input class="border rounded p-1 w-full" type="number" x-model.number="item.qty" /></td>
              <td><input class="border rounded p-1 w-full" x-model="item.batch" /></td>
              <td><input class="border rounded p-1 w-full" type="date" x-model="item.expiry" /></td>
              <td class="text-center"><button class="text-red-600" @click="removeItem(i)">‡∏•‡∏ö</button></td>
            </tr>
          </template>
        </tbody>
      </table>
      <button class="mt-2 bg-blue-500 text-white px-3 py-1 rounded" @click="addItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>

    <!-- Action -->
    <div class="flex justify-between pt-4">
      <button class="bg-gray-400 text-white px-4 py-2 rounded" @click="resetForm()">‚ôªÔ∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      <button class="bg-green-600 text-white px-4 py-2 rounded" @click="saveGRN()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å GRN</button>
    </div>

    <!-- List -->
    <div class="border-t pt-4">
      <h3 class="font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ GRN ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-1">GRN No.</th>
            <th class="p-1">Date</th>
            <th class="p-1">PO No.</th>
            <th class="p-1">Received By</th>
            <th class="p-1">Items</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(grn, i) in savedGRNs" :key="i">
            <tr class="hover:bg-gray-50">
              <td class="p-1" x-text="grn.grnNo"></td>
              <td class="p-1" x-text="grn.date"></td>
              <td class="p-1" x-text="grn.poNo"></td>
              <td class="p-1" x-text="grn.receiver"></td>
              <td class="p-1 text-center" x-text="grn.items.length"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div x-show="open === 'supplier'" x-data="supplierApp()" x-init="loadSuppliers()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">
    <h2 class="text-xl font-bold">üè∑Ô∏è Supplier Management</h2>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label>Supplier Code</label><input class="w-full border p-2 rounded" x-model="form.code" /></div>
      <div><label>Supplier Name</label><input class="w-full border p-2 rounded" x-model="form.name" /></div>
      <div><label>Product/Service Type</label><input class="w-full border p-2 rounded" x-model="form.type" /></div>
      <div class="md:col-span-3"><label>Address</label><textarea class="w-full border p-2 rounded" x-model="form.address" rows="2"></textarea></div>
      <div><label>Phone</label><input class="w-full border p-2 rounded" x-model="form.phone" /></div>
      <div><label>Email</label><input class="w-full border p-2 rounded" x-model="form.email" /></div>
      <div><label>Website</label><input class="w-full border p-2 rounded" x-model="form.website" /></div>
      <div><label>Tax ID</label><input class="w-full border p-2 rounded" x-model="form.taxId" /></div>
      <div><label>Rating (1‚Äì5)</label><input class="w-full border p-2 rounded" type="number" min="1" max="5" x-model.number="form.rating" /></div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° -->
    <div class="flex justify-between pt-4">
      <button class="bg-gray-400 text-white px-4 py-2 rounded" @click="resetForm()">‚ôªÔ∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      <button class="bg-green-600 text-white px-4 py-2 rounded" @click="saveSupplier()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Supplier</button>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å -->
    <div class="border-t pt-4">
      <h3 class="font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Ç‡∏≤‡∏¢</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-1">Code</th>
            <th class="p-1">Name</th>
            <th class="p-1">Type</th>
            <th class="p-1">Rating</th>
            <th class="p-1">‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(s, i) in suppliers" :key="i">
            <tr class="hover:bg-gray-50">
              <td class="p-1" x-text="s.code"></td>
              <td class="p-1" x-text="s.name"></td>
              <td class="p-1" x-text="s.type"></td>
              <td class="p-1 text-center" x-text="s.rating"></td>
              <td class="p-1 text-center"><button class="text-red-600" @click="deleteSupplier(i)">‡∏•‡∏ö</button></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div x-show="open === 'invoice'" x-data="invoiceApp()" x-init="loadInvoices()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">
    <h2 class="text-xl font-bold">üìë Invoice Verification</h2>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label>Invoice No.</label><input class="w-full border p-2 rounded bg-gray-100" x-model="form.invoiceNo" readonly /></div>
      <div><label>Invoice Date</label><input class="w-full border p-2 rounded" type="date" x-model="form.date" /></div>
      <div><label>Due Date</label><input class="w-full border p-2 rounded" type="date" x-model="form.dueDate" /></div>
      <div><label>PO No. (Reference)</label><input class="w-full border p-2 rounded" x-model="form.poNo" /></div>
      <div><label>Total Amount</label><input class="w-full border p-2 rounded bg-gray-100" x-model="form.total" readonly /></div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ -->
    <div class="border-t pt-4">
      <h3 class="font-semibold mb-2">üì¶ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-1">Item</th>
            <th class="p-1">Qty</th>
            <th class="p-1">Price</th>
            <th class="p-1">Total</th>
            <th class="p-1">‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(item, i) in form.items" :key="i">
            <tr>
              <td><input class="border rounded p-1 w-full" x-model="item.name" /></td>
              <td><input class="border rounded p-1 w-full" type="number" x-model.number="item.qty" @input="calcTotal()" /></td>
              <td><input class="border rounded p-1 w-full" type="number" x-model.number="item.price" @input="calcTotal()" /></td>
              <td class="text-right px-2" x-text="(item.qty * item.price).toFixed(2)"></td>
              <td class="text-center"><button class="text-red-600" @click="removeItem(i)">‡∏•‡∏ö</button></td>
            </tr>
          </template>
        </tbody>
      </table>
      <button class="mt-2 bg-blue-500 text-white px-3 py-1 rounded" @click="addItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° -->
    <div class="flex justify-between pt-4">
      <button class="bg-gray-400 text-white px-4 py-2 rounded" @click="resetForm()">‚ôªÔ∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      <button class="bg-green-600 text-white px-4 py-2 rounded" @click="saveInvoice()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</button>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ -->
    <div class="border-t pt-4">
      <h3 class="font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Invoice</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-1">Invoice No.</th>
            <th class="p-1">Date</th>
            <th class="p-1">PO Ref</th>
            <th class="p-1">Total</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="(inv, i) in savedInvoices" :key="i">
            <tr class="hover:bg-gray-50">
              <td class="p-1" x-text="inv.invoiceNo"></td>
              <td class="p-1" x-text="inv.date"></td>
              <td class="p-1" x-text="inv.poNo"></td>
              <td class="p-1 text-right" x-text="inv.total"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div x-show="open === 'reporting'" x-data="reportApp()" x-init="loadAllData()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">
    <h2 class="text-xl font-bold">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (Purchasing Reports)</h2>

    <!-- Filter -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label>‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" class="w-full border p-2 rounded" x-model="fromDate" /></div>
      <div><label>‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="w-full border p-2 rounded" x-model="toDate" /></div>
      <div class="flex items-end"><button class="bg-blue-600 text-white px-4 py-2 rounded w-full" @click="filter()">üìÜ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button></div>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PO -->
    <div>
      <h3 class="text-lg font-semibold mt-4">üõí ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (PO)</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200"><tr>
          <th class="p-1">PO No.</th><th class="p-1">Date</th><th class="p-1">Supplier</th><th class="p-1">Total</th>
        </tr></thead>
        <tbody>
          <template x-for="po in filteredPOs" :key="po.poNo">
            <tr class="hover:bg-gray-50">
              <td class="p-1" x-text="po.poNo"></td>
              <td class="p-1" x-text="po.date"></td>
              <td class="p-1" x-text="po.supplier"></td>
              <td class="p-1 text-right" x-text="formatNumber(po.total)"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Supplier -->
    <div>
      <h3 class="text-lg font-semibold mt-4">üè∑Ô∏è Top Supplier</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200"><tr>
          <th class="p-1">Supplier</th><th class="p-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
        </tr></thead>
        <tbody>
          <template x-for="(count, name) in supplierCount" :key="name">
            <tr><td class="p-1" x-text="name"></td><td class="p-1 text-center" x-text="count"></td></tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° Export -->
    <div class="flex justify-end pt-4">
      <button class="bg-green-700 text-white px-4 py-2 rounded" @click="exportCSV()">üì§ Export CSV</button>
    </div>
  </div>
</div>

<div x-show="open === 'audit'" x-data="auditApp()" x-init="loadLogs()" x-cloak>
  <div class="bg-white p-6 rounded shadow max-w-7xl mx-auto space-y-6">
    <h2 class="text-xl font-bold">üïµÔ∏è Audit Trail / Logs</h2>

    <!-- Search Filters -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div><label>‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label><input class="w-full border p-2 rounded" x-model="search" placeholder="PO-000123, Supplier, etc." /></div>
      <div><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
        <select class="w-full border p-2 rounded" x-model="typeFilter">
          <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
          <option>Create</option>
          <option>Edit</option>
          <option>Delete</option>
        </select>
      </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Log -->
    <div class="border-t pt-4">
      <h3 class="text-lg font-semibold mb-2">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</h3>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-1">‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th class="p-1">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
            <th class="p-1">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th>
            <th class="p-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="log in filteredLogs()" :key="log.time + log.user">
            <tr class="hover:bg-gray-50">
              <td class="p-1" x-text="log.time"></td>
              <td class="p-1" x-text="log.user"></td>
              <td class="p-1" x-text="log.action"></td>
              <td class="p-1" x-text="log.detail"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>
</div>

</div>

  </main>
</div>
<script>
function employeeApp() {
  return {
    // state
    employees: [],
    search: '',
    filterPosition: '',
    editingIndex: null,

    // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    form: {
      employeeId: '',
      firstName: '',
      lastName: '',
      nationalId: '',
      dob: '',
      gender: 'Male',
      phone: '',
      email: '',
      department: '',
      position: 'Doctor',
      startDate: '',
      lastDate: '',
      salaryType: 'Part-Time', // Part-Time | Full Time | Percentage
      salaryValue: null        // ‡∏ñ‡πâ‡∏≤ Percentage = ‡∏Ñ‡πà‡∏≤ 0‚Äì100 (‡πÄ‡∏ä‡πà‡∏ô 50), ‡∏ñ‡πâ‡∏≤ THB = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
    },

    // UI ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    salarySuffix: 'THB/Hr',
    salaryPlaceholder: '60',
    salaryDisplay: '', // string ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    init() {
      this.load();
      this.assignEmployeeId();
      this.onSalaryTypeChange(this.form.salaryType);

      // sync display ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      if (this.form.salaryType === 'Percentage') {
        this.salaryDisplay = this.form.salaryValue != null ? String(this.form.salaryValue) : '';
      } else {
        this.salaryDisplay = this.form.salaryValue != null ? Number(this.form.salaryValue).toLocaleString('en-US') : '';
      }

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï suffix/placeholder ‡πÅ‡∏•‡∏∞ display ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏ô‡∏¥‡∏î
      this.$watch('form.salaryType', (val) => this.onSalaryTypeChange(val));
    },

    // ‡πÇ‡∏´‡∏•‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£
    load() {
      this.employees = JSON.parse(localStorage.getItem('hrEmployees') || '[]');
    },
    persist() {
      localStorage.setItem('hrEmployees', JSON.stringify(this.employees));
    },

    // ‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö YYXXX ‡∏à‡∏≤‡∏Å ‡∏û.‡∏®. (‡∏õ‡∏µ‡πÑ‡∏ó‡∏¢ = ‡∏Ñ.‡∏®. + 543)
    assignEmployeeId() {
      const thYY = String(new Date().getFullYear() + 543).slice(-2);
      const prefix = thYY;
      const seqs = this.employees
        .filter(e => e.employeeId && e.employeeId.startsWith(prefix))
        .map(e => parseInt(e.employeeId.slice(2)) || 0);
      const next = (seqs.length ? Math.max(...seqs) : 0) + 1;
      this.form.employeeId = `${prefix}${String(next).padStart(3,'0')}`;
    },

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô UI ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    onSalaryTypeChange(val) {
      if (val === 'Part-Time') { this.salarySuffix = 'THB/Hr'; this.salaryPlaceholder = '60'; }
      else if (val === 'Full Time') { this.salarySuffix = 'THB/Month'; this.salaryPlaceholder = '20000'; }
      else { this.salarySuffix = '%'; this.salaryPlaceholder = '50'; }

      // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä display ‡∏à‡∏≤‡∏Å‡∏Ñ‡πà‡∏≤ salaryValue ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      if (val === 'Percentage') {
        this.salaryDisplay = this.form.salaryValue != null ? String(this.form.salaryValue) : '';
      } else {
        this.salaryDisplay = this.form.salaryValue != null ? Number(this.form.salaryValue).toLocaleString('en-US') : '';
      }
    },

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏ó‡∏¢ 13 ‡∏´‡∏•‡∏±‡∏Å
    isNationalIdValid(id) {
      const s = (id || '').replace(/\D/g,'');
      if (s.length !== 13) return false;
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(s[i], 10) * (13 - i);
      }
      const check = (11 - (sum % 11)) % 10;
      return check === parseInt(s[12], 10);
    },

    // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏á‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
    formatNumberWithCommas(nStr) {
      const s = String(nStr).replace(/[^\d.]/g,'');
      const parts = s.split('.');
      let intp = parts[0].replace(/^0+(?=\d)/,''); // ‡∏ï‡∏±‡∏î 0 ‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤
      intp = intp.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      const decp = parts[1] !== undefined ? parts[1].replace(/\D/g,'').slice(0,2) : '';
      return decp ? `${intp}.${decp}` : intp;
    },

    // ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ + ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏Ñ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
    onRateInput(e) {
      // Percentage: ‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤, ‡∏à‡∏≥‡∏Å‡∏±‡∏î 0‚Äì100
      if (this.form.salaryType === 'Percentage') {
        let raw = e.target.value.replace(/[^\d.]/g,'');
        // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏à‡∏∏‡∏î‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        const p = raw.split('.');
        raw = p.shift() + (p.length ? '.' + p.join('') : '');
        let num = raw === '' ? '' : Number(raw);
        if (raw !== '' && !isNaN(num)) {
          if (num < 0) num = 0;
          if (num > 100) num = 100;
        }
        this.salaryDisplay = raw === '' ? '' : String(num);
        this.form.salaryValue = raw === '' ? null : Number(this.salaryDisplay);
        return;
      }

      // THB: ‡πÉ‡∏™‡πà‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤ as-you-type + ‡∏Ñ‡∏á caret
      const el = e.target;
      const start = el.selectionStart;
      const rawBefore = el.value;
      const digitsLeft = rawBefore.slice(0, start).replace(/,/g,'').replace(/[^\d.]/g,'').length;

      // ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï
      const cleaned = rawBefore.replace(/[^0-9.]/g,'');
      const parts = cleaned.split('.');
      const numStr = (parts[0] || '0') + (parts[1] !== undefined ? '.' + parts[1].slice(0,2) : '');
      const formatted = this.formatNumberWithCommas(numStr);

      this.salaryDisplay = formatted;
      this.form.salaryValue = Number((parts[0] || '0') + (parts[1] !== undefined ? '.' + parts[1].slice(0,2) : ''));

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á caret ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡∏°‡∏∑‡∏≠
      this.$nextTick(() => {
        let count = 0, idx = formatted.length;
        for (let i = 0; i < formatted.length; i++) {
          if (formatted[i] !== ',') count++;
          if (count >= digitsLeft) { idx = i + 1; break; }
        }
        el.setSelectionRange(idx, idx);
      });
    },

    // ‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏ö‡∏ô blur (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏™‡πà‡∏Ñ‡∏≠‡∏°‡∏°‡πà‡∏≤‡∏™‡∏ß‡∏¢ ‡πÜ / clamp ‡∏ä‡πà‡∏ß‡∏á)
    onRateBlur() {
      if (this.form.salaryType === 'Percentage') {
        if (this.form.salaryValue != null) {
          let v = Number(this.form.salaryValue);
          if (v < 0) v = 0;
          if (v > 100) v = 100;
          this.form.salaryValue = v;
          this.salaryDisplay = String(v);
        }
      } else {
        if (this.form.salaryValue != null) {
          this.salaryDisplay = Number(this.form.salaryValue)
            .toLocaleString('en-US', { maximumFractionDigits: 2 });
        }
      }
    },

    // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏≤‡∏Å Last Date
    statusFromLastDate(lastDate) {
      if (!lastDate) return 'Active';
      const today = new Date().toISOString().slice(0,10);
      return lastDate < today ? 'Resigned' : 'Active';
    },

    // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏ß‡∏¢ ‡πÜ ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    displaySalary(emp) {
      if (emp.salaryType === 'Percentage') {
        return `${(emp.salaryRaw * 100).toFixed(0)}%`;
      } else if (emp.salaryType === 'Part-Time') {
        return `${Number(emp.salaryRaw).toLocaleString('th-TH')} THB/Hr`;
      } else {
        return `${Number(emp.salaryRaw).toLocaleString('th-TH')} THB/Month`;
      }
    },

    // ‡∏Å‡∏î Save/Update
    save() {
      // validation ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
      if (!this.form.firstName || !this.form.lastName) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å First/Last Name'); return; }
      if (!this.form.position) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Position'); return; }
      if (!this.form.salaryType) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Salary Type'); return; }

      // ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏£‡∏≠‡∏Å)
      if (this.form.nationalId) {
        if (!this.isNationalIdValid(this.form.nationalId)) {
          alert('‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
          return;
        }
      }

      const v = Number(this.form.salaryValue);
      if (this.form.salaryType === 'Percentage') {
        if (isNaN(v) || v < 0 || v > 100) { alert('Percentage ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0‚Äì100'); return; }
      } else {
        if (isNaN(v) || v <= 0) { alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0'); return; }
      }

      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á
      const salaryRaw = this.form.salaryType === 'Percentage' ? (v / 100) : v;

      const payload = {
        employeeId: this.form.employeeId,
        firstName: this.form.firstName.trim(),
        lastName: this.form.lastName.trim(),
        nationalId: this.form.nationalId,
        dob: this.form.dob,
        gender: this.form.gender,
        phone: this.form.phone,
        email: this.form.email,
        department: this.form.department,
        position: this.form.position,
        startDate: this.form.startDate,
        lastDate: this.form.lastDate,
        salaryType: this.form.salaryType,
        salaryRaw: salaryRaw, // ‡∏ñ‡πâ‡∏≤ Percentage = 0.5, ‡∏ñ‡πâ‡∏≤ THB = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏≤‡∏ó
      };

      if (this.editingIndex === null) {
        this.employees.push(payload);
      } else {
        this.employees[this.editingIndex] = payload;
      }
      this.persist();
      this.resetForm();
    },

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö
    edit(i) {
      const e = this.employees[i];
      this.editingIndex = i;
      this.form = {
        employeeId: e.employeeId,
        firstName: e.firstName,
        lastName: e.lastName,
        nationalId: e.nationalId,
        dob: e.dob,
        gender: e.gender,
        phone: e.phone,
        email: e.email,
        department: e.department,
        position: e.position,
        startDate: e.startDate,
        lastDate: e.lastDate,
        salaryType: e.salaryType,
        salaryValue: e.salaryType === 'Percentage' ? (Number(e.salaryRaw) * 100) : Number(e.salaryRaw)
      };
      this.onSalaryTypeChange(this.form.salaryType);
      // sync display
      if (this.form.salaryType === 'Percentage') {
        this.salaryDisplay = this.form.salaryValue != null ? String(this.form.salaryValue) : '';
      } else {
        this.salaryDisplay = this.form.salaryValue != null ? Number(this.form.salaryValue).toLocaleString('en-US') : '';
      }
    },

    del(i) {
      if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
        this.employees.splice(i, 1);
        this.persist();
        if (this.editingIndex === i) this.resetForm();
      }
    },

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
    filteredEmployees() {
      const q = this.search.trim().toLowerCase();
      return this.employees.filter(e => {
        const matchQ =
          !q ||
          e.employeeId.toLowerCase().includes(q) ||
          e.firstName.toLowerCase().includes(q) ||
          e.lastName.toLowerCase().includes(q) ||
          (e.department || '').toLowerCase().includes(q);
        const matchPos = !this.filterPosition || e.position === this.filterPosition;
        return matchQ && matchPos;
      });
    },

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° + gen ‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà
    resetForm() {
      this.editingIndex = null;
      const keepDept = this.form.department; // ‡∏à‡∏≥‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å‡πÄ‡∏î‡∏¥‡∏°
      this.form = {
        employeeId: '',
        firstName: '',
        lastName: '',
        nationalId: '',
        dob: '',
        gender: 'Male',
        phone: '',
        email: '',
        department: keepDept || '',
        position: 'Doctor',
        startDate: '',
        lastDate: '',
        salaryType: 'Part-Time',
        salaryValue: null
      };
      this.salaryDisplay = '';
      this.onSalaryTypeChange(this.form.salaryType);
      this.assignEmployeeId();
    }
  }
}
</script>
<script>
function timeClockApp() {
  const STORAGE_KEY = 'hrTimeClock';      // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ clock in/out
  const EMP_KEYS = ['hrEmployees', 'employeeMaster', 'employees']; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô

  // ---------- utils ----------
  const pad2 = n => String(n).padStart(2,'0');
  const toYMDLocal = (d) => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fmtLocalDT = (iso) => {
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d)) return '';
    return d.toLocaleString('th-TH', { hour12:false, dateStyle:'short', timeStyle:'medium' });
  };
  const hoursDiff = (inISO, outISO) => {
    if (!inISO || !outISO) return 0;
    const a = new Date(inISO), b = new Date(outISO);
    if (isNaN(a) || isNaN(b)) return 0;
    const ms = b - a;
    return ms <= 0 ? 0 : +(ms/3600000).toFixed(2); // ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ‡∏ó‡∏®‡∏ô‡∏¥‡∏¢‡∏° 2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
  };

  // ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢ key)
  const loadEmployees = () => {
    for (const k of EMP_KEYS) {
      const raw = localStorage.getItem(k);
      if (raw) {
        try {
          const list = JSON.parse(raw) || [];
          // normalize field name ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô { employeeId, firstName, lastName }
          return list.map(e => ({
            employeeId: e.employeeId || e.empId || e.id || '',
            firstName : e.firstName  || e.fname  || e.name || '',
            lastName  : e.lastName   || e.lname  || e.surname || ''
          })).filter(e => e.employeeId);
        } catch {}
      }
    }
    return [];
  };

  return {
    // ---------- state ----------
    liveNow: '',
    employees: [],
    records: [],
    form: {
      empId: '',
      date: toYMDLocal(new Date()), // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      geo: '',
      note: ''
    },
    filter: {
      emp: '',
      from: '',
      to: ''
    },
    statusToday: { in:'‚Äî', out:'‚Äî', totalHrs:'0.00' },
    canClockIn: false,
    canClockOut: false,

    // ---------- lifecycle ----------
    init() {
      // ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      this.liveNow = fmtLocalDT(new Date().toISOString());
      setInterval(() => { this.liveNow = fmtLocalDT(new Date().toISOString()); }, 1000);

      // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      const saved = localStorage.getItem(STORAGE_KEY);
      this.records = saved ? JSON.parse(saved) : [];

      // ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
      this.employees = loadEmployees();

      // ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ù‡∏±‡πà‡∏á local)
      this.form.date = toYMDLocal(new Date());

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°
      this.refreshStatus();
    },

    // ---------- helpers ----------
    saveRecords() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(this.records));
    },
    empName(id) {
      const e = this.employees.find(x => x.employeeId === id);
      return e ? `${e.firstName} ${e.lastName}` : '';
    },
    latestOpenToday(empId) {
      // ‡∏´‡∏≤‡πÄ‡∏£‡∏Ñ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á emp ‡πÉ‡∏ô "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ (‡∏ï‡∏≤‡∏° local)" ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ outAt
      const today = toYMDLocal(new Date());
      const list = this.records
        .filter(r => r.empId === empId && r.date === today && r.inAt && !r.outAt)
        .sort((a,b)=> (a.inAt>b.inAt?1:-1));
      return list.length ? list[list.length-1] : null;
    },
    todayRecord(empId, ymd) {
      // ‡∏´‡∏≤‡πÄ‡∏£‡∏Ñ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á emp ‡πÉ‡∏ô ymd (‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏∏‡∏õ/‡πÇ‡∏ä‡∏ß‡πå‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å)
      const list = this.records
        .filter(r => r.empId === empId && r.date === ymd)
        .sort((a,b)=> (a.inAt>b.inAt?1:-1));
      return list.length ? list[list.length-1] : null;
    },

    refreshStatus() {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏Ñ‡∏Ñ‡∏≠‡∏£‡πå‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      const open = this.form.empId ? this.latestOpenToday(this.form.empId) : null;
      this.canClockIn  = !!this.form.empId && !open;
      this.canClockOut = !!this.form.empId && !!open;

      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï statusToday (‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°)
      const rec = (this.form.empId && this.form.date)
        ? this.todayRecord(this.form.empId, this.form.date)
        : null;

      const inStr  = rec?.inAt  ? fmtLocalDT(rec.inAt)  : '‚Äî';
      const outStr = rec?.outAt ? fmtLocalDT(rec.outAt) : '‚Äî';
      const hrs    = rec ? hoursDiff(rec.inAt, rec.outAt) : 0;

      this.statusToday = {
        in: inStr,
        out: outStr,
        totalHrs: hrs.toFixed(2)
      };
    },

    // ---------- actions ----------
    clockIn() {
      if (!this.form.empId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
      // ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (‡∏ï‡πâ‡∏≠‡∏á out ‡∏Å‡πà‡∏≠‡∏ô)
      if (!this.canClockIn) { alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Clock Out ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }

      const now = new Date();
      const rec = {
        id: `${Date.now()}_${Math.random().toString(36).slice(2,8)}`,
        date: toYMDLocal(now),                 // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (local)
        empId: this.form.empId,
        empName: this.empName(this.form.empId),
        inAt: now.toISOString(),               // ‡πÄ‡∏Å‡πá‡∏ö datetime ‡πÅ‡∏ö‡∏ö ISO
        outAt: null,
        note: this.form.note || '',
        geo: this.form.geo || ''
      };
      this.records.push(rec);
      this.saveRecords();
      this.refreshStatus();
    },

    clockOut() {
      if (!this.form.empId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
      const open = this.latestOpenToday(this.form.empId);
      if (!open) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Clock In ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'); return; }

      open.outAt = new Date().toISOString();   // ‡πÄ‡∏Å‡πá‡∏ö datetime ‡πÅ‡∏ö‡∏ö ISO
      this.saveRecords();
      this.refreshStatus();
    },

    resetForm() {
      this.form.note = '';
      this.form.geo  = '';
      // ‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï empId/date ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    },

    // ---------- geolocation ----------
    grabGeo() {
      if (!navigator.geolocation) { alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation'); return; }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          this.form.geo = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
        },
        err => { alert('‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message); }
      );
    },

    // ---------- list / table ----------
    filtered() {
      const emp = this.filter.emp;
      const from = this.filter.from ? new Date(this.filter.from) : null;
      const to   = this.filter.to   ? new Date(this.filter.to)   : null;

      return this.records.filter(r => {
        const matchEmp  = !emp || r.empId === emp;
        const d = new Date(r.date + 'T00:00:00'); // ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢ local date
        const matchFrom = !from || d >= from;
        const matchTo   = !to   || d <= to;
        return matchEmp && matchFrom && matchTo;
      }).sort((a,b) => (a.date === b.date ? (a.inAt > b.inAt ? 1 : -1) : (a.date > b.date ? 1 : -1)));
    },

    remove(i) {
      const list = this.filtered();
      const target = list[i];
      if (!target) return;
      if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
      this.records = this.records.filter(r => r.id !== target.id);
      this.saveRecords();
      this.refreshStatus();
    },

    // ---------- display helpers ----------
    displayTime(iso) {
      return fmtLocalDT(iso);
    },
    displayHoursByAt(inAt, outAt) {
      const h = hoursDiff(inAt, outAt);
      return h ? h.toFixed(2) : '0.00';
    },
    sumHoursFiltered() {
      const sum = this.filtered().reduce((acc, r) => acc + hoursDiff(r.inAt, r.outAt), 0);
      return sum.toFixed(2);
    },

    // ---------- export ----------
    exportCSV() {
      const rows = [
        ['Date','EmployeeID','EmployeeName','ClockIn(ISO)','ClockOut(ISO)','ClockIn(Local)','ClockOut(Local)','Hours','Note','Geo']
      ];
      this.filtered().forEach(r => {
        rows.push([
          r.date,
          r.empId,
          r.empName,
          r.inAt || '',
          r.outAt || '',
          fmtLocalDT(r.inAt),
          fmtLocalDT(r.outAt),
          hoursDiff(r.inAt, r.outAt).toFixed(2),
          r.note || '',
          r.geo || ''
        ]);
      });
      const csv = rows.map(row => row.map(v => `"${String(v).replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `timeclock_${toYMDLocal(new Date())}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
  };
}
</script>
<script>
function attendanceApp() {
  return {
    // ======= state =======
    employees: [],        // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å hrEmployees
    records: [],          // ‡πÇ‡∏´‡∏•‡∏î/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡πà localStorage
    editingIndex: null,
    showEmpList: false,
    empQuery: '',

    form: {
      empId: '',
      fullName: '',
      position: '',
      date: '',
      checkIn: '',
      checkOut: '',
      leaveType: '',
      status: 'Pending',
      note: ''
    },

    filter: {
      search: '',
      empId: '',
      position: '',
      leaveType: '',
      status: '',
      from: '',
      to: ''
    },

    // ======= lifecycle =======
    init() {
      // ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Employee Master
      this.employees = JSON.parse(localStorage.getItem('hrEmployees') || '[]');
      // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Attendance
      this.records = JSON.parse(localStorage.getItem('hrAttendance') || '[]');

      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
      this.form.date = new Date().toISOString().slice(0,10);
    },

    // ======= helpers =======
    empSuggestionList() {
      const q = (this.empQuery || '').toLowerCase().trim();
      const list = this.employees.map(e => ({
        employeeId: e.employeeId,
        firstName: e.firstName,
        lastName: e.lastName,
        position: e.position || ''
      }));
      if (!q) return list.slice(0, 20);
      return list.filter(e =>
        e.employeeId.toLowerCase().includes(q) ||
        (e.firstName || '').toLowerCase().includes(q) ||
        (e.lastName || '').toLowerCase().includes(q)
      ).slice(0, 20);
    },

    selectEmp(e) {
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position || '';
      this.empQuery = `${e.employeeId} ‚Äî ${e.firstName} ${e.lastName}`;
      this.showEmpList = false;
    },
    clearEmp() {
      this.form.empId = '';
      this.form.fullName = '';
      this.form.position = '';
      this.empQuery = '';
      this.showEmpList = true;
    },

    persist() {
      localStorage.setItem('hrAttendance', JSON.stringify(this.records));
    },

    // ======= CRUD =======
    save() {
      // validate
      if (!this.form.empId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
      if (!this.form.date) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload
      const payload = {
        id: this.editingIndex===null ? `AT-${Date.now()}` : this.records[this.editingIndex].id,
        empId: this.form.empId,
        fullName: this.form.fullName,
        position: this.form.position,
        date: this.form.date,
        checkIn: this.form.checkIn,
        checkOut: this.form.checkOut,
        leaveType: this.form.leaveType,
        status: this.form.status,
        note: this.form.note
      };

      if (this.editingIndex===null) {
        this.records.push(payload);
      } else {
        this.records[this.editingIndex] = payload;
      }
      this.persist();
      this.resetForm(true);
    },

    edit(i) {
      const r = this.records[i];
      this.editingIndex = i;
      this.form = {
        empId: r.empId,
        fullName: r.fullName,
        position: r.position,
        date: r.date,
        checkIn: r.checkIn,
        checkOut: r.checkOut,
        leaveType: r.leaveType,
        status: r.status,
        note: r.note || ''
      };
      this.empQuery = `${r.empId} ‚Äî ${r.fullName}`;
      this.showEmpList = false;
      // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô
      window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    remove(i) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
      this.records.splice(i,1);
      this.persist();
      if (this.editingIndex===i) this.resetForm();
    },

    resetForm(keepDate=false) {
      const dateKeep = keepDate ? this.form.date : new Date().toISOString().slice(0,10);
      this.editingIndex = null;
      this.form = {
        empId: '',
        fullName: '',
        position: '',
        date: dateKeep,
        checkIn: '',
        checkOut: '',
        leaveType: '',
        status: 'Pending',
        note: ''
      };
      this.empQuery = '';
      this.showEmpList = false;
    },

    // ======= FILTER =======
    filteredRecords() {
      const s = (this.filter.search || '').toLowerCase().trim();
      const from = this.filter.from ? new Date(this.filter.from) : null;
      const to   = this.filter.to   ? new Date(this.filter.to)   : null;

      return this.records.filter(r => {
        const matchText = !s || [
          r.empId,
          r.fullName,
          r.note || ''
        ].join(' ').toLowerCase().includes(s);

        const matchEmp = !this.filter.empId || r.empId === this.filter.empId;
        const matchPos = !this.filter.position || r.position === this.filter.position;
        const matchLeave = !this.filter.leaveType || r.leaveType === this.filter.leaveType;
        const matchStatus = !this.filter.status || r.status === this.filter.status;

        const d = new Date(r.date);
        const matchDate = (!from || d >= from) && (!to || d <= to);

        return matchText && matchEmp && matchPos && matchLeave && matchStatus && matchDate;
      });
    }
  }
}
</script>
<script>
    function saleOrderApp(){
      return {
        quotations: [],
        saleOrders: [],
        editingIndex: null,

        showPending: false,
        headerLocked: false,

        flt: { keyword:'', from:'', to:'', minNet:null },

        form: {
          soNo:'', soDate:'',
          refQuotationNo:'',
          customer:{ code:'', firstName:'', lastName:'', nationalId:'', age:'', phone:'', email:'' },
          symptoms:'',
          items:[],
          before:0, discount:0, net:0,
          payment:{
            method:'FULL', rounds:2,
            installments:[], // [{amount, paid, paidAt, receiptNo}]
            full:{ paid:false, paidAt:'', receiptNo:'' }
          },
          doctorNote:''
        },

        init(){
          this.quotations = JSON.parse(localStorage.getItem('quotationsV2') || '[]');
          this.saleOrders = JSON.parse(localStorage.getItem('saleOrdersV2') || '[]');

          this.form.soDate = new Date().toISOString().slice(0,10);
          this.previewSoNo();
          if(this.form.items.length===0) this.addRow();
        },

        // ---------- Pending ----------
        openPending(){ this.showPending = true; },
        pendingQuotations(){
          const used = new Set(this.saleOrders.map(s => s.refQuotationNo).filter(Boolean));
          return this.quotations.filter(q => q.status==='Confirmed' && !used.has(q.qNo));
        },
        createFromQuotation(qNo){
          const q = this.quotations.find(x => x.qNo===qNo);
          if(!q){ alert('‡πÑ‡∏°‡πà‡∏û‡∏ö Quotation'); return; }
          this.resetForm();
          this.form.refQuotationNo = q.qNo;
          this.form.customer = JSON.parse(JSON.stringify(q.customer||{}));
          this.form.symptoms = q.symptoms || '';
          this.form.items = JSON.parse(JSON.stringify(q.items||[]));
          this.headerLocked = true;
          this.showPending = false;
        },

        // ---------- CRUD ----------
        canSave(){
          const hasItem = this.form.items.length>0 && this.form.items.some(r => (+r.qty||0)>0);
          const payOk = this.form.payment.method==='FULL'
                        ? true
                        : this.sumInstallments() === this.netTotal() && this.form.payment.installments.length>=2;
          return (this.form.customer.firstName||'').trim() && hasItem && payOk;
        },
        save(){
          const summary = this.makeSummary();
          if(this.editingIndex===null){
            this.previewSoNo();
            summary.soNo = this.form.soNo;
            this.saleOrders.push(summary);
          }else{
            summary.soNo = this.saleOrders[this.editingIndex].soNo;
            this.saleOrders[this.editingIndex] = summary;
          }
          localStorage.setItem('saleOrdersV2', JSON.stringify(this.saleOrders));
          alert(this.editingIndex===null ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å SO ‡πÅ‡∏•‡πâ‡∏ß' : '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï SO ‡πÅ‡∏•‡πâ‡∏ß');
          this.resetForm();
        },
        editByNo(no){
          const idx = this.saleOrders.findIndex(s => s.soNo===no);
          if(idx===-1) return;
          const s = this.saleOrders[idx];
          this.editingIndex = idx;
          this.form = JSON.parse(JSON.stringify(s));
          this.headerLocked = !!s.refQuotationNo;
          window.scrollTo({top:0, behavior:'smooth'});
        },
        deleteByNo(no){
          const idx = this.saleOrders.findIndex(s => s.soNo===no);
          if(idx===-1) return;
          if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö Sale Order ‡∏ô‡∏µ‡πâ?')) return;
          this.saleOrders.splice(idx,1);
          localStorage.setItem('saleOrdersV2', JSON.stringify(this.saleOrders));
          if(this.editingIndex===idx) this.resetForm();
        },
        resetForm(){
          this.editingIndex=null;
          this.headerLocked=false;
          this.form = {
            soNo:'', soDate:new Date().toISOString().slice(0,10),
            refQuotationNo:'',
            customer:{ code:'', firstName:'', lastName:'', nationalId:'', age:'', phone:'', email:'' },
            symptoms:'',
            items:[],
            before:0, discount:0, net:0,
            payment:{ method:'FULL', rounds:2, installments:[], full:{ paid:false, paidAt:'', receiptNo:'' } },
            doctorNote:''
          };
          this.previewSoNo();
          if(this.form.items.length===0) this.addRow();
        },

        // ---------- Numbers / Totals ----------
        addRow(){ this.form.items.push({service:'', tooth:'', qty:1, price:0, discount:0}); },
        removeRow(i){ this.form.items.splice(i,1); },
        rowTotal(r){ const q=+r.qty||0, p=+r.price||0, d=+r.discount||0; return Math.max(0, q*p - d); },
        sumBefore(){ return this.form.items.reduce((s,r)=> s + (+r.qty||0)*(+r.price||0), 0); },
        sumDiscount(){ return this.form.items.reduce((s,r)=> s + (+r.discount||0), 0); },
        netTotal(){ return Math.max(0, this.sumBefore() - this.sumDiscount()); },

        makeSummary(){
          return {
            soNo: this.form.soNo,
            soDate: this.form.soDate,
            refQuotationNo: this.form.refQuotationNo || '',
            customer: JSON.parse(JSON.stringify(this.form.customer)),
            symptoms: this.form.symptoms,
            items: JSON.parse(JSON.stringify(this.form.items)),
            before: this.sumBefore(),
            discount: this.sumDiscount(),
            net: this.netTotal(),
            payment: JSON.parse(JSON.stringify(this.form.payment)),
            doctorNote: this.form.doctorNote
          };
        },

        // ---------- Ensure save (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞/‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à) ----------
        ensureSaved(){
          const summary = this.makeSummary();
          if(this.editingIndex===null){
            if(!this.form.soNo){ this.previewSoNo(); summary.soNo = this.form.soNo; }
            this.saleOrders.push(summary);
            this.editingIndex = this.saleOrders.length - 1;
          }else{
            summary.soNo = this.saleOrders[this.editingIndex].soNo;
            this.saleOrders[this.editingIndex] = summary;
          }
          localStorage.setItem('saleOrdersV2', JSON.stringify(this.saleOrders));
        },

        // ---------- SO running ----------
        previewSoNo(){
          const dt = this.form.soDate || new Date().toISOString().slice(0,10);
          const ym = dt.replaceAll('-','').slice(0,6);
          const re = new RegExp(`^SO-${ym}-(\\d{4})$`);
          let max = 0;
          this.saleOrders.forEach(s => { const m=(s.soNo||'').match(re); if(m){ const n=+m[1]; if(n>max) max=n; }});
          this.form.soNo = `SO-${ym}-${String(max+1).padStart(4,'0')}`;
        },

        // ---------- Installments ----------
        buildInstallments(){
          const n = Math.max(2, Math.min(12, this.form.payment.rounds||2));
          const current = this.form.payment.installments || [];
          const arr = [];
          for(let i=0;i<n;i++){
            arr.push(current[i] || { amount:0, paid:false, paidAt:'', receiptNo:'' });
          }
          this.form.payment.installments = arr;
          this.splitEven();
        },
        splitEven(){
          const n = (this.form.payment.installments||[]).length || 2;
          const net = this.netTotal();
          const each = Math.floor((net/n)*100)/100;
          const arr = [];
          let sum = 0;
          for(let i=0;i<n-1;i++){ arr.push({ amount: each, paid:false, paidAt:'', receiptNo:'' }); sum += each; }
          arr.push({ amount: Math.max(0, +(net - sum).toFixed(2)), paid:false, paidAt:'', receiptNo:'' });
          this.form.payment.installments = arr;
        },
        sumInstallments(){ return +(this.form.payment.installments||[]).reduce((s,x)=> s + (+x.amount||0), 0).toFixed(2); },
        validateInstallments(){ return this.sumInstallments() === this.netTotal(); },

        // ---------- ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞ (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤) ----------
        receivePayment(type, idx){
          const now = new Date().toISOString();
          if(type==='FULL'){
            this.form.payment.full.paid = true;
            this.form.payment.full.paidAt = now;
          }else{
            const ins = this.form.payment.installments[idx];
            if(!ins) return;
            ins.paid = true;
            ins.paidAt = now;
          }
          this.ensureSaved();
        },

        // ---------- Receipts (print to PDF) ----------
        nextRcNo(){
          const ym = new Date().toISOString().slice(0,7).replaceAll('-','');
          const re = new RegExp(`^RC-${ym}-(\\d{4})$`);
          let max = 0;
          this.saleOrders.forEach(s => {
            if(s.payment?.full?.receiptNo){
              const m = s.payment.full.receiptNo.match(re); if(m) max=Math.max(max,+m[1]);
            }
            (s.payment?.installments||[]).forEach(x=>{
              if(x.receiptNo){ const m = x.receiptNo.match(re); if(m) max=Math.max(max,+m[1]); }
            });
          });
          return `RC-${ym}-${String(max+1).padStart(4,'0')}`;
        },
        printReceipt(type, idx){
          if(type==='FULL'){
            if(!this.form.payment.full.paid){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô" ‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à'); return; }
            const rc = this.form.payment.full.receiptNo || this.nextRcNo();
            this.form.payment.full.receiptNo = rc;
            this.ensureSaved();
            this.openReceiptWindow({ receiptNo: rc, title: '‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô)', amount: this.netTotal() });
          }else{
            const ins = this.form.payment.installments[idx];
            if(!ins){ return; }
            if(!ins.paid){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞" ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô'); return; }
            ins.receiptNo = ins.receiptNo || this.nextRcNo();
            this.ensureSaved();
            this.openReceiptWindow({ receiptNo: ins.receiptNo, title: `‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà ${idx+1})`, amount: +ins.amount||0 });
          }
        },
        openReceiptWindow({receiptNo, title, amount}){
          const w = window.open('', '_blank', 'width=800,height=900');
          const html = `
            <html>
              <head>
                <meta charset="utf-8" />
                <title>${receiptNo}</title>
                <style>
                  body{ font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto; padding:24px; }
                  h1{ font-size:20px; margin:0 0 8px; }
                  table{ width:100%; border-collapse: collapse; }
                  th,td{ border:1px solid #ddd; padding:8px; font-size:12px; }
                  .right{ text-align:right; }
                  .muted{ color:#666; font-size:12px; }
                </style>
              </head>
              <body>
                <h1>${title}</h1>
                <div class="muted">Receipt No.: ${receiptNo}</div>
                <div class="muted">Date: ${new Date().toLocaleString()}</div>
                <hr style="margin:12px 0;">
                <div><b>Customer:</b> ${(this.form.customer.firstName||'') + ' ' + (this.form.customer.lastName||'')}</div>
                <div class="muted">National ID: ${this.form.customer.nationalId||'-'}</div>
                <div class="muted">SO No.: ${this.form.soNo}</div>
                <div class="muted">Ref Quotation: ${this.form.refQuotationNo||'-'}</div>
                <br/>
                <table>
                  <thead><tr><th style="width:60%">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</th><th class="right">‡∏£‡∏ß‡∏°</th></tr></thead>
                  <tbody>
                    ${this.form.items.map(r=>`
                      <tr>
                        <td>${r.service||''} (${r.tooth||''})</td>
                        <td class="right">${r.qty||0}</td>
                        <td class="right">${this.fmt(r.price||0)}</td>
                        <td class="right">${this.fmt(r.discount||0)}</td>
                        <td class="right">${this.fmt(this.rowTotal(r))}</td>
                      </tr>`).join('')}
                  </tbody>
                </table>
                <div style="margin-top:10px; text-align:right">
                  <div>‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏î: ${this.fmt(this.sumBefore())}</div>
                  <div>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏£‡∏ß‡∏°: ${this.fmt(this.sumDiscount())}</div>
                  <div style="font-size:18px"><b>‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ:</b> ${this.fmt(amount)}</div>
                </div>
              
<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}
<!-- ==== SAFE STUBS: prevent ReferenceErrors on Cloudflare Pages (no backend yet) ==== -->
<script>
// Simple local util
const _storage = {
  get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch(e){ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
};

// ===== HR ¬ª Employee Master =====
function employeeApp(){
  return {
    // state
    employees: _storage.get("employees", []),
    editingIndex: null,
    search: "",
    filterPosition: "",
    form: {
      employeeId: "",
      firstName:"", lastName:"",
      nationalId:"", gender:"Male",
      phone:"", email:"",
      department:"", position:"Doctor",
      startDate:"", lastDate:"", dob:"",
      salaryType:"Part-Time", salaryValue: 0
    },
    salaryDisplay: "",
    salarySuffix: "THB/Hr",
    get salaryPlaceholder(){ return this.form.salaryType === "Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

    init(){
      // auto id: YY + running 3 digits
      if(!this.form.employeeId){
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      }
      // suffix
      this._updateSuffix();
    },
    _updateSuffix(){
      this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
        : (this.form.salaryType==="Full Time") ? "THB/Month"
        : "%";
    },
    onRateInput(ev){
      let v = ev.target.value.replace(/,/g,"").trim();
      if(this.form.salaryType==="Percentage"){
        // keep 0‚Äì100
        const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
        this.form.salaryValue = isNaN(num)?0:num/100;
        this.salaryDisplay = String(Math.round(num*100)/100);
      }else{
        const num = parseFloat(v||"0");
        this.form.salaryValue = isNaN(num)?0:num;
        // format with comma
        this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
      }
    },
    onRateBlur(){ /* keep display as-is */ },
    isNationalIdValid(id){
      if(!id || id.length!==13) return false;
      // simple checksum (Thai ID)
      let sum=0;
      for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
      let chk = (11 - (sum%11))%10;
      return chk === parseInt(id[12],10);
    },
    resetForm(){
      this.editingIndex = null;
      this.form = {
        employeeId:"", firstName:"", lastName:"", nationalId:"",
        gender:"Male", phone:"", email:"", department:"",
        position:"Doctor", startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      };
      this.salaryDisplay = "";
      this._updateSuffix();
      this.init();
    },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){
        this.employees.push(rec);
      }else{
        this.employees.splice(this.editingIndex,1,rec);
      }
      _storage.set("employees", this.employees);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.employees[i]));
      // set display from value
      if(this.form.salaryType==="Percentage"){
        this.salaryDisplay = String((this.form.salaryValue||0)*100);
      }else{
        this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
      }
      this._updateSuffix();
    },
    del(i){
      if(confirm("Delete?")){ this.employees.splice(i,1); _storage.set("employees", this.employees); }
    },
    filteredEmployees(){
      const kw = this.search.toLowerCase();
      return this.employees.filter(e=>{
        const okPos = !this.filterPosition || e.position===this.filterPosition;
        if(!kw) return okPos;
        const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
        return okPos && hay.includes(kw);
      });
    },
    displaySalary(emp){
      if(!emp) return "-";
      if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
      return (emp.salaryValue||0).toLocaleString("en-US");
    },
    statusFromLastDate(lastDate){
      if(!lastDate) return "Active";
      try{
        const d = new Date(lastDate);
        const today = new Date();
        return (d < today) ? "Resigned" : "Active";
      }catch(e){ return "Active"; }
    }
  };
}

// ===== HR ¬ª Attendance =====
function attendanceApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("attendance", []),
    editingIndex: null,
    showEmpList:false,
    empQuery:"",
    filter:{ search:"", empId:"", position:"", leaveType:"", status:"", from:"", to:"" },
    form:{ empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" },

    init(){},
    empSuggestionList(){
      const kw = (this.empQuery||"").toLowerCase();
      if(!kw) return this.employees.slice(0,10);
      return this.employees.filter(e => (`${e.employeeId} ${e.firstName} ${e.lastName} ${e.position||""}`).toLowerCase().includes(kw)).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName} ${e.lastName}`;
      this.form.position = e.position||"";
      this.showEmpList = false;
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
    },
    clearEmp(){ this.form.empId=""; this.form.fullName=""; this.form.position=""; this.empQuery=""; },
    resetForm(){ this.editingIndex=null; this.form = { empId:"", fullName:"", position:"", date:"", checkIn:"", checkOut:"", leaveType:"", status:"Pending", note:"" }; },
    save(){
      const rec = JSON.parse(JSON.stringify(this.form));
      if(this.editingIndex===null){ this.records.push(rec); } else { this.records.splice(this.editingIndex,1,rec); }
      _storage.set("attendance", this.records);
      this.resetForm();
      alert("Saved (stub).");
    },
    edit(i){ this.editingIndex=i; this.form = JSON.parse(JSON.stringify(this.records[i])); this.empQuery = `${this.form.empId} ‚Äî ${this.form.fullName}`; },
    remove(i){ if(confirm("Delete?")){ this.records.splice(i,1); _storage.set("attendance", this.records); } },
    filteredRecords(){
      const f = this.filter;
      const inRange = (d) => {
        if(!d) return true;
        const x = new Date(d);
        if(f.from && new Date(f.from) > x) return false;
        if(f.to && new Date(f.to)   < x) return false;
        return true;
      };
      return this.records.filter(r => {
        if(f.empId && r.empId!==f.empId) return false;
        if(f.position && (r.position||"")!==f.position) return false;
        if(f.leaveType && (r.leaveType||"")!==f.leaveType) return false;
        if(f.status && (r.status||"")!==f.status) return false;
        if(f.search){
          const hay = `${r.empId} ${r.fullName} ${r.note}`.toLowerCase();
          if(!hay.includes(f.search.toLowerCase())) return false;
        }
        return inRange(r.date);
      });
    },
    exportCSV(){
      const rows = [["Emp ID","Full Name","Position","Date","Check-in","Check-out","Status","Leave Type","Note"]]
        .concat(this.filteredRecords().map(r=>[r.empId,r.fullName,r.position||"",r.date,r.checkIn||"",r.checkOut||"",r.status||"",r.leaveType||"",r.note||""]));
      const csv = rows.map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "attendance.csv"; a.click();
      URL.revokeObjectURL(url);
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt, outAt){
      if(!inAt || !outAt) return "0";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0"; }
    },
    sumHoursFiltered(){
      return this.filteredRecords().reduce((acc,r)=>acc+parseFloat(this.displayHoursByAt(r.checkIn,r.checkOut)||0),0).toFixed(2);
    }
  };
}

// ===== HR ¬ª Timeclock =====
function timeClockApp(){
  return {
    employees: _storage.get("employees", []),
    records: _storage.get("timeclock", []),
    liveNow: "",
    form:{ empId:"", date:"", geo:"", note:"" },
    statusToday:{ in:"", out:"", totalHrs:"0.00" },
    filter:{ emp:"", from:"", to:"" },

    init(){
      this._tick();
      setInterval(()=>this._tick(), 1000);
    },
    _tick(){ const d=new Date(); this.liveNow = d.toLocaleString(); },
    refreshStatus(){
      // Simple lookup for chosen date
      const day = this.form.date;
      const recs = this.records.filter(r=> r.empId===this.form.empId && r.date===day);
      const recIn  = recs.find(r=> !!r.inAt);
      const recOut = recs.find(r=> !!r.outAt);
      this.statusToday.in  = recIn ? recIn.inAt : "";
      this.statusToday.out = recOut? recOut.outAt: "";
      const h = this.displayHoursByAt(this.statusToday.in, this.statusToday.out);
      this.statusToday.totalHrs = h;
    },
    grabGeo(){
      if(!navigator.geolocation){ this.form.geo = ""; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const {latitude, longitude} = pos.coords;
        this.form.geo = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
      }, ()=>{ this.form.geo = ""; });
    },
    clockIn(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:`${hh}:${mm}`, outAt:"", note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    clockOut(){
      if(!this.form.empId || !this.form.date){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"); return; }
      const now = new Date(); const hh = String(now.getHours()).padStart(2,"0"); const mm = String(now.getMinutes()).padStart(2,"0");
      this.records.push({ empId:this.form.empId, empName:(this.employees.find(e=>e.employeeId===this.form.empId)?.firstName||"")+" "+(this.employees.find(e=>e.employeeId===this.form.empId)?.lastName||""), date:this.form.date, inAt:"", outAt:`${hh}:${mm}`, note:this.form.note||"", geo:this.form.geo||"" });
      _storage.set("timeclock", this.records);
      this.refreshStatus();
    },
    resetForm(){ this.form={ empId:"", date:"", geo:"", note:"" }; this.statusToday={ in:"", out:"", totalHrs:"0.00" }; },
    filtered(){
      const f=this.filter;
      const inRange = d=>{
        if(!d) return true; const x = new Date(d);
        if(f.from && new Date(f.from)>x) return false;
        if(f.to && new Date(f.to)<x) return false;
        return true;
      };
      return this.records.filter(r=>{
        if(f.emp && r.empId!==f.emp) return false;
        return inRange(r.date);
      });
    },
    displayTime(t){ return t||""; },
    displayHoursByAt(inAt,outAt){
      if(!inAt || !outAt) return "0.00";
      try{
        const a = new Date(`1970-01-01T${inAt}:00`);
        const b = new Date(`1970-01-01T${outAt}:00`);
        return ((b-a)/(1000*60*60)).toFixed(2);
      }catch(e){ return "0.00"; }
    }
  };
}
</script>

</body>
</html>


<!-- === API Overrides: switch from localStorage to Cloudflare Pages Functions + D1 === -->
<script>
(() => {
  window.USER = window.USER || 'admin'; // TODO: replace with real user later

  // debounce helper (append-once)
window.debounce = window.debounce || ((fn, ms = 350) => {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
});


    // --- Toast (append-once) ---
  if (!document.getElementById('toast-style')) {
    const s = document.createElement('style');
    s.id = 'toast-style';
    s.textContent = `
      .toast { position: fixed; right: 16px; top: 16px; z-index: 10000; }
      .toast-item{ margin-top:8px; padding:10px 14px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15); background:#fff;
        border-left:4px solid #16a34a; font-size:14px }
      .toast-item.error{ border-left-color:#dc2626 }
      .toast-item.info { border-left-color:#2563eb }
    `;
    document.head.appendChild(s);
    const c = document.createElement('div');
    c.id = 'toast'; c.className = 'toast';
    document.body.appendChild(c);
  }
  window.toast = function(msg, type='success', ms=2200){
    const c = document.getElementById('toast');
    const el = document.createElement('div');
    el.className = 'toast-item ' + (type || '');
    el.textContent = msg;
    c.appendChild(el);
    setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .25s'; }, ms-250);
    setTimeout(()=> el.remove(), ms);
  };


  // --- global busy indicator + CSS (append once) ---
  let __busy = 0;
  function __setBusy(delta){
    __busy = Math.max(0, __busy + delta);
    document.documentElement.classList.toggle('busy', __busy > 0);
  }
  if (!document.getElementById('busy-style')) {
    const s = document.createElement('style');
    s.id = 'busy-style';
    s.textContent = `
      html.busy { cursor: progress; }
      html.busy * { pointer-events: none !important; user-select: none; }
      #busy-indicator{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.4); z-index:9999; }
      html.busy #busy-indicator{ display:flex; }
      .busy-dot{ width:10px; height:10px; margin:4px; border-radius:50%; background:#111; animation: bd 1s infinite alternate; }
      .busy-dot:nth-child(2){ animation-delay:.2s } .busy-dot:nth-child(3){ animation-delay:.4s }
      @keyframes bd { from{ transform:translateY(0) } to{ transform:translateY(-8px) } }
    `;
    document.head.appendChild(s);
    const d = document.createElement('div');
    d.id = 'busy-indicator';
    d.innerHTML = '<div class="busy-dot"></div><div class="busy-dot"></div><div class="busy-dot"></div>';
    document.body.appendChild(d);
  }


  async function api(path, { method='GET', body, headers={} } = {}) {
    // ‡πÄ‡∏£‡∏¥‡πà‡∏° busy (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)
    if (typeof __setBusy === 'function') __setBusy(+1);
    try {
      let res;
      try {
        res = await fetch(path, {
          method,
          headers: Object.assign(
            { 'Content-Type':'application/json', 'x-user': window.USER },
            headers
          ),
          body: body ? JSON.stringify(body) : undefined
        });
      } catch (e) {
        // ‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
        window.toast?.(`‚ùå Network error: ${method} ${path}`, 'error', 3000);
        throw e;
      }
  
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        window.toast?.(`‚ùå ${method} ${path} ‚Äî ${res.status}`, 'error', 2800);
        throw new Error(`API ${method} ${path} failed: ${res.status} ${text}`);
      }
  
      // ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏´‡∏£‡∏∑‡∏≠ text ‡∏ï‡∏≤‡∏° content-type
      return res.headers.get('content-type')?.includes('application/json')
        ? res.json()
        : res.text();
  
    } finally {
      // ‡∏à‡∏ö busy
      if (typeof __setBusy === 'function') __setBusy(-1);
    }
  }


  // ===== HR ¬ª Employee (D1: employees) =====
  window.employeeApp = function employeeApp(){
    return {
      employees: [],
      editingIndex: null,
      search: "", filterPosition: "",
      form: {
        id: null,
        employeeId:"", firstName:"", lastName:"",
        nationalId:"", gender:"Male", phone:"", email:"",
        department:"", position:"Doctor",
        startDate:"", lastDate:"", dob:"",
        salaryType:"Part-Time", salaryValue:0
      },
      salaryDisplay:"", salarySuffix:"THB/Hr",
      get salaryPlaceholder(){ return this.form.salaryType==="Percentage" ? "0‚Äì100" : "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"; },

      async init(){
        await this.reload();
        if(!this.form.employeeId){
          const yy = new Date().getFullYear().toString().slice(-2);
          const run = String(this.employees.length + 1).padStart(3,"0");
          this.form.employeeId = `${yy}${run}`;
        }
        this._updateSuffix();
      },
      async reload(){ this.employees = await api('/api/hr/employees'); },
      _updateSuffix(){
        this.salarySuffix = (this.form.salaryType==="Part-Time") ? "THB/Hr"
          : (this.form.salaryType==="Full Time") ? "THB/Month"
          : "%";
      },
      onRateInput(ev){
        let v = (ev.target.value||"").replace(/,/g,"").trim();
        if(this.form.salaryType==="Percentage"){
          const num = Math.max(0, Math.min(100, parseFloat(v||"0")));
          this.form.salaryValue = isNaN(num)?0:num/100;
          this.salaryDisplay = String(Math.round(num*100)/100);
        }else{
          const num = parseFloat(v||"0");
          this.form.salaryValue = isNaN(num)?0:num;
          this.salaryDisplay = this.form.salaryValue.toLocaleString("en-US");
        }
      },
      onRateBlur(){},

      isNationalIdValid(id){
        if(!id || id.length!==13) return false;
        let sum=0; for(let i=0;i<12;i++) sum += parseInt(id[i],10)*(13-i);
        let chk = (11 - (sum%11))%10; return chk === parseInt(id[12],10);
      },
      resetForm(){
        this.editingIndex = null;
        this.form = {
          id:null, employeeId:"", firstName:"", lastName:"", nationalId:"",
          gender:"Male", phone:"", email:"", department:"",
          position:"Doctor", startDate:"", lastDate:"", dob:"",
          salaryType:"Part-Time", salaryValue:0
        };
        this.salaryDisplay=""; this._updateSuffix();
        const yy = new Date().getFullYear().toString().slice(-2);
        const run = String(this.employees.length + 1).padStart(3,"0");
        this.form.employeeId = `${yy}${run}`;
      },
      async save(){
        const payload = { ...this.form };
        if(this.editingIndex===null){
          await api('/api/hr/employees', { method:'POST', body: payload });
        }else{
          const row = this.employees[this.editingIndex];
          await api(`/api/hr/employees/${row.id}`, { method:'PUT', body: payload });
        }
        await this.reload();
        this.resetForm();
        alert('Saved.');
      },
      edit(i){
        this.editingIndex = i;
        this.form = JSON.parse(JSON.stringify(this.employees[i]));
        if(this.form.salaryType==="Percentage"){
          this.salaryDisplay = String((this.form.salaryValue||0)*100);
        }else{
          this.salaryDisplay = (this.form.salaryValue||0).toLocaleString("en-US");
        }
        this._updateSuffix();
      },
      async del(i){
        if(!confirm("Delete?")) return;
        const row = this.employees[i];
        await api(`/api/hr/employees/${row.id}`, { method:'DELETE' });
        await this.reload();
      },
      filteredEmployees(){
        const kw = (this.search||"").toLowerCase();
        return this.employees.filter(e=>{
          const okPos = !this.filterPosition || e.position===this.filterPosition;
          if(!kw) return okPos;
          const hay = [e.employeeId,e.firstName,e.lastName,e.department].join(" ").toLowerCase();
          return okPos && hay.includes(kw);
        });
      },
      displaySalary(emp){
        if(!emp) return "-";
        if(emp.salaryType==="Percentage") return `${Math.round((emp.salaryValue||0)*10000)/100}%`;
        return (emp.salaryValue||0).toLocaleString("en-US");
      },
      statusFromLastDate(lastDate){
        if(!lastDate) return "Active";
        try{ return (new Date(lastDate) < new Date()) ? "Resigned" : "Active"; }catch(e){ return "Active"; }
      }
    };
  };

  // ===== HR ¬ª Attendance =====
window.attendanceApp = function attendanceApp(){
  return {
    // --- state ---
    employees: [],
    records: [],
    total: 0,
    limit: 20,
    offset: 0,
    busy: { save:false, remove:false },
    reloadDebounced: null,

    // form (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
    form: {
      id: null,
      empId: '',
      fullName: '',
      position: '',
      date: '',
      checkIn: '',
      checkOut: '',
      status: 'Pending',
      leaveType: '',
      note: '',
      geo: ''
    },
    editingIndex: null,

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå
    empQuery: '',
    showEmpList: false,
    filters: { search:'', status:'', leaveType:'', from:'', to:'' },

    // --- lifecycle ---
    async init(){
      // ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      try { this.employees = await api('/api/hr/employees'); } catch(e){ this.employees = []; }
      if (!this.form.date) this.form.date = new Date().toISOString().slice(0,10);
      // debounce reload
      this.reloadDebounced = debounce(() => { this.offset = 0; this.reload(); }, 350);
      await this.reload();
    },

    // --- employee suggest ---
    empSuggestionList(){
      const q = (this.empQuery||'').toLowerCase();
      if (!q) return this.employees.slice(0,20);
      return this.employees.filter(e =>
        (e.employeeId||'').toLowerCase().includes(q) ||
        (e.firstName||'').toLowerCase().includes(q) ||
        (e.lastName||'').toLowerCase().includes(q)
      ).slice(0,20);
    },
    selectEmp(e){
      this.form.empId = e.employeeId;
      this.form.fullName = `${e.firstName||''} ${e.lastName||''}`.trim();
      this.form.position = e.position || '';
      this.empQuery = `${e.employeeId} ‚Äî ${this.form.fullName}`;
      this.showEmpList = false;
    },
    clearEmp(){
      this.form.empId = ''; this.form.fullName=''; this.form.position=''; this.empQuery='';
      this.showEmpList = false;
    },

    // --- data ops ---
    async reload(){
      const p = new URLSearchParams();
      if (this.filters.search)   p.set('search', this.filters.search);
      if (this.form.empId)       p.set('empId', this.form.empId);
      if (this.form.position)    p.set('position', this.form.position);
      if (this.filters.leaveType)p.set('leaveType', this.filters.leaveType);
      if (this.filters.status)   p.set('status', this.filters.status);
      if (this.filters.from)     p.set('from', this.filters.from);
      if (this.filters.to)       p.set('to', this.filters.to);
      p.set('limit', this.limit); p.set('offset', this.offset);

      const res = await api(`/api/hr/attendance?${p.toString()}`);
      const list = res.data || res; // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ API ‡∏Ñ‡∏∑‡∏ô array ‡∏ï‡∏£‡∏á‡πÜ
      this.records = list || [];
      this.total   = res.total ?? this.records.length;
    },

    // save: POST/PUT
    async save(){
      if (this.busy.save) return;
      if (!this.form.empId || !this.form.fullName || !this.form.date) {
        window.toast?.('‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error'); return;
      }
      this.busy.save = true;
      try {
        const payload = { ...this.form };
        if (payload.id) {
          await api(`/api/hr/attendance/${payload.id}`, { method:'PUT', body: payload });
          window.toast?.('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Attendance ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
        } else {
          const out = await api('/api/hr/attendance', { method:'POST', body: payload });
          this.form.id = out.id;
          window.toast?.('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Attendance ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
        }
        this.offset = 0;
        await this.reload();
      } finally { this.busy.save = false; }
    },

    edit(row){
      // ‡πÄ‡∏ï‡∏¥‡∏°‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      this.form = {
        id: row.id,
        empId: row.empId || '',
        fullName: row.fullName || '',
        position: row.position || '',
        date: row.date || '',
        checkIn: row.checkIn || '',
        checkOut: row.checkOut || '',
        status: row.status || 'Pending',
        leaveType: row.leaveType || '',
        note: row.note || '',
        geo: row.geo || ''
      };
      this.empQuery = this.form.empId ? `${this.form.empId} ‚Äî ${this.form.fullName}` : '';
      this.editingIndex = 0; // ‡πÉ‡∏ä‡πâ‡πÅ‡∏¢‡∏Å‡∏õ‡∏∏‡πà‡∏° Save/Update ‡πÉ‡∏ô UI
    },

    async remove(row){
      if (this.busy.remove) return;
      if (!row) return;
      if (!confirm('Delete?')) return;
      this.busy.remove = true;
      try {
        await api(`/api/hr/attendance/${row.id}`, { method:'DELETE' });
        window.toast?.('‡∏•‡∏ö Attendance ‡πÅ‡∏•‡πâ‡∏ß','success');
        // ‡∏ñ‡πâ‡∏≤‡∏•‡∏ö‡∏´‡∏°‡∏î‡∏´‡∏ô‡πâ‡∏≤ ‡∏õ‡∏£‡∏±‡∏ö offset ‡∏ñ‡∏≠‡∏¢‡∏Å‡∏•‡∏±‡∏ö
        if (this.records.length === 1 && this.offset > 0) this.offset = Math.max(0, this.offset - this.limit);
        await this.reload();
      } finally { this.busy.remove = false; }
    },

    exportCsv(){
      const p = new URLSearchParams();
      if (this.filters.search)   p.set('search', this.filters.search);
      if (this.form.empId)       p.set('empId', this.form.empId);
      if (this.filters.leaveType)p.set('leaveType', this.filters.leaveType);
      if (this.filters.status)   p.set('status', this.filters.status);
      if (this.filters.from)     p.set('from', this.filters.from);
      if (this.filters.to)       p.set('to', this.filters.to);
      // ‡πÉ‡∏ä‡πâ endpoint list ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥ /export ‡πÅ‡∏¢‡∏Å‡∏Å‡πá‡πÑ‡∏î‡πâ
      const url = `/api/hr/attendance?${p.toString()}`;
      window.open(url, '_blank');
    },

    resetForm(){
      this.form = {
        id:null, empId:'', fullName:'', position:'',
        date: new Date().toISOString().slice(0,10),
        checkIn:'', checkOut:'', status:'Pending',
        leaveType:'', note:'', geo:''
      };
      this.empQuery=''; this.editingIndex=null;
    }
  };
};



  // ===== HR ¬ª Timeclock =====
(() => {
  // ‡πÉ‡∏ä‡πâ window.USER ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
  async function api(path, { method='GET', body, headers={} } = {}) {
    let res;
    try {
      res = await fetch(path, {
        method,
        headers: Object.assign(
          { 'Content-Type':'application/json', 'x-user': window.USER },
          headers
        ),
        body: body ? JSON.stringify(body) : undefined
      });
    } catch (e) {
      window.toast?.(`‚ùå Network error: ${method} ${path}`, 'error', 3000);
      throw e;
    }

    if (!res.ok) {
      const text = await res.text().catch(()=> '');
      window.toast?.(`‚ùå ${method} ${path} ‚Äî ${res.status}`, 'error', 2800);
      throw new Error(`API ${method} ${path} failed: ${res.status} ${text}`);
    }

    return res.headers.get('content-type')?.includes('application/json')
      ? res.json()
      : res.text();
  }

  // --- utils (‡∏ù‡∏±‡πà‡∏á UI) ---
  const pad2 = n => String(n).padStart(2,'0');
  const toYMDLocal = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  const fmtLocalDT = iso => { if(!iso) return ''; const d = new Date(iso); return isNaN(d)? '' : d.toLocaleString('th-TH',{hour12:false,dateStyle:'short',timeStyle:'medium'}) };
  const hoursDiff = (inISO,outISO) => { if(!inISO||!outISO) return 0; const a=new Date(inISO), b=new Date(outISO); if(isNaN(a)||isNaN(b)) return 0; const ms=b-a; return ms<=0?0:+(ms/3600000).toFixed(2); };

  // --- TimeClock (D1 backed) ---
  window.timeClockApp = function timeClockApp(){
    return {
      reloadDebounced: null,
      liveNow: '',
      employees: [],
      records: [],
      // >>> ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö :disabled ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°
      canClockIn: false,
      canClockOut: false,

      form: {
        empId: '',
        date: toYMDLocal(new Date()),  // ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        geo: '',
        note: ''
      },
      filter: { emp:'', from:'', to:'' },
      statusToday: { in:'‚Äî', out:'‚Äî', totalHrs:'0.00' },

      async init(){
        try { this.employees = await api('/api/hr/employees'); } catch(e){ console.error(e); this.employees = []; }
        await this.reload();
        this.refreshStatus();
        this._tick(); setInterval(()=>this._tick(), 1000);
        this.reloadDebounced = debounce(() => this.reload(), 350);
      },
      _tick(){ this.liveNow = fmtLocalDT(new Date().toISOString()); },

      async reload(){
        // ‡∏î‡∏∂‡∏á‡∏ä‡πà‡∏ß‡∏á 60 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏≤‡∏Å‡∏Å‡∏£‡∏≠‡∏Å)
        const sel = this.form.date || toYMDLocal(new Date());
        const to  = this.filter.to   || sel;
        let   from= this.filter.from || (()=>{ const d=new Date(sel+'T00:00:00'); d.setDate(d.getDate()-60); return toYMDLocal(d); })();
        const qs = new URLSearchParams({ from, to });
        if (this.filter.emp) qs.set('emp', this.filter.emp);

        const res = await api(`/api/hr/timeclock?${qs.toString()}`);
        const rows = res.data || res; // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏ì‡∏µ API ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏õ‡πá‡∏ô array ‡∏ï‡∏£‡∏á‡πÜ
        // ‡∏ú‡∏π‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        this.records = (rows||[]).map(r => ({
          ...r,
          empName: (() => {
            const e = this.employees.find(x => x.employeeId === r.empId);
            return e ? `${e.firstName||''} ${e.lastName||''}`.trim() : r.empId;
          })()
        }));
      },

      latestOpenToday(empId){
        const ymd = this.form.date || toYMDLocal(new Date());
        return this.records
          .filter(r => r.empId===empId && r.date===ymd && !r.outAt)
          .sort((a,b)=> (a.inAt>b.inAt?1:-1))
          .pop() || null;
      },

      async refreshStatus(){
        const open = this.form.empId ? this.latestOpenToday(this.form.empId) : null;
        this.canClockIn  = !!this.form.empId && !open;
        this.canClockOut = !!this.form.empId && !!open;

        const ymd = this.form.date || toYMDLocal(new Date());
        const recs = this.records
          .filter(r => r.empId===this.form.empId && r.date===ymd)
          .sort((a,b)=> (a.inAt>b.inAt?1:-1));
        const rec = recs.length ? recs[recs.length-1] : null;

        this.statusToday = {
          in:  rec?.inAt  ? fmtLocalDT(rec.inAt)  : '‚Äî',
          out: rec?.outAt ? fmtLocalDT(rec.outAt) : '‚Äî',
          totalHrs: (rec ? hoursDiff(rec.inAt, rec.outAt) : 0).toFixed(2)
        };
      },

      async clockIn(){
        if (!this.form.empId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
        if (!this.canClockIn) { alert('‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Clock Out ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß'); return; }
        await api('/api/hr/timeclock', { method:'POST', body:{ empId:this.form.empId, note:this.form.note||'', geo:this.form.geo||'' } });
        await this.reload(); this.refreshStatus();
      },

      async clockOut(){
        if (!this.form.empId) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
        if (!this.canClockOut) { alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Clock In ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ'); return; }

        const ymd = this.form.date || toYMDLocal(new Date());
        const today = await api(`/api/hr/timeclock?emp=${encodeURIComponent(this.form.empId)}&from=${ymd}&to=${ymd}`);
        const open = (today.data || today).find(r => !r.outAt);
        if (!open) { alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á Clock Out'); return; }

        await api(`/api/hr/timeclock/${open.id}`, { method:'PUT', body:{ outAt: new Date().toISOString() } });
        await this.reload(); this.refreshStatus();
      },

      async remove(i){
        const rec = this.filtered()[i];
        if (!rec) return;
        if (!confirm('Delete?')) return;
        await api(`/api/hr/timeclock/${rec.id}`, { method:'DELETE' });
        await this.reload(); this.refreshStatus();
      },

      filtered(){
        const emp  = this.filter.emp;
        const from = this.filter.from ? new Date(this.filter.from) : null;
        const to   = this.filter.to   ? new Date(this.filter.to)   : null;
        return this.records.filter(r=>{
          const okEmp  = !emp || r.empId===emp;
          const d = new Date(r.date+'T00:00:00');
          const okFrom = !from || d >= from;
          const okTo   = !to   || d <= to;
          return okEmp && okFrom && okTo;
        }).sort((a,b)=> (a.date===b.date ? (a.inAt>b.inAt?1:-1) : (a.date>b.date?1:-1)));
      },

      displayTime(iso){ return fmtLocalDT(iso) || '‚Äî'; },
      displayHoursByAt(inAt,outAt){ return hoursDiff(inAt,outAt).toFixed(2); },
      sumHoursFiltered(){ return this.filtered().reduce((acc,r)=> acc + hoursDiff(r.inAt, r.outAt), 0).toFixed(2); },
      resetForm(){ this.form.note=''; this.form.geo=''; }
    };
  };
})();

  // ===== Sales ¬ª Customer =====
window.customerApp = function customerApp(){
  // --- mapper helpers (scope ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô) ---
  const fromRow = (row = {}) => {
    let payload = {};
    try { payload = row.payload ? JSON.parse(row.payload) : {}; } catch(e){ payload = {}; }
    return {
      id: row.id,
      code: row.code || '',
      firstName: row.firstName || '',
      lastName: row.lastName || '',
      nationalId: row.nationalId || '',
      gender: row.gender || '',
      birthday: row.birthday || '',
      age: row.age || '',
      phone: row.phone || '',
      email: row.email || '',
      addr: {
        no: row.addr_no ?? payload?.addr?.no ?? '',
        road: row.addr_road ?? payload?.addr?.road ?? '',
        soi: row.addr_soi ?? payload?.addr?.soi ?? '',
        provinceId: row.provinceId ?? payload?.addr?.provinceId ?? '',
        provinceName: row.provinceName ?? payload?.addr?.provinceName ?? '',
        amphureId: row.amphureId ?? payload?.addr?.amphureId ?? '',
        amphureName: row.amphureName ?? payload?.addr?.amphureName ?? '',
        tambonId: row.tambonId ?? payload?.addr?.tambonId ?? '',
        tambonName: row.tambonName ?? payload?.addr?.tambonName ?? '',
        postcode: row.postcode ?? payload?.addr?.postcode ?? ''
      },
      medical: payload?.medical || { diseases:[], diseaseOther:'', allergies:[], allergyOther:'' }
    };
  };

  const toPayload = (f) => {
    const base = {
      code: f.code?.trim() || '',
      firstName: f.firstName || '',
      lastName: f.lastName || '',
      nationalId: f.nationalId || '',
      gender: f.gender || '',
      birthday: f.birthday || '',
      age: f.age || '',
      phone: f.phone || '',
      email: f.email || '',
      // ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏ô D1)
      addr_no: f.addr?.no || null,
      addr_road: f.addr?.road || null,
      addr_soi: f.addr?.soi || null,
      provinceId: f.addr?.provinceId || null,
      provinceName: f.addr?.provinceName || null,
      amphureId: f.addr?.amphureId || null,
      amphureName: f.addr?.amphureName || null,
      tambonId: f.addr?.tambonId || null,
      tambonName: f.addr?.tambonName || null,
      postcode: f.addr?.postcode || null,
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÉ‡∏ô payload JSON ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå address ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö
      payload: JSON.stringify({ addr: f.addr || {}, medical: f.medical || {} })
    };
    // ‡∏•‡∏ö key ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô null ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏ö NOT NULL constraints (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    Object.keys(base).forEach(k => (base[k] == null) && delete base[k]);
    return base;
  };

  return {
    // --- state ---
    provinces: [], amphures: [], tambons: [],
    addr: { provinceId:"", amphureId:"", tambonId:"" },

    customers: [],
    editingIndex: null,
    searchQuery:"", showSug:false, searchSuggestions:[],
    filter:{ keyword:"", provinceId:"" },

    form: {
      id:null, code:"", firstName:"", lastName:"", nationalId:"",
      gender:"", birthday:"", age:"", phone:"", email:"",
      addr:{ no:"", road:"", soi:"", provinceId:"", provinceName:"", amphureId:"", amphureName:"", tambonId:"", tambonName:"", postcode:"" },
      medical:{ diseases:[], diseaseOther:"", allergies:[], allergyOther:"" }
    },

    // --- lifecycle ---
    async init(){
    try {
      const pv = await api(`/api/geo/provinces`);
      this.provinces = (pv?.data || pv || []).map(p => ({ id:p.id, name:p.nameTh || p.nameEn || String(p.id) }));
    } catch(e) { this.provinces = []; console.error('load provinces', e); }
  
    if (this.form?.addr?.provinceId) {
      await this.onProvinceChange();
      if (this.form?.addr?.amphureId) await this.onAmphureChange();
    }
    await this.reload();
    this._genCode();
  }

    // --- utils ---
    _genCode(){
      if (this.form.id || this.form.code) return;
      const ymd = new Date().toISOString().slice(2,10).replace(/-/g,'');
      const run = String((this.customers?.length||0) + 1).padStart(6,'0');
      this.form.code = `CU${ymd}-${run}`;
    },
    updateAge(){
      if(!this.form.birthday){ this.form.age=""; return; }
      try{
        const b = new Date(this.form.birthday);
        const diff = (Date.now()-b.getTime())/(1000*60*60*24*365.25);
        this.form.age = String(Math.floor(diff));
      }catch(e){ this.form.age = ""; }
    },
    canSave(){ return !!(this.form.code && this.form.firstName && this.form.lastName); },

    // --- API calls ---
    async reload(){
      try{
        const p = new URLSearchParams();
        if (this.filter.keyword) p.set('search', this.filter.keyword);
        p.set('limit', 100); p.set('offset', 0);
        const res = await api(`/api/sales/customers?${p.toString()}`);
        const list = res?.data || res || [];
        this.customers = list.map(fromRow);
      }catch(err){
        window.toast?.('‡πÇ‡∏´‡∏•‡∏î‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','error'); console.error(err);
      }
    },
    async suggest(q){
      const s = (q ?? this.searchQuery ?? '').trim();
      if(!s){ this.searchSuggestions=[]; this.showSug=false; return; }
      try{
        const p = new URLSearchParams({ search: s, limit: 12, offset: 0 });
        const res = await api(`/api/sales/customers?${p.toString()}`);
        const list = res?.data || res || [];
        this.searchSuggestions = list.map(fromRow);
        this.showSug = true;
      }catch(e){ this.searchSuggestions=[]; this.showSug=false; }
    },

    // --- actions ---
    onSearchInput(){ this.suggest(this.searchQuery); },
    pickSuggestion(c){
      const idx = this.customers.findIndex(x => x.id === c.id);
      if (idx >= 0) this.edit(idx);
      this.showSug = false;
    },
    
    // 2) ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà onProvinceChange()
    onProvinceChange: async function(){
      const pid = Number(this.form?.addr?.provinceId || 0) || 0;
      this.amphures = []; this.tambons = [];
      this.form.addr.amphureId = ""; this.form.addr.tambonId = "";
      if (!pid) return;
      try{
        const ap = await api(`/api/geo/amphures?province_id=${pid}`);
        this.amphures = (ap?.data || ap || []).map(a => ({ id:a.id, name:a.nameTh || a.nameEn || String(a.id) }));
      }catch(e){ this.amphures = []; console.error('load amphures', e); }
    },
    
    // 3) ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà onAmphureChange()
    onAmphureChange: async function(){
      const aid = Number(this.form?.addr?.amphureId || 0) || 0;
      this.tambons = []; this.form.addr.tambonId = "";
      if (!aid) return;
      try{
        const tb = await api(`/api/geo/tambons?amphure_id=${aid}`);
        this.tambons = (tb?.data || tb || []).map(t => ({ id:t.id, name:t.nameTh || t.nameEn || String(t.id), zipcode:t.zipcode||"" }));
      }catch(e){ this.tambons = []; console.error('load tambons', e); }
    },
    
    // 4) ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà applyTambonZip()
    applyTambonZip(){
      const tid = Number(this.form?.addr?.tambonId || 0) || 0;
      if (!tid) return;
      const t = this.tambons.find(x => Number(x.id) === tid);
      if (t?.zipcode) this.form.addr.postcode = t.zipcode;
    },

    resetForm(){
      this.editingIndex = null;
      this.form = {
        id:null, code:"", firstName:"", lastName:"", nationalId:"",
        gender:"", birthday:"", age:"", phone:"", email:"",
        addr:{ no:"", road:"", soi:"", provinceId:"", provinceName:"", amphureId:"", amphureName:"", tambonId:"", tambonName:"", postcode:"" },
        medical:{ diseases:[], diseaseOther:"", allergies:[], allergyOther:"" }
      };
      this._genCode();
    },

    async save(){
      if(!this.canSave()){ window.toast?.('‡∏Å‡∏£‡∏≠‡∏Å Code/‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô','error'); return; }
      try{
        const payload = toPayload(this.form);
        let saved;
        if (this.form.id){
          saved = await api(`/api/sales/customers/${this.form.id}`, { method:'PUT', body: payload });
        }else{
          saved = await api(`/api/sales/customers`, { method:'POST', body: payload });
        }
        window.toast?.('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','info');
        await this.reload();
        const id = (saved?.id) || (saved?.data?.id);
        if (id){
          const i = this.customers.findIndex(r => r.id === id);
          if (i>=0) this.edit(i); else this.resetForm();
        }else{
          this.resetForm();
        }
      }catch(err){
        const msg = (err?.message || '').toLowerCase();
        if (msg.includes('duplicate customer code') || msg.includes('unique')){
          window.toast?.('‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ã‡πâ‡∏≥ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™','error');
        }else{
          window.toast?.('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','error');
        }
        console.error(err);
      }
    },

    edit(i){
      this.editingIndex = i;
      this.form = JSON.parse(JSON.stringify(this.customers[i]));
      if(!this.form.code) this._genCode();
    },

    async remove(i){
      const row = this.customers[i];
      if (!row?.id) { if(confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) { this.customers.splice(i,1); } return; }
      if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
      try{
        await api(`/api/sales/customers/${row.id}`, { method:'DELETE' });
        window.toast?.('‡∏•‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß','info');
        await this.reload();
        this.resetForm();
      }catch(e){
        window.toast?.('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error'); console.error(e);
      }
    },

    filteredCustomers(){
      const kw = (this.filter.keyword||"").toLowerCase();
      return (this.customers||[]).filter(c=>{
        const okProv = !this.filter.provinceId || (c.addr?.provinceId===this.filter.provinceId);
        if(!kw) return okProv;
        const hay = `${c.code} ${c.firstName} ${c.lastName} ${c.nationalId||""}`.toLowerCase();
        return okProv && hay.includes(kw);
      });
    }
  };
};

  // ===== Sales ¬ª Quotation =====
  window.quotationApp = function quotationApp(){
    return {
      quotes: [], editingIndex:null, showSug:false, customerSug:[], customerSearch:"",
      form:{ id:null, qNo:"", qDate:"", customer:{ code:"", firstName:"", lastName:"", nationalId:"", age:"" }, items:[], note:"", confirmed:false },

      async init(){ await this.reload(); this.previewQuotationNo(); },
      async reload(){ this.quotes = await api('/api/sales/quotations'); },
      previewQuotationNo(){
        const d = this.form.qDate ? new Date(this.form.qDate) : new Date();
        const ymd = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,"0")}${String(d.getDate()).padStart(2,"0")}`;
        const run = String((this.quotes||[]).length + 1).padStart(3,"0");
        this.form.qNo = `Q${ymd}-${run}`;
      },
      locked(){ return !!this.form.confirmed; },
      onCustomerSearch(){
        this.showSug = !!this.customerSearch;
        api('/api/sales/customers').then(list=>{
          const kw = (this.customerSearch||"").toLowerCase();
          this.customerSug = list.filter(c => `${c.code} ${c.firstName} ${c.lastName} ${c.nationalId||""}`.toLowerCase().includes(kw)).slice(0,20);
        });
      },
      pickCustomer(c){
        this.form.customer = { code:c.code, firstName:c.firstName, lastName:c.lastName, nationalId:c.nationalId||"", age:c.age||"" };
        this.customerSearch = `${c.code} ‚Äî ${c.firstName} ${c.lastName}`; this.showSug = false;
      },
      canConfirm(){ return this.form.qNo && this.form.customer.code; },
      confirmQuote(){ if(!this.canConfirm()) return; this.form.confirmed = true; alert("Confirmed."); },
      resetForm(){ this.editingIndex=null; this.form={ id:null, qNo:"", qDate:"", customer:{}, items:[], note:"", confirmed:false }; this.previewQuotationNo(); },
      async save(){
        const payload = { ...this.form };
        payload.customer = JSON.stringify(payload.customer||{});
        payload.items = JSON.stringify(payload.items||[]);
        if(this.editingIndex===null){
          await api('/api/sales/quotations', { method:'POST', body: payload });
        }else{
          const row = this.quotes[this.editingIndex];
          await api(`/api/sales/quotations/${row.id}`, { method:'PUT', body: payload });
        }
        await this.reload(); alert("Saved.");
      }
    };
  };
  
// ===== Sales ¬ª Order (API-backed) =====
function saleOrderApp(){
  return {
    // -------- state --------
    editingIndex: null,        // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö API ‡πÅ‡∏ï‡πà‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ UI ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    headerLocked: false,
    showPending: false,
    orders: [],                // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å API
    flt: { keyword:'', from:'', to:'', minNet:null },

    form: {
      soNo: '',                // docNo
      soDate: new Date().toISOString().slice(0,10), // date/docDate
      refQuotationNo: '',
      customer: { code:'', nationalId:'', firstName:'', lastName:'', age:'', phone:'', email:'' },
      symptoms: '',
      items: [],
      payment: { method:'FULL', full:{ paid:false, paidAt:'', receiptNo:'' }, rounds:2, installments:[] },
      doctorNote: ''
    },

    // -------- lifecycle --------
    async init(){
      this.ensureSoNoPreview();
      await this.reload(); // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å /api/sales/orders
    },

    // -------- utils (UI) --------
    dateShort(d){ if(!d) return ''; try{ const x=new Date(d); return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}` }catch{ return d } },
    fmt(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); },

    rowTotal(row){ const q=Number(row.qty||0), p=Number(row.price||0), disc=Number(row.discount||0); return Math.max(0,(q*p)-disc); },
    sumBefore(){ return this.form.items.reduce((s,r)=>s+Number(r.qty||0)*Number(r.price||0),0); },
    sumDiscount(){ return this.form.items.reduce((s,r)=>s+Number(r.discount||0),0); },
    netTotal(){ return this.form.items.reduce((s,r)=>s+this.rowTotal(r),0); },

    buildInstallments(){
      const n = Math.max(2, Math.min(12, Number(this.form.payment.rounds||2)));
      this.form.payment.installments = Array.from({length:n}, (_,i)=>({
        amount: i===0 ? this.netTotal() : 0, paid:false, paidAt:'', receiptNo:''
      }));
    },
    splitEven(){
      const n = Math.max(2, (this.form.payment.installments||[]).length || Number(this.form.payment.rounds||2));
      const total = this.netTotal();
      const each = Math.floor((total/n) * 100) / 100;
      const arr = Array.from({length:n},()=>({amount:each, paid:false, paidAt:'', receiptNo:''}));
      // ‡πÉ‡∏™‡πà‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô (‡πÄ‡∏®‡∏©‡∏™‡∏ï‡∏≤‡∏á‡∏Ñ‡πå) ‡πÑ‡∏õ‡∏á‡∏ß‡∏î‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
      const diff = +(total - each*(n)).toFixed(2);
      if (diff !== 0 && arr.length) arr[arr.length-1].amount = +(arr[arr.length-1].amount + diff).toFixed(2);
      this.form.payment.installments = arr;
    },
    validateInstallments(){ /* ‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏±‡∏î‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ */ },
    sumInstallments(){ return (this.form.payment.installments||[]).reduce((s,i)=>s+Number(i.amount||0),0); },

    addRow(){ this.form.items.push({ service:'', tooth:'', qty:1, price:0, discount:0 }); },
    removeRow(i){ this.form.items.splice(i,1); },

    ensureSoNoPreview(){
      if (!this.form.soDate) this.form.soDate = new Date().toISOString().slice(0,10);
      if (!this.form.soNo) {
        const d = new Date(this.form.soDate);
        const ymd = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
        this.form.soNo = `SO${ymd}-TMP`;
      }
    },

    // -------- mapping UI <-> API --------
    // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á: sales_orders (router ‡πÅ‡∏°‡∏õ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å /api/sales/orders)
    // ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á; field ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô JSON (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‡πÄ‡∏ä‡πà‡∏ô payload)
    _toApiPayload(){
      // ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°: docNo, date/docDate, customerId/customerName, status, total, note/remark, refNo
      const total = this.netTotal();
      const customerName = `${this.form.customer.firstName||''} ${this.form.customer.lastName||''}`.trim();
      return {
        docNo: this.form.soNo || null,
        date: this.form.soDate || null,           // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ä‡πâ docDate ‡πÅ‡∏ó‡∏ô date ‡∏Å‡πá‡∏¢‡∏±‡∏á query ‡πÑ‡∏î‡πâ (router ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
        customerId: this.form.customer.code || null,
        customerName: customerName || null,
        status: (this.form.payment?.full?.paid || (this.form.payment?.installments||[]).some(x=>x.paid)) ? 'Closed' : 'Open',
        total: Number.isFinite(total) ? +total.toFixed(2) : 0,
        note: this.form.symptoms || '',
        refNo: this.form.refQuotationNo || '',
        // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå JSON ‡πÄ‡∏ä‡πà‡∏ô 'payload' ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏ï‡πá‡∏°
        payload: JSON.stringify(this.form)
      };
    },
    _fromApiRow(row){
      // ‡πÅ‡∏õ‡∏•‡∏á row ‡∏à‡∏≤‡∏Å DB ‚Üí ‡πÇ‡∏Ñ‡∏£‡∏á UI ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      const payload = (()=>{ try{ return row.payload ? JSON.parse(row.payload) : null; }catch{ return null; }})();
      const ui = {
        soNo: row.docNo || payload?.soNo || `SO-${row.id}`,
        soDate: row.date || row.docDate || payload?.soDate || '',
        refQuotationNo: row.refNo || payload?.refQuotationNo || '',
        customer: {
          code: row.customerId || payload?.customer?.code || '',
          nationalId: payload?.customer?.nationalId || '',
          firstName: row.customerName ? String(row.customerName).split(' ')[0] : (payload?.customer?.firstName || ''),
          lastName: row.customerName ? String(row.customerName).split(' ').slice(1).join(' ') : (payload?.customer?.lastName || ''),
          age: payload?.customer?.age || '',
          phone: payload?.customer?.phone || '',
          email: payload?.customer?.email || ''
        },
        symptoms: payload?.symptoms || row.note || row.remark || '',
        items: payload?.items || [],
        payment: payload?.payment || { method:'FULL', full:{ paid:false, paidAt:'', receiptNo:'' }, rounds:2, installments:[] },
        doctorNote: payload?.doctorNote || ''
      };
      return { ui, raw: row, net: Number(row.total || this.netTotalFromItems(ui.items)) };
    },
    netTotalFromItems(items){ return (items||[]).reduce((s,r)=> s + Math.max(0,(Number(r.qty||0)*Number(r.price||0))-Number(r.discount||0)), 0); },

    // -------- API calls --------
    async reload(){
      const p = new URLSearchParams();
      if (this.flt.keyword) p.set('search', this.flt.keyword);
      if (this.flt.from)    p.set('from', this.flt.from);
      if (this.flt.to)      p.set('to', this.flt.to);
      p.set('limit', 50); p.set('offset', 0);

      const res = await api(`/api/sales/orders?${p.toString()}`);
      const list = res.data || res || [];
      this.orders = list.map(r => {
        const m = this._fromApiRow(r);
        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏ô Records ‡πÉ‡∏ä‡πâ
        return {
          soNo: m.ui.soNo,
          soDate: m.ui.soDate,
          customer: m.ui.customer,
          net: Number(r.total ?? m.net) || 0,
          payment: m.ui.payment,
          refQuotationNo: m.ui.refQuotationNo,
          _row: r
        };
      });
    },

    canSave(){
      // ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà + ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ + ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ >= 1
      return !!(this.form.soDate && (this.form.customer.code || this.form.customer.firstName || this.form.customer.lastName) && this.form.items.length > 0);
    },

    async save(){
      if (!this.canSave()) { window.toast?.('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','error'); return; }

      const payload = this._toApiPayload();

      // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô TMP
      if (!payload.docNo || /-TMP$/.test(payload.docNo)) {
        const d = new Date(this.form.soDate);
        const ymd = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
        payload.docNo = `SO${ymd}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;
        this.form.soNo = payload.docNo;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏Ñ‡πâ‡∏ô‡∏à‡∏≤‡∏Å docNo ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤)
      const existed = this.orders.find(o => o.soNo === this.form.soNo);

      if (!existed) {
        const out = await api('/api/sales/orders', { method:'POST', body: payload });
        window.toast?.('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å SO ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
        this.headerLocked = false;
        await this.reload();
        this.editByNo(out?.data?.docNo || payload.docNo); // ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
      } else {
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏¥‡∏°
        const id = existed?._row?.id;
        if (!id) { window.toast?.('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏≠‡∏î‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°','error'); return; }
        await api(`/api/sales/orders/${id}`, { method:'PUT', body: payload });
        window.toast?.('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï SO ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','success');
        await this.reload();
        this.editByNo(payload.docNo);
      }
    },

    async deleteByNo(soNo){
      const row = this.orders.find(o => o.soNo === soNo);
      if (!row) return;
      if (!confirm('Delete?')) return;
      await api(`/api/sales/orders/${row._row.id}`, { method:'DELETE' });
      window.toast?.('‡∏•‡∏ö SO ‡πÅ‡∏•‡πâ‡∏ß','success');
      await this.reload();
      if (this.form.soNo === soNo) this.resetForm();
    },

    async editByNo(soNo){
      const row = this.orders.find(o => o.soNo === soNo);
      if (!row) { window.toast?.('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£', 'error'); return; }
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≤‡∏Å _row
      const m = this._fromApiRow(row._row);
      Object.assign(this.form, m.ui);
      this.headerLocked = false;
      window.toast?.('‡πÇ‡∏´‡∏•‡∏î SO ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß','info');
    },

    // -------- Pending ‡∏à‡∏≤‡∏Å Quotation (‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ storage ‡πÄ‡∏î‡∏¥‡∏°) --------
    pendingQuotations(){
      const quotes = _storage.get('quotes', []) || [];
      // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥: confirmed ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô SO (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏î‡πâ‡∏ß‡∏¢ qNo)
      const usedQ = new Set(this.orders.map(o => (o._row?.refNo || '')));
      return quotes
        .filter(q => q.confirmed)
        .filter(q => !usedQ.has(q.qNo))
        .map(q => ({ ...q, net: (q.items||[]).reduce((s,r)=> s + Math.max(0,(Number(r.qty||0)*Number(r.price||0))-Number(r.discount||0)), 0) }));
    },
    createFromQuotation(qNo){
      const q = (_storage.get('quotes', []) || []).find(x => x.qNo === qNo);
      if (!q) { window.toast?.('‡πÑ‡∏°‡πà‡∏û‡∏ö Quotation', 'error'); return; }
      // lock header ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ)
      this.headerLocked = true;
      this.form.refQuotationNo = q.qNo;
      this.form.customer = {
        code: q.customer?.code || '',
        nationalId: q.customer?.nationalId || '',
        firstName: q.customer?.firstName || '',
        lastName: q.customer?.lastName || '',
        age: q.customer?.age || '',
        phone: this.form.customer.phone,  // q ‡πÑ‡∏°‡πà‡∏°‡∏µ phone/email ‡πÉ‡∏ô‡∏™‡∏ï‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏°
        email: this.form.customer.email
      };
      this.form.items = (q.items||[]).map(x => ({
        service: x.service || '',
        tooth: x.tooth || '',
        qty: Number(x.qty||1),
        price: Number(x.price||0),
        discount: Number(x.discount||0)
      }));
      this.showPending = false;
      this.ensureSoNoPreview();
      window.toast?.('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Quotation ‡πÅ‡∏•‡πâ‡∏ß','success');
    },
    openPending(){ this.showPending = true; },

    // -------- Payment actions (‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) --------
    async receivePayment(mode, idx=null){
      if (mode==='FULL') {
        this.form.payment.full.paid = true;
        this.form.payment.full.paidAt = new Date().toISOString();
        this.form.payment.full.receiptNo = `RC${Date.now().toString().slice(-6)}`;
      } else {
        const ins = this.form.payment.installments[idx];
        if (!ins) return;
        ins.paid = true; ins.paidAt = new Date().toISOString(); ins.receiptNo = `RC${Date.now().toString().slice(-6)}`;
      }
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ã‡∏ü‡∏Å‡∏•‡∏±‡∏ö API
      await this.save();
    },
    printReceipt(mode, idx=null){
      window.toast?.('‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (TODO: ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡∏à‡∏£‡∏¥‡∏á)','info');
    },

    // -------- Misc --------
    resetForm(){
      this.editingIndex = null;
      this.headerLocked = false;
      this.form = {
        soNo: '', soDate: new Date().toISOString().slice(0,10),
        refQuotationNo: '',
        customer:{ code:'', nationalId:'', firstName:'', lastName:'', age:'', phone:'', email:'' },
        symptoms:'', items:[],
        payment:{ method:'FULL', full:{ paid:false, paidAt:'', receiptNo:'' }, rounds:2, installments:[] },
        doctorNote:''
      };
      this.ensureSoNoPreview();
    },
    filteredSO(){
      const kw = (this.flt.keyword||'').toLowerCase();
      const from = this.flt.from, to = this.flt.to, minNet = Number(this.flt.minNet||0);
      return this.orders.filter(r=>{
        const okKw = !kw || [r.soNo, r.customer?.firstName, r.customer?.lastName, r.customer?.nationalId].filter(Boolean).join(' ').toLowerCase().includes(kw);
        const okFrom = !from || (r.soDate >= from);
        const okTo   = !to   || (r.soDate <= to);
        const okNet  = !minNet || (Number(r.net||0) >= minNet);
        return okKw && okFrom && okTo && okNet;
      });
    }
  };
}
})();
</script>
